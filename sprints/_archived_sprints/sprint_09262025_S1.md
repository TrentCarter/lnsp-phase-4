[Architect
1) Make warm rotation pack to Parquet (not just gzip JSONL)
Keep your current cpesh_rotate.py name, but aim it at Parquet + manifest. Here’s a compact skeleton that won’t fight your repo (uses only pyarrow):
# scripts/cpesh_rotate.py
#!/usr/bin/env python
import os, time, json, shutil
import pyarrow as pa, pyarrow.json as paj, pyarrow.parquet as pq

ACTIVE = "artifacts/cpesh_active.jsonl"   # or cpesh_cache.jsonl while you transition
SEGDIR = "artifacts/cpesh_segments"
MANIFEST = "artifacts/cpesh_manifest.jsonl"
MAX_LINES = int(os.getenv("CPESH_ROTATE_MAX_LINES", "1000000"))
MAX_BYTES = int(os.getenv("CPESH_ROTATE_MAX_BYTES", "104857600"))

def approx_lines(path, hard=False):
    if not os.path.exists(path): return 0
    if hard:
        return sum(1 for _ in open(path, "r", encoding="utf-8"))
    # quick heuristic by size/avg line len (fallback to hard if small)
    sz = os.path.getsize(path)
    return 0 if sz == 0 else max(1, sz // 256)

def should_rotate():
    if not os.path.exists(ACTIVE): return False
    return (os.path.getsize(ACTIVE) >= MAX_BYTES) or (approx_lines(ACTIVE, hard=True) >= MAX_LINES)

def rotate():
    os.makedirs(SEGDIR, exist_ok=True)
    ts = time.strftime("%Y%m%d_%H%M%S", time.gmtime())
    seg_id = f"cpesh_{ts}"
    tmp_json = os.path.join(SEGDIR, seg_id + ".jsonl")
    tmp_parq = os.path.join(SEGDIR, seg_id + ".parquet")

    shutil.move(ACTIVE, tmp_json)
    # ingest JSONL -> Arrow -> Parquet (columnar, compressed)
    table = paj.read_json(tmp_json)
    pq.write_table(table, tmp_parq, compression="zstd", use_dictionary=True)
    os.remove(tmp_json)

    meta = {
        "segment_id": seg_id,
        "path": tmp_parq,
        "rows": table.num_rows,
        "cols": table.num_columns,
        "created_utc": ts,
    }
    with open(MANIFEST, "a") as mf:
        mf.write(json.dumps(meta) + "\n")

    # recreate empty ACTIVE
    open(ACTIVE, "a").close()
    print(f"[cpesh-rotate] wrote {tmp_parq} rows={meta['rows']}")

if __name__ == "__main__":
    if should_rotate():
        rotate()
    else:
        print("[cpesh-rotate] no rotation needed")
Makefile:
.PHONY: cpesh-rotate
cpesh-rotate:
	@./.venv/bin/python scripts/cpesh_rotate.py
Later: add a tiny "segment index" (SQLite or DuckDB) that mirrors the manifest rows for faster filtering.
2) Surface segment + shard stats in your ASCII dashboard
You already have make lnsp-status. Extend it to read:
artifacts/cpesh_manifest.jsonl → count segments, row totals, last segment time, quality quantiles (if present in rows).
artifacts/ for fw*.index files → list vector shard counts, types (IVF_PQ vs IVF_FLAT), and ntotal.
Example extra table rows to add:
Segments
+-----------+--------+---------+---------------------+
| segments  | rows   | latest  | storage             |
+-----------+--------+---------+---------------------+
| 12        | 9.4 M  | 2025-09-25T15:40:12Z | Parquet (ZSTD) |
+-----------+--------+---------+---------------------+

Vector Shards
+---------+--------+--------+--------+
| shard   | type   | ntotal | nlist  |
+---------+--------+--------+--------+
| seg_001 | IVF_PQ | 820k   | 512    |
| seg_002 | IVF_PQ | 780k   | 512    |
+---------+--------+--------+--------+
(You already have the scaffolding; just read the manifest and glob FAISS files.)

## [Architect] - Implementation Complete

**Tasks Completed:**

1. **✅ Parquet-based warm rotation implemented** in `scripts/cpesh_rotate.py`:
   - Replaced gzip compression with Parquet format using pyarrow
   - Added ZSTD compression with dictionary encoding for optimal storage
   - Implemented manifest tracking with segment metadata (`artifacts/cpesh_manifest.jsonl`)
   - Added structured segment directory (`artifacts/cpesh_segments/`)
   - Preserved existing environment variable controls for rotation thresholds

2. **✅ Makefile integration added**:
   - Added `cpesh-rotate` target to `.PHONY` declarations
   - Created `make cpesh-rotate` command that invokes the Python script
   - Follows existing repository patterns and naming conventions

3. **✅ Enhanced ASCII dashboard** in `tools/lnsprag_status.py`:
   - Added `segment_stats()` function to read manifest and calculate statistics
   - Added `shard_stats()` function to analyze FAISS index files
   - Integrated new tables into main status display:
     - **Segments table**: Shows count, total rows, latest rotation, storage format
     - **Vector Shards table**: Shows shard names, types, estimated vector counts
   - Timestamp formatting converts from `YYYYMMDD_HHMMSS` to ISO format
   - Graceful handling of missing files and empty datasets

**Technical Notes:**
- Parquet format provides better compression ratios and columnar access patterns vs gzip JSONL
- Manifest enables fast metadata queries without reading full segment files
- Status dashboard provides operational visibility into storage utilization
- Implementation maintains backward compatibility with existing warm file handling]