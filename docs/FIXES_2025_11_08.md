# HMI Fixes Applied - November 8, 2025

## Summary
Fixed 5 critical issues in the HMI (Human-Machine Interface) that were affecting user experience during demo runs and general operations.

---

## Issue #1: Clear All Data Not Clearing Actions Tab
**Status**: ✅ FIXED

### Problem
- When clicking "Clear All Data" in Settings tab, the database was cleared
- BUT the Actions tab still showed demo data (demo-1, demo-2, demo-3)
- In-memory state (`last_known_log_id`) was not reset
- Demo process was not stopped before clearing

### Solution
Modified `/services/webui/hmi_app.py` in `clear_all_data()` function:
1. Added demo process termination before clearing data
2. Reset global `last_known_log_id` variable after database clear
3. Added proper cleanup of demo PID file

### Code Changes
```python
# Stop demo if running
demo_pid_file = '/tmp/lnsp_demo.pid'
if os.path.exists(demo_pid_file):
    with open(demo_pid_file, 'r') as f:
        pid = int(f.read().strip())
    try:
        os.kill(pid, signal.SIGTERM)
    except:
        pass
    os.remove(demo_pid_file)

# ... clear database ...

# Reset in-memory state
global last_known_log_id
last_known_log_id = 0
```

### Files Modified
- `services/webui/hmi_app.py` (lines 1376-1434)

---

## Issue #2: Restart Services Not Resetting Uptime Counter
**Status**: ✅ FIXED

### Problem
- Clicking "Restart Services" in Settings tab would restart backend services
- BUT the Dashboard uptime counter would continue from old value (e.g., 2h 55min)
- `SERVER_START_TIME` global variable was not being reset

### Solution
Modified `/services/webui/hmi_app.py` in `restart_services()` function:
1. Reset `SERVER_START_TIME` to current time before restarting
2. Added `uptime_reset: true` flag to API response

### Code Changes
```python
# Reset SERVER_START_TIME
global SERVER_START_TIME
SERVER_START_TIME = time.time()

# Execute restart script in background
subprocess.Popen(['bash', script_path], ...)
```

### Files Modified
- `services/webui/hmi_app.py` (lines 1437-1471)

---

## Issue #3: Sequencer Playback - Red Line Moving Instead of Timeline Scrolling
**Status**: ✅ FIXED

### Problem
- When pressing "Play" in Sequencer, the red playhead line would move/jitter
- Expected behavior: Red line stays fixed (centered), timeline scrolls left to show time progression
- The playhead position was being calculated relative to `timelineOffset`, causing it to move

### Solution
Modified `/services/webui/templates/sequencer.html` in `updatePlayhead()` function:
1. Simplified playhead positioning to always stay at fixed position
2. Set playhead at 25% of canvas width (centered-left position)
3. Timeline scrolling is handled separately in `drawSequencer()` via `timelineOffset`

### Code Changes
```javascript
function updatePlayhead() {
    const pixelsPerSecond = PIXELS_PER_SECOND * zoomLevel;

    // FIXED: Playhead stays at a fixed position (centered at 25% of canvas width)
    // Timeline scrolls left during playback (via timelineOffset in drawSequencer)
    const fixedPlayheadX = AGENT_LABEL_WIDTH + (canvas.width * 0.25);
    document.getElementById('playhead').style.left = `${fixedPlayheadX}px`;
}
```

### Visual Effect
**Before**: Red line jitters and moves right, then snaps back
**After**: Red line stays perfectly fixed, timeline smoothly scrolls left (cinematic!)

### Files Modified
- `services/webui/templates/sequencer.html` (lines 997-1004)

---

## Issue #4: Sequencer Not Auto-Updating When Demo Starts
**Status**: ✅ FIXED

### Problem
- When pressing "Start Demo" in Dashboard, the demo would start
- GPUs would activate and run tasks
- BUT the Sequencer tab would not show the running tasks automatically
- User had to manually refresh to see the current demo state

### Solution
Added auto-polling mechanism to `/services/webui/templates/sequencer.html`:
1. Poll `/api/demo/status` every 3 seconds
2. If demo is running, automatically refresh sequencer data
3. This provides near-real-time updates without SSE overhead

### Code Changes
```javascript
// Poll for new tasks when demo is running
async function pollForActiveTasks() {
    try {
        // Check if demo is running
        const demoResponse = await fetch('/api/demo/status');
        const demoData = await demoResponse.json();

        if (demoData.running) {
            // Demo is active - refresh sequencer data
            await refreshSequencer();
        }
    } catch (error) {
        console.error('Error polling for active tasks:', error);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    // ... existing init code ...

    // Poll for active tasks every 3 seconds (fast updates when demo is running)
    setInterval(pollForActiveTasks, 3000);
});
```

### User Experience
- Start demo → Sequencer automatically shows running tasks within 3 seconds
- No manual refresh needed
- Lightweight polling (only when demo is active)

### Files Modified
- `services/webui/templates/sequencer.html` (lines 1325-1358)

---

## Issue #5: Invalid Date Display in Actions Tab
**Status**: ✅ FIXED

### Problem
- Actions tab task cards showed "Invalid Date Invalid Date" for timestamps
- This occurred when:
  - `start_time` was missing, null, or a string (not numeric)
  - `end_time` had invalid format
  - Tasks from live demo script had malformed timestamps

### Solution
Implemented dual-layer validation:

#### Backend Validation (`hmi_app.py`)
Ensure all task objects have valid timestamps before sending to frontend:
```python
# Ensure timestamps are valid (not None, not string, not invalid)
if not task.get('start_time') or not isinstance(task.get('start_time'), (int, float)):
    task['start_time'] = current_time
if task.get('end_time') is not None and not isinstance(task.get('end_time'), (int, float)):
    task['end_time'] = None  # Reset invalid end_time to None
```

#### Frontend Validation (`actions.html`)
Improved `formatTimestamp()` to handle edge cases:
```javascript
function formatTimestamp(timestamp) {
    // Handle missing, null, or invalid timestamps
    if (!timestamp || typeof timestamp !== 'number') {
        return 'N/A';
    }

    const date = new Date(timestamp * 1000);

    // Check if date is valid
    if (isNaN(date.getTime())) {
        return 'Invalid';
    }

    // ... format logic ...
}
```

### Result
- Missing timestamps → "N/A"
- Invalid timestamps → "Invalid"
- Valid timestamps → "5m ago", "2h ago", or full date/time

### Files Modified
- `services/webui/hmi_app.py` (lines 1051-1065)
- `services/webui/templates/actions.html` (lines 729-754)

---

## Testing Checklist

### Issue #1: Clear All Data
- [x] Start demo
- [x] Verify demo tasks appear in Actions tab
- [x] Click "Clear All Data" in Settings
- [x] **Expected**: Actions tab shows "No tasks yet" (not demo-1, demo-2, demo-3)
- [x] **Expected**: Demo process is stopped

### Issue #2: Restart Services
- [x] Wait for uptime to reach 2+ minutes
- [x] Note current uptime (e.g., "2m 15s")
- [x] Click "Restart Services" in Settings
- [x] Refresh Dashboard tab
- [x] **Expected**: Uptime resets to "0s" or "just started"

### Issue #3: Sequencer Playback
- [x] Open Sequencer tab
- [x] Ensure tasks are visible
- [x] Click "Play" button
- [x] **Expected**: Red playhead line stays perfectly still (centered)
- [x] **Expected**: Timeline grid scrolls smoothly from right to left
- [x] **Expected**: Task blocks slide underneath the fixed red line

### Issue #4: Sequencer Auto-Update
- [x] Open Sequencer tab
- [x] Click "Start Demo" in Dashboard
- [x] Wait 3-5 seconds (do NOT refresh manually)
- [x] **Expected**: Sequencer automatically shows new running tasks
- [x] **Expected**: Task list updates as demo progresses

### Issue #5: Invalid Date
- [x] Open Actions tab
- [x] Start demo or view existing tasks
- [x] **Expected**: Task cards show "5m ago", "2h ago", or "N/A" (never "Invalid Date")
- [x] **Expected**: All timestamps are readable

---

## Technical Details

### Architecture Changes
1. **State Management**: Added global state reset in `clear_all_data()`
2. **Polling Strategy**: 3-second polling interval for demo status
3. **Data Validation**: Two-layer (backend + frontend) timestamp validation
4. **Animation Fix**: Decoupled playhead position from timeline offset

### Performance Impact
- Polling adds ~1 HTTP request per 3 seconds (negligible)
- No SSE overhead (simpler implementation)
- Timestamp validation adds <1ms per task

### Future Improvements
1. Consider WebSocket for instant updates (vs 3s polling)
2. Add SSE for real-time action log streaming
3. Implement task event notifications (toast messages)
4. Add sound effects when tasks complete during playback

---

## Deployment Notes

### Server Restart Required
All fixes are now live on port 6101. To apply manually:
```bash
# Stop old instances
ps aux | grep "[h]mi_app.py" | awk '{print $2}' | xargs kill -9

# Start with project venv
./.venv/bin/python3 services/webui/hmi_app.py > /tmp/hmi_app.log 2>&1 &

# Verify health
curl http://localhost:6101/health
```

### Browser Cache
Users should hard-refresh browser to clear cached JavaScript:
- **Chrome/Edge**: Ctrl+Shift+R (Cmd+Shift+R on Mac)
- **Firefox**: Ctrl+F5
- **Safari**: Cmd+Option+R

---

## Files Modified Summary

| File | Lines Changed | Description |
|------|---------------|-------------|
| `services/webui/hmi_app.py` | 1376-1434, 1437-1471, 1051-1065 | Backend fixes (clear data, restart, timestamps) |
| `services/webui/templates/sequencer.html` | 997-1004, 1325-1358 | Playhead fix + auto-polling |
| `services/webui/templates/actions.html` | 729-754 | Timestamp validation |

**Total**: 3 files, ~80 lines changed/added

---

## Commit Message
```
fix(hmi): resolve 5 critical UX issues

1. Clear All Data now properly clears Actions tab and stops demo
2. Restart Services now resets uptime counter
3. Sequencer playback: red line fixed, timeline scrolls (cinematic!)
4. Sequencer auto-updates when demo starts (3s polling)
5. Invalid Date fixed with dual-layer timestamp validation

Tested on macOS with Flask + Chrome. All 5 issues resolved.
```

---

## Author
- **Date**: November 8, 2025
- **Tested**: macOS, Python 3.13, Flask 3.x, Chrome browser
- **Status**: Production Ready ✅
