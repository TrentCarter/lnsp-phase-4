# S7 Wrap — 2025-09-25 (FactoidWiki → LNSP)

## What's working (live)
- **Dynamic nlist** with auto-downshift and telemetry (`artifacts/index_meta.json`).
- **CPESH two-stage gating** (quality/cos gates + lane overrides) active in `/search`.
- **Decision logging** → `artifacts/gating_decisions.jsonl` (non-empty).
- **Metrics endpoint** → `/metrics/gating` (used_cpesh / total).
- **Offline embedder** (local model; no network), Makefile targets (`api`, `gating-snapshot`, `smoketest`).

## 10k retrieval status
- Index type: IVF_FLAT, metric: IP (cosine).
- Effective `nlist`: auto-calculated via 40× rule.
- Recommended `nprobe`: 16 (CPESH path uses 8).
- Hit@1 uplift with CPESH (S5): +4.2% (slice: CPESH-assisted vs fallback).

## CPESH datastore (PERMANENT)
- Active tier: JSONL append (training + inference).
- Warm/Cold tiers: planned (GZ + Parquet) with SQLite/DuckDB index seam.
- **Never delete CPESH**; organize by tier, not TTL.

## Pipeline map (P1–P17)
**Solid:** P1–P4 (ingest/chunk/label/mission), P6–P8 (TMD encode + fuse), P11 (FAISS index), P16 (lane-aware search path), API + metrics.
**Operational but evolving:** P5 (teacher LLM orchestration & guards), P9 (graph triples), P13 (echo loop scoring gates), P14 (batching), P12 (graph DB adapters).
**R&D tracks:** P15 (LNSP training loops, vec2text decoder), P17 (MoE inference wiring).

## Today's artifacts
- `artifacts/index_meta.json` — nlist, max_safe_nlist, requested_nlist, count.
- `artifacts/gating_decisions.jsonl` — decision trace (ts, lane, used_cpesh, chosen_nprobe, latency_ms).
- `artifacts/metrics_gating.json` — snapshot via `make gating-snapshot`.
- `artifacts/runtime.lock` — environment versions (append-only).
- `eval/day_s5_report.md` — cold/warm sweep, CPESH usage, final nprobe & thresholds.

## Open risks / watch-items
- **Scale stepping:** at ≥20k vectors, allow `nlist` to rise (auto policy already in place).
- **Tiering:** implement warm (GZ) + cold (Parquet) rotation in S8–S9; add ID→tier index.
- **Prompt drift:** keep v2.0 frozen; record deltas when adjusting CPESH extraction.

## Next-day (S8) short targets
- Implement **active→warm rotation** (JSONL→GZ) with manifest + SQLite index.
- Add **/metrics/slo** auto-fill from the eval harness (persist last run).
- Optional: **IVF_PQ tryout** (M=8, nbits=8) vs IVF_FLAT at ≥25k vectors.