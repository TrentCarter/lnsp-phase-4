<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LVM Model Evaluation Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .model-card {
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .model-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .model-card.selected {
            border-left: 5px solid #0d6efd;
            background-color: #f0f7ff;
        }
        .metric-card {
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .progress {
            height: 10px;
            margin-top: 5px;
        }
        .concept-preview {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        #evaluationResults {
            display: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #0d6efd;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">LVM Model Evaluation Dashboard</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                                <i class="bi bi-gear"></i> Settings
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <div class="row">
            <!-- Left Panel: Model Selection -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Model Selection</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Test Mode</label>
                            <select id="testMode" class="form-select">
                                <option value="both">Both IN and OOD</option>
                                <option value="in_distribution">IN Distribution Only</option>
                                <option value="out_of_distribution">OOD Only</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Evaluation Metrics</label>
                            <div class="form-check">
                                <input class="form-check-input metric-checkbox" type="checkbox" value="next_concept_prediction" id="metricNCP" checked>
                                <label class="form-check-label" for="metricNCP">
                                    Next Concept Prediction
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input metric-checkbox" type="checkbox" value="cosine_alignment" id="metricCA" checked>
                                <label class="form-check-label" for="metricCA">
                                    Cosine Alignment
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input metric-checkbox" type="checkbox" value="rouge_scores" id="metricRouge" checked>
                                <label class="form-check-label" for="metricRouge">
                                    ROUGE Scores
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input metric-checkbox" type="checkbox" value="latency" id="metricLatency">
                                <label class="form-check-label" for="metricLatency">
                                    Latency
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input metric-checkbox" type="checkbox" value="memory_usage" id="metricMemory">
                                <label class="form-check-label" for="metricMemory">
                                    Memory Usage
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="numConcepts" class="form-label">Number of Input Chunks (1-20)</label>
                            <input type="number" class="form-control" id="numConcepts" value="5" min="1" max="20">
                            <div class="form-text">Number of sequential chunks/sentences to use as input (model predicts chunk N+1)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="numTestCases" class="form-label">Number of Test Cases per Model</label>
                            <input type="number" id="numTestCases" class="form-control" min="1" max="100" value="10">
                            <div class="form-text">How many test sequences to evaluate (each uses N chunks to predict chunk N+1)</div>
                        </div>
                        <div class="mb-3">
                            <label for="vec2textSteps" class="form-label">Vec2Text Decoding Steps</label>
                            <input type="number" id="vec2textSteps" class="form-control" min="1" max="20" value="3">
                            <div class="form-text">Higher steps can improve decoded text quality at the cost of latency.</div>
                        </div>
                        <div class="mb-3">
                            <label for="startArticleIndex" class="form-label">Starting Article (index)</label>
                            <input type="number" id="startArticleIndex" class="form-control" min="0" value="0">
                            <div class="form-text">Start from this article index in the Wikipedia JSONL (0-based).</div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="randomStart">
                            <label class="form-check-label" for="randomStart">Randomize starting article (shuffle window)</label>
                        </div>
                        
                        <div id="evaluationProgress" class="mb-3" style="display: none;">
                            <div class="d-flex justify-content-between mb-1">
                                <small id="progressHeading">Evaluating models...</small>
                                <small><span id="progressText">0%</span></small>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="statusText" class="small text-muted mt-2">Initializing evaluation...</div>
                        </div>
                        <button id="evaluateBtn" class="btn btn-primary w-100">
                            <span id="evaluateBtnText">Evaluate Selected Models</span>
                            <span id="evaluateBtnSpinner" class="loading" style="display: none;"></span>
                        </button>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <input type="text" id="modelSearch" class="form-control" placeholder="Search models...">
                        </div>
                        
                        <div class="mb-3 d-flex gap-2 align-items-center">
                            <label class="form-label mb-0" style="white-space: nowrap;">Show:</label>
                            <select id="modelLimit" class="form-select form-select-sm">
                                <option value="50">50 models</option>
                                <option value="100">100 models</option>
                                <option value="200" selected>200 models</option>
                                <option value="500">500 models</option>
                                <option value="all">All models</option>
                            </select>
                            <button id="refreshModels" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        
                        <div class="alert alert-info small py-2 mb-2">
                            <i class="bi bi-info-circle"></i> Showing <strong id="modelCount">{{ models|length }}</strong> models (newest first)
                        </div>
                        
                        <div class="model-list" style="max-height: 500px; overflow-y: auto;">
                            {% for model in models %}
                            <div class="card model-card mb-2" data-model-path="{{ model.path }}">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="form-check flex-grow-1">
                                            <input class="form-check-input model-checkbox" type="checkbox" value="{{ model.path }}" id="model-{{ loop.index }}">
                                            <label class="form-check-label" for="model-{{ loop.index }}">
                                                <strong>{{ model.name }}</strong>
                                                <div class="text-muted small">
                                                    {% if model.relative_path %}
                                                    <div>{{ '/' + model.relative_path }}</div>
                                                    {% endif %}
                                                    <div>
                                                        <i class="bi bi-clock"></i> {{ model.modified_str or (model.modified|datetime) }}
                                                        {% if model.size_mb %} Â· {{ '%.1f' % model.size_mb }} MB{% endif %}
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="text-end ms-2">
                                            <span class="badge bg-primary rounded-pill">{{ "%.1f"|format(model.get('size_mb', 0)) }} MB</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Results -->
            <div class="col-md-8">
                <div id="evaluationResults">
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Evaluation Results</h5>
                        </div>
                        <div class="card-body">
                            <div id="resultsContainer">
                                <!-- Results will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9">
                    <!-- Summary & Tools -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Summary (Composite Ranked)</h5>
                                <div class="d-flex align-items-center gap-2">
                                    <input id="exportTopKCount" type="number" class="form-control form-control-sm" style="width: 80px;" min="1" value="5">
                                    <button id="exportTopKCsv" class="btn btn-sm btn-outline-primary">Export Top-K CSV</button>
                                    <button id="exportTopKJson" class="btn btn-sm btn-outline-secondary">Export Top-K JSON</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped" id="summaryTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Model</th>
                                            <th>Composite</th>
                                            <th>Cosine</th>
                                            <th>ROUGE-L</th>
                                            <th>BERT F1</th>
                                            <th>Latency</th>
                                        </tr>
                                    </thead>
                                    <tbody id="summaryTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- A/B Compare Controls -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-end gap-2">
                                <div class="flex-grow-1">
                                    <label class="form-label">Model A</label>
                                    <select id="abModelA" class="form-select form-select-sm"></select>
                                </div>
                                <div class="flex-grow-1">
                                    <label class="form-label">Model B</label>
                                    <select id="abModelB" class="form-select form-select-sm"></select>
                                </div>
                                <div>
                                    <button id="abCompareBtn" class="btn btn-sm btn-primary">Compare</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sweep Heatmap Controls -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label for="stepsList" class="form-label">Vec2Text Steps (comma-separated)</label>
                                    <input id="stepsList" class="form-control form-control-sm" value="3,5,7">
                                </div>
                                <div class="col-md-4">
                                    <label for="conceptsList" class="form-label">Num Concepts (comma-separated)</label>
                                    <input id="conceptsList" class="form-control form-control-sm" value="3,5,7">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label d-block">&nbsp;</label>
                                    <button class="btn btn-sm btn-outline-primary" onclick="window.triggerSweep && window.triggerSweep()">Run Sweep</button>
                                </div>
                            </div>
                            <div id="sweepHeatmap" class="mt-3"></div>
                        </div>
                    </div>

                    <div id="evaluationResults" style="display: none;">
                        <div class="no-results" id="noResults">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-graph-up"></i>
                                <h4 class="mt-3">No Evaluation Results Yet</h4>
                                <p>Select models and click "Evaluate Selected Models" to begin.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- A/B Compare Modal -->
    <div class="modal fade" id="abCompareModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">A/B Comparison</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="abCompareBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Advanced Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h5>System Information</h5>
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Log File Location:</strong></p>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="logFilePath" readonly>
                                            <button class="btn btn-outline-secondary" type="button" id="copyLogPath">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Models Directory:</strong></p>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="modelsDirPath" readonly>
                                            <button class="btn btn-outline-secondary" type="button" id="copyModelsPath">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Advanced Settings</h5>
                        <div class="card">
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableDebugMode">
                                    <label class="form-check-label" for="enableDebugMode">Enable Debug Mode</label>
                                </div>
                                <div class="mb-3">
                                    <label for="logLevel" class="form-label">Log Level</label>
                                    <select class="form-select" id="logLevel">
                                        <option value="DEBUG">DEBUG</option>
                                        <option value="INFO" selected>INFO</option>
                                        <option value="WARNING">WARNING</option>
                                        <option value="ERROR">ERROR</option>
                                        <option value="CRITICAL">CRITICAL</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="maxLogFiles" class="form-label">Max Log Files to Keep</label>
                                    <input type="number" class="form-control" id="maxLogFiles" value="10" min="1" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="resetAllBtn">Reset All</button>
                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{{ url_for('static', filename='js/progress.js') }}?v=2"></script>
    <script src="{{ url_for('static', filename='js/display.js') }}?v=2"></script>
    
    <script>
        // Global constants
        const STORAGE_KEYS = {
            SETTINGS: 'appSettings',
            SELECTED_MODELS: 'selectedModels',
            TEST_MODE: 'testMode',
            SELECT_ALL: 'selectAllModels',
            METRICS: 'evaluationMetrics',
            NUM_TEST_CASES: 'numTestCases',
            NUM_CONCEPTS: 'numConcepts',
            VEC2TEXT_STEPS: 'vec2textSteps',
            START_ARTICLE: 'startArticleIndex',
            RANDOM_START: 'randomStart'
        };

        // Global variables
        

        // Initialize when document is ready
        $(document).ready(function() {
            // evaluationProgress is already initialized in progress.js

            // Load settings from session first
            loadSettingsFromSession();

            // Then load saved state from localStorage
            loadSavedState();

            // Set up event listeners
            setupEventListeners();

            // Initialize UI components
            initializeUI();
        });

        // Load settings from Flask session
        function loadSettingsFromSession() {
            const settings = JSON.parse('{{ settings|tojson|safe }}');
            
            // Set test mode
            if (settings.test_mode) {
                $('#testMode').val(settings.test_mode);
            }

            // Set metrics
            if (settings.evaluation_metrics) {
                for (const [metric, enabled] of Object.entries(settings.evaluation_metrics)) {
                    $('#metric' + metric.charAt(0).toUpperCase() + metric.slice(1)).prop('checked', enabled);
                }
            }

            // Set number of concepts
            if (settings.num_concepts) {
                $('#numConcepts').val(settings.num_concepts);
            }

            // Check previously selected models
            if (settings.selected_models) {
                $('.model-checkbox').each(function() {
                    const isSelected = settings.selected_models.includes($(this).val());
                    $(this).prop('checked', isSelected);
                    if (isSelected) {
                        $(this).closest('.model-card').addClass('selected');
                    }
                });
            }
        }

        // Load saved state from localStorage
        function loadSavedState() {
            try {
                // Load test mode
                const savedTestMode = localStorage.getItem(STORAGE_KEYS.TEST_MODE);
                if (savedTestMode) {
                    $('#testMode').val(savedTestMode);
                }

                // Load metrics
                const savedMetrics = JSON.parse(localStorage.getItem(STORAGE_KEYS.METRICS) || 'null');
                if (Array.isArray(savedMetrics)) {
                    $('.metric-checkbox').each(function() {
                        const val = $(this).val();
                        $(this).prop('checked', savedMetrics.includes(val));
                    });
                }

                // Load numeric inputs
                const savedNumTests = localStorage.getItem(STORAGE_KEYS.NUM_TEST_CASES);
                if (savedNumTests) {
                    $('#numTestCases').val(parseInt(savedNumTests));
                }
                const savedNumConcepts = localStorage.getItem(STORAGE_KEYS.NUM_CONCEPTS);
                if (savedNumConcepts) {
                    $('#numConcepts').val(parseInt(savedNumConcepts));
                }
                const savedSteps = localStorage.getItem(STORAGE_KEYS.VEC2TEXT_STEPS);
                if (savedSteps) {
                    $('#vec2textSteps').val(parseInt(savedSteps));
                }
                const savedStartArticle = localStorage.getItem(STORAGE_KEYS.START_ARTICLE);
                if (savedStartArticle !== null) {
                    $('#startArticleIndex').val(parseInt(savedStartArticle));
                }
                const savedRandomStart = localStorage.getItem(STORAGE_KEYS.RANDOM_START);
                if (savedRandomStart !== null) {
                    $('#randomStart').prop('checked', savedRandomStart === 'true');
                }

                // Load select all state
                const selectAll = localStorage.getItem(STORAGE_KEYS.SELECT_ALL) === 'true';
                if (selectAll) {
                    $('#selectAllModels').prop('checked', true);
                }

                // Update UI state
                updateUIState();

            } catch (error) {
                console.error('Error loading saved state:', error);
                // Clear corrupted data
                localStorage.removeItem(STORAGE_KEYS.SETTINGS);
                localStorage.removeItem(STORAGE_KEYS.SELECTED_MODELS);
                localStorage.removeItem(STORAGE_KEYS.TEST_MODE);
                localStorage.removeItem(STORAGE_KEYS.SELECT_ALL);
            }
        }

        // Update UI based on current state
        function updateUIState() {
            updateSelectedModels();
            updateSelectAllCheckbox();
        }

        // Update selected models count and storage
        function updateSelectedModels() {
            const selectedModels = [];
            $('.model-checkbox:checked').each(function() {
                selectedModels.push($(this).val());
            });
            localStorage.setItem(STORAGE_KEYS.SELECTED_MODELS, JSON.stringify(selectedModels));
        }

        // Update select all checkbox state
        function updateSelectAllCheckbox() {
            const totalModels = $('.model-checkbox').length;
            const checkedModels = $('.model-checkbox:checked').length;
            $('#selectAllModels').prop('checked', totalModels > 0 && checkedModels === totalModels);
        }

        // Initialize UI components
        function initializeUI() {
            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            // Initialize Select2 if needed
            // $('.select2').select2({ theme: 'bootstrap-5' });
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Model card click (toggle selection)
            $(document).on('click', '.model-card', function(e) {
                // Don't trigger if clicking on a link, button, or input inside the card
                if ($(e.target).is('a, button, input, .btn, [data-bs-toggle]')) {
                    return;
                }
                
                const checkbox = $(this).find('.model-checkbox');
                checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
            });
            
            // Model checkbox change
            $(document).on('change', '.model-checkbox', function() {
                const card = $(this).closest('.model-card');
                card.toggleClass('selected', $(this).prop('checked'));
                updateSelectedModels();
                updateSelectAllCheckbox();
            });

            // Select all/none
            $('#selectAllModels').on('change', function() {
                const isChecked = $(this).prop('checked');
                $('.model-checkbox').prop('checked', isChecked).trigger('change');
                updateSelectedModels();
                localStorage.setItem(STORAGE_KEYS.SELECT_ALL, isChecked);
            });

            // Metric checkbox changes
            $(document).on('change', '.metric-checkbox', function() {
                const metrics = [];
                $('.metric-checkbox:checked').each(function() { metrics.push($(this).val()); });
                localStorage.setItem(STORAGE_KEYS.METRICS, JSON.stringify(metrics));
            });

            // Numeric inputs
            $('#numTestCases').on('change', function() {
                const v = parseInt($(this).val()) || 10;
                localStorage.setItem(STORAGE_KEYS.NUM_TEST_CASES, v);
            });
            $('#numConcepts').on('change', function() {
                const v = parseInt($(this).val()) || 5;
                localStorage.setItem(STORAGE_KEYS.NUM_CONCEPTS, v);
            });
            $('#vec2textSteps').on('change', function() {
                const v = parseInt($(this).val()) || 3;
                localStorage.setItem(STORAGE_KEYS.VEC2TEXT_STEPS, v);
            });
            $('#startArticleIndex').on('change', function() {
                const v = Math.max(0, parseInt($(this).val()) || 0);
                localStorage.setItem(STORAGE_KEYS.START_ARTICLE, v);
            });
            $('#randomStart').on('change', function() {
                localStorage.setItem(STORAGE_KEYS.RANDOM_START, $(this).is(':checked'));
            });

            // Evaluate button
            $('#evaluateBtn').on('click', function() {
                const selectedModels = $('.model-checkbox:checked').closest('.model-card').toArray();
                evaluateModels(selectedModels);
            });

            // Test mode change
            $('#testMode').on('change', function() {
                localStorage.setItem(STORAGE_KEYS.TEST_MODE, $(this).val());
            });

            // Settings modal events
            $('#settingsModal').on('show.bs.modal', loadSystemInfo);
            $('#settingsModal').on('hidden.bs.modal', saveSettings);
            $('#saveSettingsBtn').on('click', saveSettings);
            $('#resetAllBtn').on('click', resetAllSettings);
        }

        // Load system information for settings modal
        function loadSystemInfo() {
            $.get('/api/system-info', function(data) {
                $('#logFilePath').val(data.log_file);
                $('#modelsDirPath').val(data.models_dir);
            }).fail(function() {
                showAlert('Failed to load system information', 'danger');
            });
        }

        // Save settings
        function saveSettings() {
            const settings = {
                debugMode: $('#enableDebugMode').is(':checked'),
                logLevel: $('#logLevel').val(),
                maxLogFiles: $('#maxLogFiles').val()
            };
            
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            
            // Send to server
            $.ajax({
                url: '/api/update-settings',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(settings),
                success: function(response) {
                    showAlert('Settings saved successfully', 'success');
                    $('#settingsModal').modal('hide');
                },
                error: function() {
                    showAlert('Failed to save settings', 'danger');
                }
            });
        }

        // Reset all settings
        function resetAllSettings() {
            if (confirm('Are you sure you want to reset all settings and selections? This cannot be undone.')) {
                localStorage.clear();
                showAlert('All settings and selections have been reset.', 'info');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // Evaluate selected models
        function evaluateModels(selectedModels) {
            if (selectedModels.length === 0) {
                showAlert('Please select at least one model to evaluate.', 'warning');
                return;
            }

            // Get evaluation parameters
            const testMode = $('#testMode').val();
            const metrics = [];
            $('.metric-checkbox:checked').each(function() {
                metrics.push($(this).val());
            });
            const numConcepts = parseInt($('#numConcepts').val()) || 5;
            const numTestCases = parseInt($('#numTestCases').val()) || 10;

            if (metrics.length === 0) {
                showAlert('Please select at least one evaluation metric.', 'warning');
                return;
            }

            // Collect model paths
            const modelPaths = [];
            selectedModels.forEach(model => {
                const checkbox = $(model).find('.model-checkbox');
                modelPaths.push(checkbox.val());
            });

            console.log('Starting evaluation for models:', modelPaths);

            // Start progress tracking
            evaluationProgress.start();

            // Start SSE connection for real-time progress
            // Disabled: SSE endpoint not implemented
            // if (window.EventSource) {
            //     evaluationProgress.initializeSSE();
            // }

            // Use polling for progress updates instead
            evaluationProgress.startPolling();

            // Use parallel endpoint for multiple models, sequential for single model
            const endpoint = modelPaths.length > 1 ? '/evaluate/parallel' : '/evaluate';
            
            // Start the evaluation (non-blocking)
            $.ajax({
                url: endpoint,
                method: 'POST',
                contentType: 'application/json',
                timeout: 300000, // 5 minute timeout for model evaluation
                data: JSON.stringify({
                    models: modelPaths,
                    test_mode: testMode,
                    metrics: metrics,
                    num_concepts: numConcepts,
                    num_test_cases: numTestCases,
                    vec2text_steps: parseInt($('#vec2textSteps').val()) || 3,
                    start_article_index: Math.max(0, parseInt($('#startArticleIndex').val()) || 0),
                    random_start: $('#randomStart').is(':checked')
                }),
                success: function(response) {
                    console.log('Evaluation response:', response);
                    console.log('Results array:', response.results);
                    evaluationProgress.complete(response);
                    
                    // Display results regardless of status
                    if (response.results) {
                        console.log('Calling displayResults with', response.results.length, 'results');
                        displayResults(response.results);
                        showAlert(response.message || 'Evaluation completed!', 'success');
                    } else {
                        console.error('No results in response');
                        showAlert('Evaluation completed but no results returned', 'warning');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Evaluation error:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                    
                    let errorMsg = 'Error evaluating models: ';
                    if (status === 'timeout') {
                        errorMsg += 'Request timed out. The evaluation may be taking too long.';
                    } else if (xhr.responseText) {
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            errorMsg += errorResponse.error || errorResponse.message || 'Unknown error';
                        } catch (e) {
                            errorMsg += xhr.responseText;
                        }
                    } else {
                        errorMsg += error || 'Unknown error';
                    }
                    
                    evaluationProgress.error(errorMsg);
                }
            });
        }

        // Helper function to copy text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        // Copy button handlers
        $('#copyLogPath').click(function() {
            copyToClipboard($('#logFilePath').val());
            showAlert('Log file path copied to clipboard', 'success');
        });

        $('#copyModelsPath').click(function() {
            copyToClipboard($('#modelsDirPath').val());
            showAlert('Models directory path copied to clipboard', 'success');
        });
    </script>
</body>
</html>
