<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard Diagnostic - v2.0 [<?php echo time(); ?>]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; font-family: monospace; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .info { color: blue; }
        #log { 
            background: #f5f5f5; 
            padding: 20px; 
            border-radius: 5px; 
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }
        .test-item { 
            padding: 5px 0; 
            border-bottom: 1px solid #ddd; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç LVM Dashboard Diagnostic Tool</h1>
        <p class="info">Page loaded at: <span id="loadTime"></span></p>
        
        <div class="alert alert-info">
            <strong>Instructions:</strong>
            <ol>
                <li>Watch this page - tests will run automatically</li>
                <li>All tests should show green checkmarks ‚úÖ</li>
                <li>If you see red X marks ‚ùå, check the error details</li>
                <li>Press Ctrl+Shift+R (or Cmd+Shift+R on Mac) to force refresh if needed</li>
            </ol>
        </div>
        
        <div id="log"></div>
        
        <hr>
        
        <h3>Manual Actions</h3>
        <button class="btn btn-primary" onclick="location.href='/'">Go to Main Dashboard</button>
        <button class="btn btn-secondary" onclick="runTests()">Re-run Tests</button>
        <button class="btn btn-warning" onclick="clearCache()">Clear Cache & Reload</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const log = document.getElementById('log');
        let testCount = 0;
        let passCount = 0;
        let failCount = 0;
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'test-item ' + type;
            const time = new Date().toLocaleTimeString();
            
            if (type === 'pass') {
                div.innerHTML = `[${time}] ‚úÖ ${message}`;
                passCount++;
            } else if (type === 'fail') {
                div.innerHTML = `[${time}] ‚ùå ${message}`;
                failCount++;
            } else {
                div.innerHTML = `[${time}] ‚ÑπÔ∏è ${message}`;
            }
            
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            console.log(message);
            testCount++;
        }
        
        function clearCache() {
            addLog('Clearing cache and reloading...', 'info');
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            setTimeout(() => location.reload(true), 500);
        }
        
        async function runTests() {
            log.innerHTML = '';
            testCount = 0;
            passCount = 0;
            failCount = 0;
            
            addLog('=== Starting Diagnostic Tests ===', 'info');
            addLog('', 'info');
            
            // Test 1: Basic JavaScript
            try {
                addLog('Test 1: JavaScript execution', 'pass');
            } catch (e) {
                addLog('Test 1: JavaScript execution - ' + e, 'fail');
                return;
            }
            
            // Test 2: jQuery
            try {
                if (typeof $ === 'undefined') {
                    throw new Error('jQuery not loaded');
                }
                addLog('Test 2: jQuery loaded', 'pass');
            } catch (e) {
                addLog('Test 2: jQuery - ' + e, 'fail');
                return;
            }
            
            // Test 3: API - Models
            try {
                addLog('Test 3: Fetching models from API...', 'info');
                const resp = await $.ajax({
                    url: '/api/models',
                    method: 'GET',
                    dataType: 'json'
                });
                
                if (resp.status === 'success' && resp.models) {
                    addLog(`Test 3: API /api/models - Found ${resp.models.length} models`, 'pass');
                    if (resp.models.length > 0) {
                        addLog(`  First model: ${resp.models[0].relative_path}`, 'info');
                    }
                } else {
                    addLog('Test 3: API returned unexpected format', 'fail');
                }
            } catch (e) {
                addLog('Test 3: API /api/models - ' + e, 'fail');
            }
            
            // Test 4: API - Progress
            try {
                const resp = await $.ajax({
                    url: '/api/progress',
                    method: 'GET',
                    dataType: 'json'
                });
                addLog(`Test 4: API /api/progress - Status: ${resp.status}`, 'pass');
            } catch (e) {
                addLog('Test 4: API /api/progress - ' + e, 'fail');
            }
            
            // Test 5: EventSource support
            try {
                if (!window.EventSource) {
                    throw new Error('EventSource not supported');
                }
                addLog('Test 5: EventSource (SSE) supported', 'pass');
            } catch (e) {
                addLog('Test 5: EventSource - ' + e, 'fail');
            }
            
            // Test 6: Quick evaluation test
            try {
                addLog('Test 6: Running quick evaluation test...', 'info');
                const modelsResp = await $.ajax({ url: '/api/models', method: 'GET' });
                
                if (modelsResp.models && modelsResp.models.length > 0) {
                    const testModel = modelsResp.models[0].path;
                    
                    const evalResp = await $.ajax({
                        url: '/evaluate',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            models: [testModel],
                            test_mode: 'in'
                        })
                    });
                    
                    if (evalResp.status === 'complete') {
                        addLog(`Test 6: Evaluation endpoint - ${evalResp.message}`, 'pass');
                    } else {
                        addLog('Test 6: Evaluation returned unexpected status', 'fail');
                    }
                } else {
                    addLog('Test 6: No models available to test', 'fail');
                }
            } catch (e) {
                addLog('Test 6: Evaluation test - ' + e, 'fail');
            }
            
            // Summary
            addLog('', 'info');
            addLog('=== Test Summary ===', 'info');
            addLog(`Total: ${testCount} | Passed: ${passCount} | Failed: ${failCount}`, 'info');
            
            if (failCount === 0) {
                addLog('', 'info');
                addLog('üéâ ALL TESTS PASSED! Dashboard is fully functional.', 'pass');
                addLog('You can now go to the main dashboard.', 'info');
            } else {
                addLog('', 'info');
                addLog(`‚ö†Ô∏è ${failCount} test(s) failed. Check errors above.`, 'fail');
            }
        }
        
        // Auto-run on load
        document.getElementById('loadTime').textContent = new Date().toLocaleString();
        
        $(document).ready(function() {
            addLog('Page ready - jQuery working', 'pass');
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>
