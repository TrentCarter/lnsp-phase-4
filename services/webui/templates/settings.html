<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - PAS Agent Swarm</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1629;
            color: #e0e0e0;
            margin: 0;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #3a4568;
        }
        
        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #3a4568;
        }
        
        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: #1a1f3a;
            border: 1px solid #3a4568;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            background: #2a2f4a;
        }
        
        .nav-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }
        
        .model-card {
            background: #1a1f3a;
            border: 1px solid #3a4568;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
        }
        
        .model-card:hover {
            border-color: #4a5578;
            transform: translateY(-2px);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-ok {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-api {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: #fff;
            border-bottom: 1px solid #3a4568;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .env-display {
            background: #1e2747;
            border: 1px solid #3a4568;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
        }
        
        .key-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .key-valid {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .key-invalid {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .key-placeholder {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .refresh-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Settings & Model Pool</h1>
            <button class="refresh-btn" onclick="refreshAll()">üîÑ Refresh All</button>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('all')">üåê All Models</div>
            <div class="nav-tab" onclick="showTab('local')">üè† Local Models</div>
            <div class="nav-tab" onclick="showTab('api')">üîë API Models</div>
            <div class="nav-tab" onclick="showTab('env')">üîê API Keys</div>
            <div class="nav-tab" onclick="showTab('usage')">üìä Usage</div>
            <div class="nav-tab" onclick="showTab('system')">‚öôÔ∏è System Status</div>
        </div>

        <!-- All Models Tab -->
        <div id="all" class="tab-content active">
            <div class="section">
                <h2>üåê Complete Model Inventory</h2>
                <div id="all-models" class="model-grid">
                    <div class="loading">Loading all models...</div>
                </div>
            </div>
        </div>

        <!-- Local Models Tab -->
        <div id="local" class="tab-content">
            <div class="section">
                <h2>üè† Local LLMs</h2>
                <div id="local-models" class="model-grid">
                    <div class="loading">Loading local models...</div>
                </div>
            </div>
        </div>

        <!-- API Models Tab -->
        <div id="api" class="tab-content">
            <div class="section">
                <h2>üîë API Models</h2>
                <div id="api-models" class="model-grid">
                    <div class="loading">Loading API models...</div>
                </div>
            </div>
        </div>

        <!-- API Keys Tab -->
        <div id="env" class="tab-content">
            <div class="section">
                <h2>Environment Configuration (.env)</h2>
                <div id="env-config" class="env-display">
                    <div class="loading">Loading .env configuration...</div>
                </div>
            </div>
            
            <div class="section">
                <h2>API Key Status</h2>
                <div id="key-status">
                    <div class="loading">Checking API keys...</div>
                </div>
            </div>
        </div>

        <!-- Usage Stats Tab -->
        <div id="usage" class="tab-content">
            <div class="section">
                <h2>Model Usage Statistics</h2>
                <div id="usage-stats">
                    <div class="loading">Loading usage data...</div>
                </div>
                <button class="refresh-btn" onclick="clearUsage()" style="background: #ef4444;">üóëÔ∏è Clear All Stats</button>
            </div>
        </div>

        <!-- System Status Tab -->
        <div id="system" class="tab-content">
            <div class="section">
                <h2>System Health</h2>
                <div id="system-status">
                    <div class="loading">Checking system health...</div>
                </div>
            </div>

            <div class="section">
                <h2>System Control</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 600px;">
                    <button class="refresh-btn" onclick="clearCaches()" style="background: #f59e0b;">
                        üóëÔ∏è Clear Caches
                    </button>
                    <button class="refresh-btn" onclick="clearAllLLMData()" style="background: #ef4444;">
                        ‚ö†Ô∏è Clear All LLM Data
                    </button>
                    <button class="refresh-btn" onclick="clearAllProjectData()" style="background: #dc2626;">
                        üö® Clear All Project Data
                    </button>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #1e2747; border: 1px solid #3a4568; border-radius: 8px; color: #9ca3af; font-size: 0.875rem;">
                    <strong>‚ö†Ô∏è Warning:</strong> These actions are permanent and cannot be undone. Use with caution.
                </div>
            </div>
        </div>
    </div>

    <script>
        let modelData = {};
        let envData = {};

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active to selected nav tab
            event.target.classList.add('active');
        }

        async function loadModels() {
            try {
                const [allResponse, localResponse, apiResponse] = await Promise.all([
                    fetch('/api/models/status'),
                    fetch('/api/models/local-status'),
                    fetch('/api/models/api-status')
                ]);

                const allData = await allResponse.json();
                const localData = await localResponse.json();
                const apiData = await apiResponse.json();

                if (allData.status === 'ok') {
                    renderModels('all-models', allData.models);
                }
                if (localData.status === 'ok') {
                    renderModels('local-models', localData.models, 'local');
                }
                if (apiData.status === 'ok') {
                    renderModels('api-models', apiData.models, 'api');
                }
            } catch (error) {
                console.error('Error loading models:', error);
            }
        }

        function renderModels(containerId, models, type = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (Object.keys(models).length === 0) {
                container.innerHTML = '<div class="loading">No models found</div>';
                return;
            }

            Object.entries(models).forEach(([modelId, model]) => {
                const card = document.createElement('div');
                card.className = `model-card ${type || ''}`;

                const isLocal = model.provider === 'local';
                const isApi = ['openai', 'anthropic', 'google', 'deepseek'].includes(model.provider);
                
                let statusClass = 'status-error';
                let statusText = 'Unavailable';
                
                if (model.available) {
                    statusClass = isApi ? 'status-api' : 'status-ok';
                    statusText = isApi ? 'API Ready' : 'Available';
                } else if (model.status === 'INVALID_KEY') {
                    statusClass = 'status-warning';
                    statusText = 'Invalid Key';
                }

                const costInfo = isApi ? `
                    <div><strong>Cost (Input/1K):</strong> $${model.cost_per_1k_input || 0}</div>
                    <div><strong>Cost (Output/1K):</strong> $${model.cost_per_1k_output || 0}</div>
                ` : '';

                const portInfo = model.port ? `<div><strong>Port:</strong> ${model.port}</div>` : '';

                card.innerHTML = `
                    <div class="model-header">
                        <div><strong>${model.name}</strong></div>
                        <div class="status-badge ${statusClass}">${statusText}</div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <div><strong>Provider:</strong> ${model.provider.toUpperCase()}</div>
                        <div><strong>Type:</strong> ${isLocal ? 'Local' : 'API'}</div>
                        <div><strong>Status:</strong> ${model.status}</div>
                        ${portInfo}
                        ${costInfo}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function loadEnvConfig() {
            try {
                const response = await fetch('/api/env/config');
                const data = await response.json();
                
                if (data.status === 'ok') {
                    renderEnvConfig(data.config);
                    renderKeyStatus(data.keys);
                }
            } catch (error) {
                document.getElementById('env-config').innerHTML = '<div class="error">Error loading .env</div>';
            }
        }

        function renderEnvConfig(config) {
            const container = document.getElementById('env-config');
            container.innerHTML = '';
            
            Object.entries(config).forEach(([key, value]) => {
                const line = document.createElement('div');
                line.textContent = `${key}=${value}`;
                container.appendChild(line);
            });
        }

        function renderKeyStatus(keys) {
            const container = document.getElementById('key-status');
            container.innerHTML = '';
            
            Object.entries(keys).forEach(([provider, status]) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <strong>${provider}:</strong> 
                    <span class="key-${status}">${status}</span>
                `;
                container.appendChild(div);
            });
        }

        async function loadUsage() {
            try {
                const response = await fetch('/api/models/usage');
                const data = await response.json();
                
                if (data.status === 'ok') {
                    renderUsage(data.usage);
                }
            } catch (error) {
                document.getElementById('usage-stats').innerHTML = '<div class="error">Error loading usage</div>';
            }
        }

        function renderUsage(usage) {
            const container = document.getElementById('usage-stats');
            container.innerHTML = `
                <div><strong>Total Requests:</strong> ${usage.total_requests || 0}</div>
                <div><strong>Total Tokens:</strong> ${usage.total_tokens || 0}</div>
                <div><strong>Total Cost:</strong> $${(usage.total_cost || 0).toFixed(4)}</div>
            `;
        }

        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                
                if (data.status === 'ok') {
                    renderSystemStatus(data);
                }
            } catch (error) {
                document.getElementById('system-status').innerHTML = '<div class="error">Error loading system status</div>';
            }
        }

        function renderSystemStatus(data) {
            const container = document.getElementById('system-status');
            container.innerHTML = `
                <div><strong>Overall Health:</strong> ${data.overall_health_percent}%</div>
                <div><strong>Issues:</strong> ${data.issues_count}</div>
                <div><strong>Ports Up:</strong> ${data.required_ports_up}/${data.required_ports_total}</div>
            `;
        }

        async function clearUsage() {
            if (confirm('Clear all usage statistics? This cannot be undone.')) {
                try {
                    const response = await fetch('/api/models/usage/clear', { method: 'POST' });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        await loadUsage();
                        alert('Usage statistics cleared successfully!');
                    }
                } catch (error) {
                    alert('Failed to clear usage statistics: ' + error.message);
                }
            }
        }

        async function refreshAll() {
            await Promise.all([
                loadModels(),
                loadEnvConfig(),
                loadUsage(),
                loadSystemStatus()
            ]);
        }

        async function clearCaches() {
            if (confirm('Clear temporary files and caches?')) {
                try {
                    const response = await fetch('/api/system/clear-caches', { method: 'POST' });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        alert(`‚úì Cleared ${data.freed_mb || 0}MB of cache data`);
                    } else {
                        alert('‚ùå ' + (data.error || 'Failed to clear caches'));
                    }
                } catch (error) {
                    alert('Failed to clear caches: ' + error.message);
                }
            }
        }

        async function clearAllLLMData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL LLM chat history and conversation sessions from the database.\n\nThis action CANNOT be undone.\n\nAre you absolutely sure you want to continue?')) {
                return;
            }

            // Double confirmation
            if (!confirm('FINAL CONFIRMATION: All chat history will be permanently deleted. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/chat/sessions', { method: 'DELETE' });
                const data = await response.json();
                if (data.status === 'ok') {
                    alert(`‚úì Successfully deleted ${data.deleted_count} sessions`);
                    await refreshAll();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to clear LLM data'));
                }
            } catch (error) {
                alert('Failed to clear LLM data: ' + error.message);
            }
        }

        async function clearAllProjectData() {
            if (!confirm('üö® CRITICAL WARNING: This will DELETE ALL project and task data from the Registry database.\n\nThis includes:\n- All action logs\n- All service records\n- All project history\n\nThis action CANNOT be undone.\n\nAre you absolutely sure?')) {
                return;
            }

            // Double confirmation
            if (!confirm('FINAL CONFIRMATION: Type "DELETE ALL" in your mind and click OK to proceed.')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/clear-all', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'ok') {
                    alert(`‚úì Successfully cleared all project data. Deleted ${data.deleted_count || 0} records.`);
                    await refreshAll();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to clear project data'));
                }
            } catch (error) {
                alert('Failed to clear project data: ' + error.message);
            }
        }

        // Add missing API endpoints
        async function addMissingEndpoints() {
            // Add /api/env/config endpoint if it doesn't exist
            if (!window.apiEnvConfig) {
                window.apiEnvConfig = async () => {
                    // Mock .env data for now
                    return {
                        status: 'ok',
                        config: {
                            'OPENAI_API_KEY': 'your-openai-key-here',
                            'ANTHROPIC_API_KEY': 'your-anthropic-key-here',
                            'GEMINI_API_KEY': 'your-gemini-key-here',
                            'DEEPSEEK_API_KEY': 'your-deepseek-key-here'
                        },
                        keys: {
                            'OpenAI': 'placeholder',
                            'Anthropic': 'placeholder',
                            'Gemini': 'placeholder',
                            'DeepSeek': 'placeholder'
                        }
                    };
                };
            }
        }

        // Load everything on page load
        document.addEventListener('DOMContentLoaded', () => {
            refreshAll();
        });
    </script>
</body>
</html>
