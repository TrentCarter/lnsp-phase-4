{% extends "base.html" %}

{% block title %}Dashboard - PAS Agent Swarm{% endblock %}

{% block extra_styles %}
<style>
    .service-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .service-card {
        background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%);
        border: 1px solid #3a4568;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }

    .service-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .service-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: #fff;
    }

    .service-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #6b7280;
    }

    .service-status.healthy {
        background-color: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
    }

    .service-status.unhealthy {
        background-color: #ef4444;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
    }

    .service-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        color: #9ca3af;
        font-size: 0.875rem;
    }

    .service-info-row {
        display: flex;
        justify-content: space-between;
    }

    .service-info-label {
        color: #6b7280;
    }

    .service-info-value {
        color: #e0e0e0;
        font-weight: 500;
    }

    .last-update {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #3a4568;
        font-size: 0.75rem;
        color: #6b7280;
    }

    /* Collapsible Section Styles */
    .section-container {
        margin-bottom: 2rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #2a3558 0%, #1e2747 100%);
        border: 1px solid #3a4568;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
    }

    .section-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .section-drag-handle {
        cursor: grab;
        color: #6b7280;
        font-size: 1.25rem;
        padding: 0.25rem;
        transition: color 0.2s;
        user-select: none;
    }

    .section-drag-handle:hover {
        color: #9ca3af;
    }

    .section-drag-handle:active {
        cursor: grabbing;
    }

    .section-container.dragging {
        opacity: 0.5;
    }

    .section-container.drag-over {
        border-top: 3px solid #3b82f6;
        margin-top: 0.5rem;
    }

    .section-header:hover {
        background: linear-gradient(135deg, #3a4568 0%, #2a3558 100%);
        border-color: #4a5578;
    }

    .section-header h2 {
        color: #fff;
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .section-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #9ca3af;
        font-size: 0.875rem;
    }

    .section-toggle-icon {
        font-size: 1.25rem;
        font-weight: bold;
        transition: transform 0.3s ease;
    }

    .section-header.collapsed .section-toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        max-height: 10000px;
        overflow: hidden;
        transition: max-height 0.5s ease, opacity 0.3s ease;
        opacity: 1;
    }

    .section-content.collapsed {
        max-height: 0;
        opacity: 0;
    }

    .section-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: rgba(16, 185, 129, 0.2);
        border: 1px solid #10b981;
        border-radius: 12px;
        color: #10b981;
        font-size: 0.875rem;
        font-weight: 600;
        margin-left: 0.75rem;
    }

    /* Reset Stats Button */
    .reset-button {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .reset-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .reset-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div id="alerts-container"></div>

    <!-- System Metrics Section -->
    <div class="section-container" data-section-id="system-metrics" draggable="true">
        <div class="section-header">
            <div class="section-header-left" onclick="toggleSection('system-metrics')">
                <span class="section-drag-handle" draggable="true" onclick="event.stopPropagation()">‚ò∞</span>
                <h2>System Metrics <span class="section-badge" id="system-health-badge">-</span></h2>
            </div>
            <div class="section-toggle" onclick="toggleSection('system-metrics')">
                <span class="section-toggle-text">Collapse</span>
                <span class="section-toggle-icon">‚ñº</span>
            </div>
        </div>
        <div class="section-content" id="system-metrics-content">
            <div class="metrics-row" style="margin-top: 1rem;">
                <div class="metric-card">
                    <h3>Total Services</h3>
                    <div class="value" id="total-services">-</div>
                    <div class="subtext">Registered in system</div>
                </div>
                <div class="metric-card">
                    <h3>Healthy Services</h3>
                    <div class="value" id="healthy-services">-</div>
                    <div class="subtext">Responding to heartbeats</div>
                </div>
                <div class="metric-card">
                    <h3>System Uptime</h3>
                    <div class="value" id="system-uptime">-</div>
                    <div class="subtext" id="system-uptime-since">Last restart: -</div>
                </div>
                <div class="metric-card">
                    <h3>Connected Clients</h3>
                    <div class="value" id="connected-clients">-</div>
                    <div class="subtext">WebSocket connections</div>
                </div>
                <div class="metric-card">
                    <h3>System Health</h3>
                    <div class="value" id="system-health">-</div>
                    <div class="subtext">Overall system status</div>
                </div>
            </div>
        </div>
    </div>

    <!-- TRON HHMRS Status Section -->
    <div class="section-container" data-section-id="tron-status" draggable="true">
        <div class="section-header">
            <div class="section-header-left" onclick="toggleSection('tron-status')">
                <span class="section-drag-handle" draggable="true" onclick="event.stopPropagation()">‚ò∞</span>
                <h2>‚ö° TRON HHMRS <span class="section-badge" id="tron-badge">0 events</span></h2>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button onclick="resetTronStats()" class="reset-button" title="Reset all TRON statistics">
                    üîÑ Reset Stats
                </button>
                <div class="section-toggle" onclick="toggleSection('tron-status')">
                    <span class="section-toggle-text">Collapse</span>
                    <span class="section-toggle-icon">‚ñº</span>
                </div>
            </div>
        </div>
        <div class="section-content" id="tron-status-content">
            <div class="metrics-row" style="margin-top: 1rem;">
                <div class="metric-card">
                    <h3>‚è±Ô∏è Timeouts</h3>
                    <div class="value" id="tron-timeouts">0</div>
                    <div class="subtext">Agents timed out</div>
                </div>
                <div class="metric-card">
                    <h3>üîÑ Restarts</h3>
                    <div class="value" id="tron-restarts">0</div>
                    <div class="subtext">Agents restarted</div>
                </div>
                <div class="metric-card">
                    <h3>‚¨ÜÔ∏è Escalations</h3>
                    <div class="value" id="tron-escalations">0</div>
                    <div class="subtext">LLM switches</div>
                </div>
                <div class="metric-card">
                    <h3>‚ùå Failures</h3>
                    <div class="value" id="tron-failures">0</div>
                    <div class="subtext">Permanent failures</div>
                </div>
            </div>

            <!-- Recent TRON Events List -->
            <div style="margin-top: 1.5rem; background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%); border: 1px solid #3a4568; border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #fff; margin-bottom: 1rem; font-size: 1rem;">Recent Events</h3>
                <div id="tron-events-list" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
                    <p style="color: #9ca3af; font-size: 0.875rem;">No TRON events yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Services Section -->
    <div class="section-container" data-section-id="core-services" draggable="true">
        <div class="section-header">
            <div class="section-header-left" onclick="toggleSection('core-services')">
                <span class="section-drag-handle" draggable="true" onclick="event.stopPropagation()">‚ò∞</span>
                <h2>Core Services <span class="section-badge" id="core-services-badge">5</span></h2>
            </div>
            <div class="section-toggle" onclick="toggleSection('core-services')">
                <span class="section-toggle-text">Collapse</span>
                <span class="section-toggle-icon">‚ñº</span>
            </div>
        </div>
        <div class="section-content" id="core-services-content">
            <div id="services-container" class="service-cards">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading services...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Programmer Pool Section -->
    <div class="section-container" data-section-id="programmer-pool" draggable="true">
        <div class="section-header">
            <div class="section-header-left" onclick="toggleSection('programmer-pool')">
                <span class="section-drag-handle" draggable="true" onclick="event.stopPropagation()">‚ò∞</span>
                <h2>üíª Programmer Pool <span class="section-badge" id="pool-badge">-</span></h2>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button onclick="resetPoolStats()" class="reset-button" title="Reset programmer pool statistics">
                    üîÑ Reset Stats
                </button>
                <div class="section-toggle" onclick="toggleSection('programmer-pool')">
                    <span class="section-toggle-text">Collapse</span>
                    <span class="section-toggle-icon">‚ñº</span>
                </div>
            </div>
        </div>
        <div class="section-content" id="programmer-pool-content">
            <!-- Pool Stats -->
            <div class="metrics-row" style="margin-bottom: 1.5rem;">
                <div class="metric-card">
                    <h3>Total Programmers</h3>
                    <div class="value" id="pool-total">-</div>
                    <div class="subtext">Registered in pool</div>
                </div>
                <div class="metric-card">
                    <h3>Available</h3>
                    <div class="value" id="pool-available" style="color: #10b981;">-</div>
                    <div class="subtext">Ready for tasks</div>
                </div>
                <div class="metric-card">
                    <h3>Busy</h3>
                    <div class="value" id="pool-busy" style="color: #f59e0b;">-</div>
                    <div class="subtext">Currently working</div>
                </div>
                <div class="metric-card">
                    <h3>Tasks Completed</h3>
                    <div class="value" id="pool-completed">-</div>
                    <div class="subtext" id="pool-success-rate">Success rate: -%</div>
                </div>
            </div>

            <!-- Programmer Cards -->
            <div id="programmers-container" class="service-cards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading programmers...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Registered Agents Section -->
    <div class="section-container" data-section-id="registered-agents" draggable="true">
        <div class="section-header">
            <div class="section-header-left" onclick="toggleSection('registered-agents')">
                <span class="section-drag-handle" draggable="true" onclick="event.stopPropagation()">‚ò∞</span>
                <h2>Registered Agents <span class="section-badge" id="agents-badge">0</span></h2>
            </div>
            <div class="section-toggle" onclick="toggleSection('registered-agents')">
                <span class="section-toggle-text">Collapse</span>
                <span class="section-toggle-icon">‚ñº</span>
            </div>
        </div>
        <div class="section-content" id="registered-agents-content">
            <div id="agents-container" class="service-cards">
                <div class="loading">
                    <p>No agents registered yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LLM Metrics Section -->
    <div class="section-container" data-section-id="llm-metrics" draggable="true">
        <div class="section-header">
            <div class="section-header-left" onclick="toggleSection('llm-metrics')">
                <span class="section-drag-handle" draggable="true" onclick="event.stopPropagation()">‚ò∞</span>
                <h2>ü§ñ LLM Metrics <span class="section-badge" id="llm-badge">0 models</span></h2>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button onclick="resetLLMStats()" class="reset-button" title="Reset LLM statistics (clears chat database)">
                    üîÑ Reset Stats
                </button>
                <div class="section-toggle" onclick="toggleSection('llm-metrics')">
                    <span class="section-toggle-text">Collapse</span>
                    <span class="section-toggle-icon">‚ñº</span>
                </div>
            </div>
        </div>
        <div class="section-content" id="llm-metrics-content">
            <!-- Overall Totals -->
            <div class="metrics-row" style="margin-top: 1rem;">
                <div class="metric-card">
                    <h3>Total Tokens</h3>
                    <div class="value" id="llm-total-tokens">0</div>
                    <div class="subtext">All models</div>
                </div>
                <div class="metric-card">
                    <h3>Total Messages</h3>
                    <div class="value" id="llm-total-messages">0</div>
                    <div class="subtext">Conversations</div>
                </div>
                <div class="metric-card">
                    <h3>Total Sessions</h3>
                    <div class="value" id="llm-total-sessions">0</div>
                    <div class="subtext">Chat sessions</div>
                </div>
                <div class="metric-card">
                    <h3>Total Cost</h3>
                    <div class="value" id="llm-total-cost">$0.000</div>
                    <div class="subtext">API models only</div>
                </div>
            </div>

            <!-- Per-Model Breakdown -->
            <div style="margin-top: 2rem; background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%); border: 1px solid #3a4568; border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #fff; margin-bottom: 1rem;">Per-Model Usage</h3>
                <div id="llm-models-breakdown" style="display: flex; flex-direction: column; gap: 1rem;">
                    <p style="color: #9ca3af;">No LLM usage data available yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Tracking Section (MOVED TO BOTTOM) -->
    <div class="section-container" data-section-id="cost-tracking" draggable="true">
        <div class="section-header">
            <div class="section-header-left" onclick="toggleSection('cost-tracking')">
                <span class="section-drag-handle" draggable="true" onclick="event.stopPropagation()">‚ò∞</span>
                <h2>Cost Tracking <span class="section-badge" id="cost-badge">$0.00</span></h2>
            </div>
            <div class="section-toggle" onclick="toggleSection('cost-tracking')">
                <span class="section-toggle-text">Collapse</span>
                <span class="section-toggle-icon">‚ñº</span>
            </div>
        </div>
        <div class="section-content" id="cost-tracking-content">
            <div class="metrics-row" style="margin-top: 1rem;">
                <div class="metric-card">
                    <h3>Total Cost</h3>
                    <div class="value" id="total-cost">$0.00</div>
                    <div class="subtext">Last minute</div>
                </div>
                <div class="metric-card">
                    <h3>Requests</h3>
                    <div class="value" id="total-requests">0</div>
                    <div class="subtext">Last minute</div>
                </div>
                <div class="metric-card">
                    <h3>Tokens</h3>
                    <div class="value" id="total-tokens">0</div>
                    <div class="subtext">Last minute</div>
                </div>
                <div class="metric-card">
                    <h3>Avg Cost/Request</h3>
                    <div class="value" id="avg-cost">$0.00</div>
                    <div class="subtext">Per request</div>
                </div>
            </div>

            <!-- Cost Breakdown -->
            <div style="margin-top: 2rem; background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%); border: 1px solid #3a4568; border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #fff; margin-bottom: 1rem;">Cost Breakdown by Provider</h3>
                <div id="cost-breakdown">
                    <p style="color: #9ca3af;">No cost data available yet</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let metricsUpdateInterval = null;

    // Toggle agent group (Directors, Managers, Programmers)
    function toggleAgentGroup(groupId) {
        const collapsedGroups = JSON.parse(localStorage.getItem('collapsedAgentGroups') || '[]');
        const index = collapsedGroups.indexOf(groupId);

        if (index > -1) {
            collapsedGroups.splice(index, 1);
        } else {
            collapsedGroups.push(groupId);
        }

        localStorage.setItem('collapsedAgentGroups', JSON.stringify(collapsedGroups));
        fetchAgents(); // Re-render with new collapsed state
    }

    // Load collapsed sections state from localStorage
    function loadCollapsedSections() {
        const collapsed = JSON.parse(localStorage.getItem('dashboardCollapsedSections') || '[]');
        collapsed.forEach(sectionId => {
            const content = document.getElementById(`${sectionId}-content`);
            const header = content?.previousElementSibling;
            const toggleText = header?.querySelector('.section-toggle-text');

            if (content && header) {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                if (toggleText) toggleText.textContent = 'Expand';
            }
        });
    }

    // Save collapsed sections state to localStorage
    function saveCollapsedSections() {
        const collapsed = [];
        document.querySelectorAll('.section-content.collapsed').forEach(content => {
            const sectionId = content.id.replace('-content', '');
            collapsed.push(sectionId);
        });
        localStorage.setItem('dashboardCollapsedSections', JSON.stringify(collapsed));
    }

    // Collapsible Section Toggle
    function toggleSection(sectionId) {
        const content = document.getElementById(`${sectionId}-content`);
        const header = content.previousElementSibling;
        const toggleText = header.querySelector('.section-toggle-text');

        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            header.classList.remove('collapsed');
            toggleText.textContent = 'Collapse';
        } else {
            content.classList.add('collapsed');
            header.classList.add('collapsed');
            toggleText.textContent = 'Expand';
        }

        // Save state to localStorage
        saveCollapsedSections();
    }

    // Track TRON events for dashboard display
    window.dashboardTronEvents = [];
    window.dashboardTronCounts = {
        timeouts: 0,
        restarts: 0,
        escalations: 0,
        failures: 0
    };

    // Override the base event handler
    function handleRealtimeEvent(event) {
        console.log('Dashboard received event:', event.event_type, event);

        switch(event.event_type) {
            case 'heartbeat':
                updateServiceCard(event.data);
                break;
            case 'status_update':
                updateServiceStatus(event.data);
                break;
            case 'alert':
                showAlert(event.data);
                break;
            case 'hhmrs_timeout':
            case 'hhmrs_restart':
            case 'hhmrs_escalation':
            case 'hhmrs_failure':
                updateTRONDashboard(event.event_type, event.data);
                break;
            default:
                console.log('Unhandled event type:', event.event_type);
        }
    }

    // Update TRON dashboard section with new event
    function updateTRONDashboard(eventType, data) {
        // Update counters
        if (eventType === 'hhmrs_timeout') {
            window.dashboardTronCounts.timeouts++;
            document.getElementById('tron-timeouts').textContent = window.dashboardTronCounts.timeouts;
        } else if (eventType === 'hhmrs_restart') {
            window.dashboardTronCounts.restarts++;
            document.getElementById('tron-restarts').textContent = window.dashboardTronCounts.restarts;
        } else if (eventType === 'hhmrs_escalation') {
            window.dashboardTronCounts.escalations++;
            document.getElementById('tron-escalations').textContent = window.dashboardTronCounts.escalations;
        } else if (eventType === 'hhmrs_failure') {
            window.dashboardTronCounts.failures++;
            document.getElementById('tron-failures').textContent = window.dashboardTronCounts.failures;
        }

        // Update total events badge
        const totalEvents = Object.values(window.dashboardTronCounts).reduce((sum, val) => sum + val, 0);
        document.getElementById('tron-badge').textContent = `${totalEvents} event${totalEvents !== 1 ? 's' : ''}`;

        // Add to events list
        const eventIcons = {
            'hhmrs_timeout': '‚è±Ô∏è',
            'hhmrs_restart': 'üîÑ',
            'hhmrs_escalation': '‚¨ÜÔ∏è',
            'hhmrs_failure': '‚ùå'
        };
        const eventLabels = {
            'hhmrs_timeout': 'Timeout',
            'hhmrs_restart': 'Restart',
            'hhmrs_escalation': 'Escalation',
            'hhmrs_failure': 'Failure'
        };

        const event = {
            type: eventType,
            icon: eventIcons[eventType] || 'üìå',
            label: eventLabels[eventType] || eventType,
            agent_id: data.agent_id || 'Unknown',
            timestamp: Date.now()
        };

        // Add to beginning of array
        window.dashboardTronEvents.unshift(event);

        // Keep only last 20 events
        if (window.dashboardTronEvents.length > 20) {
            window.dashboardTronEvents.pop();
        }

        // Render events list
        const eventsList = document.getElementById('tron-events-list');
        if (window.dashboardTronEvents.length === 0) {
            eventsList.innerHTML = '<p style="color: #9ca3af; font-size: 0.875rem;">No TRON events yet</p>';
        } else {
            eventsList.innerHTML = window.dashboardTronEvents.map(evt => {
                const timeAgo = formatTimeAgo(evt.timestamp);
                return `
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 3px solid #ff6c00;">
                        <span style="font-size: 1.25rem;">${evt.icon}</span>
                        <div style="flex: 1;">
                            <div style="color: #fff; font-weight: 600; font-size: 0.875rem;">${evt.label}: ${evt.agent_id}</div>
                            <div style="color: #9ca3af; font-size: 0.75rem;">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Save updated stats to localStorage
        saveTronStats();
    }

    // Format timestamp to "5m ago", "2h ago", etc.
    function formatTimeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }

    // Reset TRON statistics
    function resetTronStats() {
        if (!confirm('Are you sure you want to reset all TRON statistics? This will clear all counters and event history.')) {
            return;
        }

        // Reset counters
        window.dashboardTronCounts = {
            timeouts: 0,
            restarts: 0,
            escalations: 0,
            failures: 0
        };

        // Reset events list
        window.dashboardTronEvents = [];

        // Update UI
        document.getElementById('tron-timeouts').textContent = '0';
        document.getElementById('tron-restarts').textContent = '0';
        document.getElementById('tron-escalations').textContent = '0';
        document.getElementById('tron-failures').textContent = '0';
        document.getElementById('tron-badge').textContent = '0 events';

        // Clear events list
        const eventsList = document.getElementById('tron-events-list');
        eventsList.innerHTML = '<p style="color: #9ca3af; font-size: 0.875rem;">No TRON events yet</p>';

        // Save to localStorage
        saveTronStats();

        console.log('TRON statistics reset');
    }

    // Reset Programmer Pool statistics
    function resetPoolStats() {
        if (!confirm('Are you sure you want to reset Programmer Pool statistics? This action cannot be undone.')) {
            return;
        }

        // Note: Pool stats come from the backend API, so we can only reset the display
        // The actual backend stats will be updated on the next API call
        document.getElementById('pool-total').textContent = '-';
        document.getElementById('pool-available').textContent = '-';
        document.getElementById('pool-busy').textContent = '-';
        document.getElementById('pool-completed').textContent = '-';
        document.getElementById('pool-success-rate').textContent = 'Success rate: -%';
        document.getElementById('pool-badge').textContent = '-';

        // Clear programmer cards
        const programmersContainer = document.getElementById('programmers-container');
        programmersContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading programmers...</p></div>';

        console.log('Programmer Pool statistics display reset - will update on next API refresh');
    }

    // Save TRON stats to localStorage
    function saveTronStats() {
        try {
            localStorage.setItem('dashboardTronCounts', JSON.stringify(window.dashboardTronCounts));
            localStorage.setItem('dashboardTronEvents', JSON.stringify(window.dashboardTronEvents));
        } catch (e) {
            console.error('Failed to save TRON stats to localStorage:', e);
        }
    }

    // Load TRON stats from localStorage
    function loadTronStats() {
        try {
            const savedCounts = localStorage.getItem('dashboardTronCounts');
            const savedEvents = localStorage.getItem('dashboardTronEvents');

            if (savedCounts) {
                window.dashboardTronCounts = JSON.parse(savedCounts);
                document.getElementById('tron-timeouts').textContent = window.dashboardTronCounts.timeouts;
                document.getElementById('tron-restarts').textContent = window.dashboardTronCounts.restarts;
                document.getElementById('tron-escalations').textContent = window.dashboardTronCounts.escalations;
                document.getElementById('tron-failures').textContent = window.dashboardTronCounts.failures;

                const totalEvents = Object.values(window.dashboardTronCounts).reduce((sum, val) => sum + val, 0);
                document.getElementById('tron-badge').textContent = `${totalEvents} event${totalEvents !== 1 ? 's' : ''}`;
            }

            if (savedEvents) {
                window.dashboardTronEvents = JSON.parse(savedEvents);

                // Render events list
                const eventsList = document.getElementById('tron-events-list');
                if (window.dashboardTronEvents.length === 0) {
                    eventsList.innerHTML = '<p style="color: #9ca3af; font-size: 0.875rem;">No TRON events yet</p>';
                } else {
                    eventsList.innerHTML = window.dashboardTronEvents.map(evt => {
                        const timeAgo = formatTimeAgo(evt.timestamp);
                        return `
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 3px solid #ff6c00;">
                                <span style="font-size: 1.25rem;">${evt.icon}</span>
                                <div style="flex: 1;">
                                    <div style="color: #fff; font-weight: 600; font-size: 0.875rem;">${evt.label}: ${evt.agent_id}</div>
                                    <div style="color: #9ca3af; font-size: 0.75rem;">${timeAgo}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        } catch (e) {
            console.error('Failed to load TRON stats from localStorage:', e);
        }
    }

    function updateServiceCard(data) {
        // Update individual service card if it exists
        const card = document.querySelector(`[data-service-id="${data.service_id}"]`);
        if (card) {
            const statusDot = card.querySelector('.service-status');
            if (statusDot) {
                statusDot.classList.add('healthy');
                statusDot.classList.remove('unhealthy');
            }

            const lastUpdate = card.querySelector('.last-update');
            if (lastUpdate) {
                lastUpdate.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            }
        }

        // Refresh metrics
        fetchMetrics();
    }

    function updateServiceStatus(data) {
        console.log('Status update:', data);
        fetchMetrics();
    }

    function showAlert(data) {
        const alertsContainer = document.getElementById('alerts-container');

        const severity = data.severity || 'warning';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert-banner ${severity}`;
        alertDiv.innerHTML = `
            <div class="alert-icon">${severity === 'error' ? 'üî¥' : '‚ö†Ô∏è'}</div>
            <div class="alert-content">
                <div class="alert-title">${data.alert_type || 'Alert'}</div>
                <div class="alert-message">${data.message}</div>
            </div>
        `;

        alertsContainer.appendChild(alertDiv);

        // Auto-remove after 10 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 10000);
    }

    async function fetchMetrics() {
        try {
            const response = await fetch('/api/metrics');
            const data = await response.json();

            // Update metrics
            const registry = data.services.registry || {};
            const eventStream = data.services.event_stream || {};
            const summary = data.summary || {};

            document.getElementById('total-services').textContent = registry.registered || 0;
            document.getElementById('healthy-services').textContent = registry.healthy || 0;
            document.getElementById('connected-clients').textContent = eventStream.connected_clients || 0;
            document.getElementById('system-health').textContent = summary.health_percentage
                ? `${Math.round(summary.health_percentage)}%`
                : '-';

            // Update system uptime
            if (summary.uptime_seconds !== undefined) {
                const uptimeSeconds = summary.uptime_seconds;
                const days = Math.floor(uptimeSeconds / 86400);
                const hours = Math.floor((uptimeSeconds % 86400) / 3600);
                const minutes = Math.floor((uptimeSeconds % 3600) / 60);

                let uptimeText = '';
                if (days > 0) {
                    uptimeText = `${days}d ${hours}h ${minutes}m`;
                } else if (hours > 0) {
                    uptimeText = `${hours}h ${minutes}m`;
                } else {
                    uptimeText = `${minutes}m`;
                }

                document.getElementById('system-uptime').textContent = uptimeText;

                // Format restart time
                if (summary.server_start_time) {
                    const startDate = new Date(summary.server_start_time * 1000);
                    const timeStr = startDate.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    document.getElementById('system-uptime-since').textContent = `Last restart: ${timeStr}`;
                }
            } else {
                document.getElementById('system-uptime').textContent = '-';
                document.getElementById('system-uptime-since').textContent = 'Last restart: -';
            }

            // Update system health badge
            const healthBadge = document.getElementById('system-health-badge');
            if (summary.health_percentage >= 80) {
                healthBadge.textContent = `${Math.round(summary.health_percentage)}% Healthy`;
                healthBadge.style.background = 'rgba(16, 185, 129, 0.2)';
                healthBadge.style.borderColor = '#10b981';
                healthBadge.style.color = '#10b981';
            } else if (summary.health_percentage >= 50) {
                healthBadge.textContent = `${Math.round(summary.health_percentage)}% Warning`;
                healthBadge.style.background = 'rgba(251, 191, 36, 0.2)';
                healthBadge.style.borderColor = '#fbbf24';
                healthBadge.style.color = '#fbbf24';
            } else {
                healthBadge.textContent = `${Math.round(summary.health_percentage)}% Error`;
                healthBadge.style.background = 'rgba(239, 68, 68, 0.2)';
                healthBadge.style.borderColor = '#ef4444';
                healthBadge.style.color = '#ef4444';
            }

            // Update global status badge
            const globalStatus = document.getElementById('global-status');
            if (summary.health_percentage >= 80) {
                globalStatus.className = 'status-badge ok';
                globalStatus.textContent = 'OK';
            } else if (summary.health_percentage >= 50) {
                globalStatus.className = 'status-badge warning';
                globalStatus.textContent = 'WARNING';
            } else {
                globalStatus.className = 'status-badge error';
                globalStatus.textContent = 'ERROR';
            }

            // Update core services display
            updateCoreServicesDisplay(data.services);

        } catch (error) {
            console.error('Error fetching metrics:', error);
        }
    }

    async function fetchCostMetrics() {
        try {
            const response = await fetch('/api/costs?window=minute');
            const data = await response.json();

            if (!data.cost_metrics) {
                return;
            }

            const costData = data.cost_metrics;

            // Update cost cards
            const totalCost = costData.total_cost_usd || 0;
            document.getElementById('total-cost').textContent =
                `$${totalCost.toFixed(4)}`;
            document.getElementById('total-requests').textContent =
                costData.total_requests || 0;
            document.getElementById('total-tokens').textContent =
                (costData.total_tokens || 0).toLocaleString();
            document.getElementById('avg-cost').textContent =
                `$${(costData.cost_per_request || 0).toFixed(4)}`;

            // Update cost badge in header
            document.getElementById('cost-badge').textContent = `$${totalCost.toFixed(4)}`;

            // Update cost breakdown by provider
            if (costData.cost_per_provider && Object.keys(costData.cost_per_provider).length > 0) {
                const breakdown = document.getElementById('cost-breakdown');
                breakdown.innerHTML = Object.entries(costData.cost_per_provider)
                    .map(([provider, cost]) => {
                        const requests = costData.requests_per_provider[provider] || 0;
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #3a4568;">
                                <span style="color: #e0e0e0;">${provider}</span>
                                <span style="color: #10b981; font-weight: 600;">$${cost.toFixed(4)} (${requests} req)</span>
                            </div>
                        `;
                    }).join('');
            } else {
                document.getElementById('cost-breakdown').innerHTML =
                    '<p style="color: #9ca3af;">No cost data available yet</p>';
            }

        } catch (error) {
            console.error('Error fetching cost metrics:', error);
        }
    }

    async function fetchLLMMetrics() {
        try {
            const response = await fetch('/api/llm/stats');
            const data = await response.json();

            if (!data.models || !data.totals) {
                return;
            }

            const totals = data.totals;
            const models = data.models;

            // Update totals
            document.getElementById('llm-total-tokens').textContent =
                (totals.total_tokens || 0).toLocaleString();
            document.getElementById('llm-total-messages').textContent =
                (totals.total_messages || 0).toLocaleString();
            document.getElementById('llm-total-sessions').textContent =
                (totals.total_sessions || 0).toLocaleString();
            document.getElementById('llm-total-cost').textContent =
                `$${(totals.total_cost_usd || 0).toFixed(3)}`;

            // Update badge
            const modelCount = Object.keys(models).length;
            document.getElementById('llm-badge').textContent =
                `${modelCount} model${modelCount !== 1 ? 's' : ''}`;

            // Update per-model breakdown
            const breakdown = document.getElementById('llm-models-breakdown');
            if (modelCount === 0) {
                breakdown.innerHTML = '<p style="color: #9ca3af;">No LLM usage data available yet</p>';
            } else {
                breakdown.innerHTML = Object.entries(models)
                    .sort((a, b) => b[1].total_tokens - a[1].total_tokens)
                    .map(([modelKey, stats]) => {
                        const costDisplay = stats.total_cost_usd > 0
                            ? `<span style="color: #fbbf24; font-weight: 600; font-size: 0.75rem;">$${stats.total_cost_usd.toFixed(3)}</span>`
                            : '<span style="color: #6b7280; font-size: 0.7rem;">Free</span>';

                        return `
                            <div style="
                                background: rgba(0, 0, 0, 0.3);
                                padding: 0.5rem 0.75rem;
                                border-radius: 6px;
                                border-left: 2px solid #3b82f6;
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                gap: 1rem;
                            ">
                                <div style="flex: 0 0 auto; min-width: 150px;">
                                    <div style="color: #fff; font-weight: 600; font-size: 0.8rem;">
                                        ${stats.model_name}
                                    </div>
                                    <div style="color: #9ca3af; font-size: 0.65rem;">
                                        ${stats.provider}
                                    </div>
                                </div>
                                <div style="flex: 1; display: flex; gap: 1.5rem; font-size: 0.7rem;">
                                    <div style="text-align: center;">
                                        <div style="color: #6b7280;">Tokens</div>
                                        <div style="color: #e0e0e0; font-weight: 600;">${stats.total_tokens.toLocaleString()}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="color: #6b7280;">In</div>
                                        <div style="color: #10b981; font-weight: 600;">${stats.input_tokens.toLocaleString()}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="color: #6b7280;">Out</div>
                                        <div style="color: #3b82f6; font-weight: 600;">${stats.output_tokens.toLocaleString()}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="color: #6b7280;">Msgs</div>
                                        <div style="color: #e0e0e0; font-weight: 600;">${stats.message_count}</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="color: #6b7280;">Sessions</div>
                                        <div style="color: #e0e0e0; font-weight: 600;">${stats.session_count}</div>
                                    </div>
                                </div>
                                <div style="flex: 0 0 auto; text-align: right; min-width: 50px;">
                                    ${costDisplay}
                                </div>
                            </div>
                        `;
                    }).join('');
            }

        } catch (error) {
            console.error('Error fetching LLM metrics:', error);
        }
    }

    // Reset LLM statistics (WARNING: This clears the chat database!)
    function resetLLMStats() {
        if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL chat history and LLM statistics from the database.\n\nThis action CANNOT be undone.\n\nAre you absolutely sure you want to continue?')) {
            return;
        }

        // Second confirmation for safety
        if (!confirm('This is your last chance to cancel.\n\nClick OK to permanently delete all LLM data.')) {
            return;
        }

        // TODO: Implement backend endpoint to clear chat database
        // For now, just reset the display
        document.getElementById('llm-total-tokens').textContent = '0';
        document.getElementById('llm-total-messages').textContent = '0';
        document.getElementById('llm-total-sessions').textContent = '0';
        document.getElementById('llm-total-cost').textContent = '$0.000';
        document.getElementById('llm-badge').textContent = '0 models';
        document.getElementById('llm-models-breakdown').innerHTML =
            '<p style="color: #9ca3af;">No LLM usage data available yet</p>';

        console.log('LLM statistics reset (UI only - backend endpoint needed)');
        alert('‚ö†Ô∏è UI reset complete.\n\nNote: Backend database clearing needs to be implemented.');
    }

    function updateCoreServicesDisplay(services) {
        const container = document.getElementById('services-container');

        const coreServices = [
            { name: 'Registry', key: 'registry', port: 6121 },
            { name: 'Heartbeat Monitor', key: 'heartbeat_monitor', port: 6109 },
            { name: 'Resource Manager', key: 'resource_manager', port: 6104 },
            { name: 'Token Governor', key: 'token_governor', port: 6105 },
            { name: 'Event Stream', key: 'event_stream', port: 6102 }
        ];

        container.innerHTML = coreServices.map(svc => {
            const serviceData = services[svc.key] || {};
            const isHealthy = serviceData.status === 'ok';

            return `
                <div class="service-card" data-service-key="${svc.key}">
                    <div class="service-header">
                        <div class="service-name">${svc.name}</div>
                        <div class="service-status ${isHealthy ? 'healthy' : 'unhealthy'}"></div>
                    </div>
                    <div class="service-info">
                        <div class="service-info-row">
                            <span class="service-info-label">Port:</span>
                            <span class="service-info-value">${svc.port}</span>
                        </div>
                        <div class="service-info-row">
                            <span class="service-info-label">Status:</span>
                            <span class="service-info-value">${serviceData.status || 'unknown'}</span>
                        </div>
                        ${svc.key === 'registry' ? `
                        <div class="service-info-row">
                            <span class="service-info-label">Registered:</span>
                            <span class="service-info-value">${serviceData.registered || 0}</span>
                        </div>
                        ` : ''}
                        ${svc.key === 'event_stream' ? `
                        <div class="service-info-row">
                            <span class="service-info-label">Clients:</span>
                            <span class="service-info-value">${serviceData.connected_clients || 0}</span>
                        </div>
                        ` : ''}
                        ${serviceData.total_events !== undefined ? `
                        <div class="service-info-row">
                            <span class="service-info-label">Events:</span>
                            <span class="service-info-value">${serviceData.total_events || 0}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="last-update">Last check: ${new Date().toLocaleTimeString()}</div>
                </div>
            `;
        }).join('');
    }

    async function fetchAgents() {
        try {
            const response = await fetch('/api/services');
            const data = await response.json();
            const agents = data.services || [];

            const container = document.getElementById('agents-container');

            // Update agents badge count from metrics (includes historical agents from action logs)
            try {
                const metricsResp = await fetch('/api/metrics');
                const metricsData = await metricsResp.json();
                const totalAgents = metricsData.summary?.total_agents || agents.length;
                document.getElementById('agents-badge').textContent = totalAgents;
            } catch {
                document.getElementById('agents-badge').textContent = agents.length;
            }

            if (agents.length === 0) {
                container.innerHTML = '<div class="loading"><p>No agents registered yet</p></div>';
                return;
            }

            // Check if showing historical agents from action logs
            const isHistorical = agents.length > 0 && agents[0].from_action_logs;

            if (isHistorical) {
                container.innerHTML = `
                    <div style="background: #1f2937; padding: 12px; margin-bottom: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">‚ÑπÔ∏è</span>
                            <span style="color: #93c5fd; font-size: 14px;">Showing historical agents from action logs (no live services registered)</span>
                        </div>
                    </div>
                ` + agents.map(agent => `
                    <div class="service-card" data-service-id="${agent.service_id}">
                        <div class="service-header">
                            <div class="service-name">${agent.name}</div>
                            <div class="service-status" style="background: #6b7280;" title="Historical"></div>
                        </div>
                        <div class="service-info">
                            <div class="service-info-row">
                                <span class="service-info-label">Type:</span>
                                <span class="service-info-value">Historical</span>
                            </div>
                            <div class="service-info-row">
                                <span class="service-info-label">Tier:</span>
                                <span class="service-info-value">Tier ${agent.tier || '?'}</span>
                            </div>
                            <div class="service-info-row">
                                <span class="service-info-label">Last Seen:</span>
                                <span class="service-info-value">${new Date(agent.last_seen).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                // Group agents by role
                const grouped = {
                    core: [],
                    architect: [],
                    directors: [],
                    managers: [],
                    programmers: [],
                    other: []
                };

                agents.forEach(agent => {
                    const role = (agent.labels?.agent_role || '').toLowerCase();
                    const name = (agent.name || '').toLowerCase();

                    if (role === 'architect' || name.includes('architect')) {
                        grouped.architect.push(agent);
                    } else if (role === 'director' || name.includes('director') || name.includes('dir-')) {
                        grouped.directors.push(agent);
                    } else if (role === 'manager' || name.includes('manager') || name.includes('mgr-')) {
                        grouped.managers.push(agent);
                    } else if (role === 'programmer' || name.includes('programmer') || name.includes('prog-')) {
                        grouped.programmers.push(agent);
                    } else if (name.includes('gateway') || name.includes('pas root') || name.includes('registry')) {
                        grouped.core.push(agent);
                    } else {
                        grouped.other.push(agent);
                    }
                });

                // Retrieve collapsed state from localStorage
                const collapsedGroups = JSON.parse(localStorage.getItem('collapsedAgentGroups') || '[]');

                const renderAgentCard = (agent) => `
                    <div class="service-card" data-service-id="${agent.service_id}">
                        <div class="service-header">
                            <div class="service-name">${agent.name}</div>
                            <div class="service-status ${agent.status === 'ok' ? 'healthy' : 'unhealthy'}"></div>
                        </div>
                        <div class="service-info">
                            <div class="service-info-row">
                                <span class="service-info-label">Type:</span>
                                <span class="service-info-value">${agent.labels?.agent_role || 'unknown'}</span>
                            </div>
                            <div class="service-info-row">
                                <span class="service-info-label">Tier:</span>
                                <span class="service-info-value">Tier ${agent.labels?.tier || '?'}</span>
                            </div>
                            <div class="service-info-row">
                                <span class="service-info-label">Capabilities:</span>
                                <span class="service-info-value">${agent.caps?.length || 0} caps</span>
                            </div>
                        </div>
                        <div class="last-update">Last heartbeat: ${agent.last_heartbeat_ts ? new Date(agent.last_heartbeat_ts * 1000).toLocaleTimeString() : 'Never'}</div>
                    </div>
                `;

                const renderGroup = (groupId, groupName, groupIcon, agentsList) => {
                    if (agentsList.length === 0) return '';

                    const isCollapsed = collapsedGroups.includes(groupId);
                    const healthyCount = agentsList.filter(a => a.status === 'ok').length;
                    const healthPercent = Math.round((healthyCount / agentsList.length) * 100);

                    return `
                        <div style="margin-bottom: 1rem; background: #1e293b; border: 1px solid #4a5578; border-radius: 8px; overflow: hidden;">
                            <div onclick="toggleAgentGroup('${groupId}')" style="
                                padding: 0.75rem 1rem;
                                background: #2d3748;
                                cursor: pointer;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                user-select: none;
                            ">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1rem;">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
                                    <span style="font-size: 1.25rem;">${groupIcon}</span>
                                    <span style="font-weight: 600; font-size: 0.875rem;">${groupName}</span>
                                    <span style="font-size: 0.75rem; color: #9ca3af;">(${agentsList.length})</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="font-size: 0.75rem;">
                                        <span style="color: #10b981;">‚úì ${healthyCount}</span>
                                        ${agentsList.length - healthyCount > 0 ? `<span style="color: #ef4444;"> ‚úó ${agentsList.length - healthyCount}</span>` : ''}
                                    </div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: ${healthPercent === 100 ? '#10b981' : healthPercent >= 70 ? '#f59e0b' : '#ef4444'};">
                                        ${healthPercent}%
                                    </div>
                                </div>
                            </div>
                            ${!isCollapsed ? `
                                <div class="service-cards" style="padding: 0.75rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                                    ${agentsList.map(renderAgentCard).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                };

                container.innerHTML =
                    renderGroup('core', 'Core Services', 'üè¢', grouped.core) +
                    renderGroup('architect', 'Architect', 'üèóÔ∏è', grouped.architect) +
                    renderGroup('directors', 'Directors', 'üéØ', grouped.directors) +
                    renderGroup('managers', 'Managers', 'üìã', grouped.managers) +
                    renderGroup('programmers', 'Programmers', 'üíª', grouped.programmers) +
                    renderGroup('other', 'Other Services', 'üîß', grouped.other);
            }

        } catch (error) {
            console.error('Error fetching agents:', error);
        }
    }

    // Initialize dashboard
    // Apply settings to dashboard view
    function applyViewSettings(settings) {
        console.log('Applying dashboard settings:', settings);

        // Clear existing auto-refresh timer
        if (metricsUpdateInterval) {
            clearInterval(metricsUpdateInterval);
            metricsUpdateInterval = null;
        }

        // Setup auto-refresh if enabled
        if (settings.autoRefreshEnabled) {
            // 0 = instant/fast (use 500ms minimum), otherwise use specified interval
            const intervalMs = settings.refreshInterval === 0
                ? 500
                : settings.refreshInterval * 1000;

            console.log('Setting up auto-refresh every',
                settings.refreshInterval === 0 ? '0.5 seconds (instant/fast)' : `${settings.refreshInterval} seconds`);

            metricsUpdateInterval = setInterval(() => {
                fetchMetrics();
                fetchAgents();
                fetchCostMetrics();
                fetchLLMMetrics();
                fetchProgrammerPool();
            }, intervalMs);
        } else {
            console.log('Auto-refresh disabled');
        }
    }

    // Fetch Programmer Pool Status
    async function fetchProgrammerPool() {
        try {
            const response = await fetch('/api/programmer-pool/status');
            const data = await response.json();

            if (data.status === 'ok') {
                const stats = data.stats;
                const programmers = data.programmers;

                // Update pool stats
                document.getElementById('pool-total').textContent = stats.total_programmers;
                document.getElementById('pool-available').textContent = stats.available;
                document.getElementById('pool-busy').textContent = stats.busy;
                document.getElementById('pool-completed').textContent = stats.total_tasks_completed;
                document.getElementById('pool-success-rate').textContent =
                    `Success rate: ${(stats.success_rate * 100).toFixed(1)}%`;
                document.getElementById('pool-badge').textContent =
                    `${stats.idle} idle / ${stats.busy} busy`;

                // Render programmer cards
                renderProgrammers(programmers);
            }
        } catch (error) {
            console.error('Failed to fetch programmer pool:', error);
            document.getElementById('programmers-container').innerHTML = `
                <div class="alert-banner" style="grid-column: 1 / -1;">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-content">
                        <div class="alert-title">Failed to load Programmer Pool</div>
                        <div class="alert-message">${error.message}</div>
                    </div>
                </div>
            `;
        }
    }

    function renderProgrammers(programmers) {
        const container = document.getElementById('programmers-container');

        if (programmers.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #9ca3af;">
                    <p>No Programmers discovered</p>
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">Make sure Programmer services are running on ports 6151-6160</p>
                </div>
            `;
            return;
        }

        container.innerHTML = programmers.map(prog => {
            const stateColors = {
                'idle': '#10b981',
                'busy': '#f59e0b',
                'failed': '#ef4444',
                'unknown': '#6b7280'
            };
            const stateColor = stateColors[prog.state] || '#6b7280';
            const stateIcons = {
                'idle': '‚úì',
                'busy': '‚ü≥',
                'failed': '‚úó',
                'unknown': '?'
            };
            const stateIcon = stateIcons[prog.state] || '?';

            return `
                <div class="service-card" style="background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div class="service-name">${prog.agent_id}</div>
                        <div class="status-badge" style="background: ${stateColor}; border-color: ${stateColor};">
                            ${stateIcon} ${prog.state.toUpperCase()}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.75rem; color: #9ca3af;">
                        <div>
                            <div style="color: #6b7280;">Port</div>
                            <div style="color: #e0e0e0; font-weight: 600;">${prog.port}</div>
                        </div>
                        <div>
                            <div style="color: #6b7280;">Current Tasks</div>
                            <div style="color: #e0e0e0; font-weight: 600;">${prog.current_tasks}</div>
                        </div>
                        <div>
                            <div style="color: #6b7280;">Completed</div>
                            <div style="color: #10b981; font-weight: 600;">${prog.total_completed}</div>
                        </div>
                        <div>
                            <div style="color: #6b7280;">Failures</div>
                            <div style="color: ${prog.total_failures > 0 ? '#ef4444' : '#6b7280'}; font-weight: 600;">${prog.total_failures}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Drag and Drop functionality for section reordering
    let draggedSection = null;

    function initializeDragAndDrop() {
        const sections = document.querySelectorAll('.section-container');

        sections.forEach(section => {
            section.addEventListener('dragstart', (e) => {
                draggedSection = section;
                section.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', section.innerHTML);
            });

            section.addEventListener('dragend', (e) => {
                section.classList.remove('dragging');
                // Remove all drag-over classes
                document.querySelectorAll('.section-container').forEach(s => {
                    s.classList.remove('drag-over');
                });
                draggedSection = null;

                // Save new order
                saveSectionOrder();
            });

            section.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                const afterElement = getDragAfterElement(e.clientY);
                if (afterElement == null) {
                    section.parentElement.appendChild(draggedSection);
                } else {
                    section.parentElement.insertBefore(draggedSection, afterElement);
                }
            });

            section.addEventListener('dragenter', (e) => {
                if (draggedSection !== section) {
                    section.classList.add('drag-over');
                }
            });

            section.addEventListener('dragleave', (e) => {
                section.classList.remove('drag-over');
            });

            section.addEventListener('drop', (e) => {
                e.stopPropagation();
                section.classList.remove('drag-over');
                return false;
            });
        });
    }

    function getDragAfterElement(y) {
        const draggableElements = [...document.querySelectorAll('.section-container:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Save section order to localStorage
    function saveSectionOrder() {
        const order = [];
        document.querySelectorAll('.section-container').forEach(section => {
            const sectionId = section.getAttribute('data-section-id');
            if (sectionId) {
                order.push(sectionId);
            }
        });
        localStorage.setItem('dashboardSectionOrder', JSON.stringify(order));
    }

    // Load section order from localStorage and reorder
    function loadSectionOrder() {
        const savedOrder = JSON.parse(localStorage.getItem('dashboardSectionOrder') || '[]');
        if (savedOrder.length === 0) return;

        const container = document.querySelector('.container');
        const alertsContainer = document.getElementById('alerts-container');

        // Get all sections
        const sections = {};
        document.querySelectorAll('.section-container').forEach(section => {
            const sectionId = section.getAttribute('data-section-id');
            if (sectionId) {
                sections[sectionId] = section;
            }
        });

        // Reorder based on saved order
        savedOrder.forEach(sectionId => {
            if (sections[sectionId]) {
                container.appendChild(sections[sectionId]);
            }
        });

        // Append any sections not in saved order (new sections)
        Object.entries(sections).forEach(([sectionId, section]) => {
            if (!savedOrder.includes(sectionId)) {
                container.appendChild(section);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Load saved section order
        loadSectionOrder();

        // Load saved collapsed state
        loadCollapsedSections();

        // Load saved TRON stats
        loadTronStats();

        // Initialize drag and drop
        initializeDragAndDrop();

        // Initial fetch
        fetchMetrics();
        fetchAgents();
        fetchCostMetrics();
        fetchLLMMetrics();
        fetchProgrammerPool();

        // Settings will be loaded by base.html, which will call applyViewSettings()
        // Default auto-refresh (will be overridden by settings)
        setTimeout(() => {
            const settings = getSettings();
            applyViewSettings(settings);
        }, 100);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (metricsUpdateInterval) {
            clearInterval(metricsUpdateInterval);
        }
    });
</script>
{% endblock %}
