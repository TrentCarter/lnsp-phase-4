<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PAS Agent Swarm HMI{% endblock %}</title>

    <!-- D3.js for tree visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Chart.js for metrics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hmi.css') }}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0a0e27;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            padding: 1rem 2rem;
            border-bottom: 2px solid #4a5578;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.ok {
            background-color: #10b981;
            color: white;
        }

        .status-badge.warning {
            background-color: #f59e0b;
            color: white;
        }

        .status-badge.error {
            background-color: #ef4444;
            color: white;
        }

        /* Task Status Indicator */
        .task-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(30, 39, 71, 0.6);
            border-radius: 8px;
            border: 1px solid #3a4568;
            max-width: 350px;
        }

        .task-status-led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.3);
            flex-shrink: 0;
        }

        .task-status-led.running {
            background-color: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
            animation: pulse-led 2s ease-in-out infinite;
        }

        .task-status-led.done {
            background-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        .task-status-led.error {
            background-color: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
            animation: pulse-led 1s ease-in-out infinite;
        }

        .task-status-led.waiting {
            background-color: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
        }

        .task-status-led.idle {
            background-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.3);
        }

        @keyframes pulse-led {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .task-status-text {
            display: flex;
            flex-direction: column;
            min-width: 0;
            flex: 1;
        }

        .task-status-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-status-label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav {
            display: flex;
            gap: 1rem;
        }

        .nav a {
            color: #a0aec0;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav a:hover, .nav a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .settings-button {
            background: transparent;
            border: 1px solid #4a5578;
            color: #a0aec0;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .settings-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: #6b7280;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%);
            border: 1px solid #3a4568;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .metric-card h3 {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
        }

        .metric-card .subtext {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .alert-banner {
            background-color: #7c2d12;
            border: 1px solid #dc2626;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-banner.warning {
            background-color: #713f12;
            border-color: #f59e0b;
        }

        .alert-banner.info {
            background-color: #1e3a8a;
            border-color: #3b82f6;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            font-size: 0.875rem;
            color: #d1d5db;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6b7280;
        }

        .connection-dot.connected {
            background-color: #10b981;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%);
            border: 2px solid #4a5578;
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            display: flex;
            overflow: hidden;
        }

        .settings-sidebar {
            width: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid #4a5578;
            padding: 1rem 0 0 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar-item {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            color: #9ca3af;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .settings-sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
        }

        .settings-sidebar-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border-left-color: #3b82f6;
            font-weight: 500;
        }

        .settings-main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .settings-page {
            display: none;
        }

        .settings-page.active {
            display: block;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #4a5578;
        }

        .settings-header h2 {
            color: #fff;
            font-size: 1.5rem;
        }

        .close-button {
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .settings-section {
            margin-bottom: 1.5rem;
        }

        .settings-section h3 {
            color: #e0e0e0;
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #3a4568;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: #d1d5db;
            font-size: 0.875rem;
        }

        .setting-description {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-input {
            background-color: #1a1f3a;
            border: 1px solid #4a5578;
            color: #e0e0e0;
            padding: 0.5rem;
            border-radius: 6px;
            width: 80px;
            text-align: center;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background-color: #4a5578;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .toggle-switch.active {
            background-color: #10b981;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .setting-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .setting-button.danger {
            background-color: #ef4444;
        }

        .setting-button.danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }

        .setting-button.warning {
            background-color: #f59e0b;
        }

        .setting-button.warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
        }

        .settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #4a5578;
        }

        .settings-button-primary {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .settings-button-primary:hover {
            background-color: #2563eb;
        }

        .settings-button-secondary {
            background-color: transparent;
            color: #9ca3af;
            border: 1px solid #4a5578;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .settings-button-secondary:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
        }
    </style>

    {% block extra_styles %}{% endblock %}
</head>
<body>
    <header class="header">
        <h1>
            <span>ü§ñ</span>
            PAS Agent Swarm
            <span id="global-status" class="status-badge ok">OK</span>
        </h1>

        <!-- Task Status Indicator -->
        <div id="task-status" class="task-status" style="display: none;">
            <div id="task-status-led" class="task-status-led idle"></div>
            <div class="task-status-text">
                <div id="task-status-name" class="task-status-name">No active task</div>
                <div id="task-status-label" class="task-status-label">IDLE</div>
            </div>
        </div>

        <nav class="nav">
            <a href="/" {% if request.path == '/' %}class="active"{% endif %}>Dashboard</a>
            <a href="/tree" {% if request.path == '/tree' %}class="active"{% endif %}>Tree View</a>
            <a href="/sequencer" {% if request.path == '/sequencer' %}class="active"{% endif %}>Sequencer</a>
            <a href="/actions" {% if request.path == '/actions' %}class="active"{% endif %}>Actions</a>
            <button id="start-demo-button" class="settings-button" onclick="startDemo()" style="background: #10b981;">‚ñ∂Ô∏è Start Demo</button>
            <button id="prime-directive-button" class="settings-button" onclick="startPrimeDirective()" style="background: #3b82f6;" title="Send real Prime Directive to PAS Root">üöÄ Prime Directive</button>
            <button id="stop-demo-button" class="settings-button" onclick="stopDemo()" style="background: #ef4444; display: none;">‚èπÔ∏è Stop Demo</button>
            <button id="master-stop-button" class="settings-button" onclick="masterStopDemo()" style="background: #dc2626; display: none; font-weight: bold; border: 2px solid #fbbf24;" title="EMERGENCY: Force kill ALL demo processes immediately">üõë MASTER STOP</button>
            <button class="settings-button" onclick="clearAllData()" style="background: #ef4444;">üóëÔ∏è Clear All Data</button>
            <button id="audio-init-button" class="settings-button" onclick="initAudioManual()" style="display: none;">üîä Enable Sound</button>
            <button class="settings-button" onclick="openSettings()">‚öôÔ∏è Settings</button>
        </nav>
        <div class="connection-status">
            <div id="connection-dot" class="connection-dot"></div>
            <span id="connection-text">Connecting...</span>
        </div>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <!-- Sidebar Navigation -->
            <div class="settings-sidebar">
                <div class="settings-sidebar-item active" onclick="switchSettingsPage('general')">
                    <span>üè†</span>
                    <span>General</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('display')">
                    <span>üé®</span>
                    <span>Display</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('tree')">
                    <span>üå≥</span>
                    <span>Tree View</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('sequencer')">
                    <span>üéπ</span>
                    <span>Sequencer</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('audio')">
                    <span>üîä</span>
                    <span>Audio</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('llm')">
                    <span>ü§ñ</span>
                    <span>LLM Models</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('advanced')">
                    <span>‚öôÔ∏è</span>
                    <span>Advanced</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('system')">
                    <span>üõ†Ô∏è</span>
                    <span>System</span>
                </div>

                <!-- Save Button at Bottom -->
                <div style="padding: 1.25rem; margin-top: auto; border-top: 1px solid #4a5578;">
                    <button onclick="saveSettings()" style="width: 100%; padding: 0.75rem; font-size: 0.875rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üíæ Save Changes</button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="settings-main">
                <div class="settings-header">
                    <h2 id="settings-page-title">‚öôÔ∏è General</h2>
                    <button class="close-button" onclick="closeSettings()">‚úï</button>
                </div>

                <!-- General Page -->
                <div id="page-general" class="settings-page active">
                    <!-- Auto-Refresh Settings -->
                    <div class="settings-section">
                <h3>üîÑ Auto-Refresh</h3>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Enable Auto-Refresh</div>
                        <div class="setting-description">Automatically update data without manual refresh</div>
                    </div>
                    <div class="setting-control">
                        <div id="auto-refresh-toggle" class="toggle-switch" onclick="toggleAutoRefresh()"></div>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Refresh Interval</div>
                        <div class="setting-description">Time between auto-refreshes (0 = instant/fast, seconds)</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="refresh-interval" class="setting-input" min="0" max="600" value="0">
                        <span style="color: #9ca3af; font-size: 0.875rem;">sec</span>
                    </div>
                </div>
            </div>

                    <!-- Performance Settings -->
                    <div class="settings-section">
                        <h3>‚ö° Performance</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Animation Duration</div>
                                <div class="setting-description">Transition speed for visual updates (milliseconds)</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="animation-duration" class="setting-input" min="0" max="2000" step="100" value="750">
                                <span style="color: #9ca3af; font-size: 0.875rem;">ms</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Display Page -->
                <div id="page-display" class="settings-page">
                    <div class="settings-section">
                        <h3>üé® Display</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Show Tooltips</div>
                                <div class="setting-description">Display detailed information on hover</div>
                            </div>
                            <div class="setting-control">
                                <div id="tooltips-toggle" class="toggle-switch active" onclick="toggleTooltips()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Compact Mode</div>
                                <div class="setting-description">Reduce spacing for more information density</div>
                            </div>
                            <div class="setting-control">
                                <div id="compact-toggle" class="toggle-switch" onclick="toggleCompactMode()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Time Zone</div>
                                <div class="setting-description">Display time zone for timestamps</div>
                            </div>
                            <div class="setting-control">
                                <select id="timezone-select" class="setting-input" style="width: 140px;">
                                    <option value="America/New_York">EST (US Eastern)</option>
                                    <option value="America/Chicago">CST (US Central)</option>
                                    <option value="America/Denver">MST (US Mountain)</option>
                                    <option value="America/Los_Angeles">PST (US Pacific)</option>
                                    <option value="UTC">UTC</option>
                                    <option value="Europe/London">GMT (London)</option>
                                    <option value="Asia/Tokyo">JST (Tokyo)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tree View Page -->
                <div id="page-tree" class="settings-page">
                    <!-- Tree View Settings -->
                    <div class="settings-section">
                        <h3>üå≥ Tree View</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Tree Orientation</div>
                                <div class="setting-description">Default layout orientation for tree visualization</div>
                            </div>
                            <div class="setting-control">
                                <select id="tree-orientation" class="setting-input" style="width: 140px;">
                                    <option value="top" selected>Top</option>
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                    <option value="bottom">Bottom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sequencer Page -->
                <div id="page-sequencer" class="settings-page">
            <!-- Sequencer Settings -->
            <div class="settings-section">
                <h3>üéπ Sequencer</h3>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Hide Scrollbars</div>
                        <div class="setting-description">Use draggable playhead instead of scrollbars</div>
                    </div>
                    <div class="setting-control">
                        <div id="hide-scrollbars-toggle" class="toggle-switch active" onclick="toggleHideScrollbars()"></div>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Default Playback Speed</div>
                        <div class="setting-description">Initial playback speed multiplier</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="default-playback-speed" class="setting-input" min="0.1" max="1000" step="0.1" value="1.0">
                        <span style="color: #9ca3af; font-size: 0.875rem;">x (0.1x-1000x range)</span>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Default Sound Mode</div>
                        <div class="setting-description">Default sound output mode</div>
                    </div>
                    <div class="setting-control">
                        <select id="default-sound-mode" class="setting-input" style="width: 140px;">
                            <option value="none" selected>None</option>
                            <option value="voice">Voice</option>
                            <option value="music">Music Note</option>
                            <option value="random">Random Sounds</option>
                            <option value="geiger">Geiger Counter</option>
                        </select>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Auto-Detect New Tasks</div>
                        <div class="setting-description">Automatically switch to new tasks and start playback</div>
                    </div>
                    <div class="setting-control">
                        <div id="new-task-poll-toggle" class="toggle-switch active" onclick="toggleNewTaskPoll()"></div>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">New Task Poll Interval</div>
                        <div class="setting-description">How often to check for new tasks (seconds)</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="new-task-poll-interval" class="setting-input" min="1" max="60" value="5">
                        <span style="color: #9ca3af; font-size: 0.875rem;">sec</span>
                    </div>
                    </div>
                </div>
                </div>

                <!-- Audio Page -->
                <div id="page-audio" class="settings-page">
                    <div class="settings-section">
                        <h3>üîä Audio</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Master Audio</div>
                                <div class="setting-description">Enable all sound output</div>
                            </div>
                            <div class="setting-control">
                                <div id="master-audio-toggle" class="toggle-switch" onclick="toggleMasterAudio()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Sequencer Notes</div>
                                <div class="setting-description">Musical notes for task events (assign, start, complete)</div>
                            </div>
                            <div class="setting-control">
                                <div id="sequencer-notes-toggle" class="toggle-switch" onclick="toggleSequencerNotes()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Agent Voice Status</div>
                                <div class="setting-description">Text-to-speech narration of agent updates</div>
                            </div>
                            <div class="setting-control">
                                <div id="agent-voice-toggle" class="toggle-switch" onclick="toggleAgentVoice()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Audio Volume</div>
                                <div class="setting-description">Master volume level (0-100%)</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="audio-volume" class="setting-input" min="0" max="100" value="70" style="width: 120px;">
                                <span id="volume-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">70%</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Note Duration</div>
                                <div class="setting-description">Duration of musical notes in milliseconds (50-500ms)</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="note-duration" class="setting-input" min="50" max="500" value="150" step="10" style="width: 120px;">
                                <span id="note-duration-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 50px;">150ms</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLM Models Page -->
                <div id="page-llm" class="settings-page">
                    <!-- LLM Model Selection Settings -->
                    <div class="settings-section">
                        <h3>ü§ñ LLM Model Selection</h3>

                        <!-- Table Header -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #4a5578;">
                            <div style="color: #e0e0e0; font-weight: 600; font-size: 0.875rem;">Agent Type</div>
                            <div style="color: #e0e0e0; font-weight: 600; font-size: 0.875rem;">Primary Model</div>
                            <div style="color: #e0e0e0; font-weight: 600; font-size: 0.875rem;">Backup Model</div>
                        </div>

                        <!-- Architect Row -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                            <div>
                                <div style="color: #e0e0e0; font-weight: 500;">üèõÔ∏è Architect</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">High-level planning</div>
                            </div>
                            <div>
                                <select id="architect-primary" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                            <div>
                                <select id="architect-fallback" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                        </div>

                        <!-- Director Row -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                            <div>
                                <div style="color: #e0e0e0; font-weight: 500;">üé¨ Director</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">Lane coordination</div>
                            </div>
                            <div>
                                <select id="director-primary" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                            <div>
                                <select id="director-fallback" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                        </div>

                        <!-- Manager Row -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                            <div>
                                <div style="color: #e0e0e0; font-weight: 500;">üìã Manager</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">Task breakdown</div>
                            </div>
                            <div>
                                <select id="manager-primary" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                            <div>
                                <select id="manager-fallback" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                        </div>

                        <!-- Programmer Row -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                            <div>
                                <div style="color: #e0e0e0; font-weight: 500;">üíª Programmer</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">Code execution</div>
                            </div>
                            <div>
                                <select id="programmer-primary" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                            <div>
                                <select id="programmer-fallback" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #4a5578;">
                            <button onclick="saveModelPreferences()" style="padding: 0.5rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem;">üíæ Save Model Preferences</button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Models Page -->
                <div id="page-advanced" class="settings-page">
                    <div class="settings-section">
                        <h3>‚öôÔ∏è Advanced Model Settings</h3>
                        <p style="color: #9ca3af; margin-bottom: 1.5rem;">Configure advanced parameters for LLM inference.</p>

                        <!-- Temperature -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Temperature</div>
                                <div class="setting-description">Controls randomness (0.0-2.0). Lower = more focused, Higher = more creative</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="llm-temperature" class="setting-input" min="0" max="2" step="0.1" value="0.7" style="width: 120px;">
                                <span id="temperature-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">0.7</span>
                            </div>
                        </div>

                        <!-- Max Tokens -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Max Tokens</div>
                                <div class="setting-description">Maximum number of tokens to generate (100-8000)</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="llm-max-tokens" class="setting-input" min="100" max="8000" step="100" value="2000">
                                <span style="color: #9ca3af; font-size: 0.875rem;">tokens</span>
                            </div>
                        </div>

                        <!-- Top P -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Top P (Nucleus Sampling)</div>
                                <div class="setting-description">Controls diversity (0.0-1.0). Lower = more focused</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="llm-top-p" class="setting-input" min="0" max="1" step="0.05" value="0.9" style="width: 120px;">
                                <span id="top-p-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">0.9</span>
                            </div>
                        </div>

                        <!-- Top K -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Top K</div>
                                <div class="setting-description">Limits token choices (1-100). Lower = more focused</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="llm-top-k" class="setting-input" min="1" max="100" value="40">
                                <span style="color: #9ca3af; font-size: 0.875rem;">tokens</span>
                            </div>
                        </div>

                        <!-- Frequency Penalty -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Frequency Penalty</div>
                                <div class="setting-description">Reduces repetition (-2.0 to 2.0). Higher = less repetition</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="llm-frequency-penalty" class="setting-input" min="-2" max="2" step="0.1" value="0" style="width: 120px;">
                                <span id="frequency-penalty-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">0.0</span>
                            </div>
                        </div>

                        <!-- Presence Penalty -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Presence Penalty</div>
                                <div class="setting-description">Encourages new topics (-2.0 to 2.0). Higher = more diverse</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="llm-presence-penalty" class="setting-input" min="-2" max="2" step="0.1" value="0" style="width: 120px;">
                                <span id="presence-penalty-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">0.0</span>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #4a5578;">
                            <button onclick="saveAdvancedModelSettings()" style="padding: 0.5rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem;">üíæ Save Advanced Settings</button>
                        </div>
                    </div>
                </div>

                <!-- System Page -->
                <div id="page-system" class="settings-page">
                    <!-- System Admin Settings -->
                    <div class="settings-section">
                        <h3>üõ†Ô∏è System Administration</h3>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Clear All Data</div>
                        <div class="setting-description">Delete all action logs and service registrations (‚ö†Ô∏è Cannot be undone!)</div>
                    </div>
                    <div class="setting-control">
                        <button class="setting-button danger" onclick="clearAllDataConfirm()">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Restart All Services</div>
                        <div class="setting-description">Complete system restart (P0 Stack, PAS, HMI) - takes ~15 seconds</div>
                    </div>
                    <div class="setting-control">
                        <button class="setting-button warning" onclick="restartHMI()">üîÑ Restart All Services</button>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Reset Settings to Defaults</div>
                        <div class="setting-description">Restore all settings to their default values</div>
                    </div>
                    <div class="setting-control">
                        <button onclick="resetSettings()" style="padding: 0.5rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem;">üîÑ Reset to Defaults</button>
                    </div>
                </div>
                    </div>
                </div>
                </div>

                <!-- End of settings-main -->
            </div>
        </div>
    </div>

    <!-- Base WebSocket connection -->
    <script>
        // Global WebSocket connection
        let socket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        function connectWebSocket() {
            const connectionDot = document.getElementById('connection-dot');
            const connectionText = document.getElementById('connection-text');

            socket = io('http://localhost:6102', {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: MAX_RECONNECT_ATTEMPTS
            });

            socket.on('connect', () => {
                console.log('WebSocket connected');
                connectionDot.classList.add('connected');
                connectionText.textContent = 'Connected';
                reconnectAttempts = 0;
            });

            socket.on('disconnect', () => {
                console.log('WebSocket disconnected');
                connectionDot.classList.remove('connected');
                connectionText.textContent = 'Disconnected';
            });

            socket.on('connected', (data) => {
                console.log('Server acknowledged connection:', data);
            });

            socket.on('event', (event) => {
                console.log('Received event:', event);
                handleRealtimeEvent(event);
            });

            socket.on('event_history', (events) => {
                console.log('Received event history:', events.length, 'events');
                events.forEach(handleRealtimeEvent);
            });

            socket.on('pong', (data) => {
                console.log('Pong received:', data);
            });
        }

        // Override this function in child templates
        function handleRealtimeEvent(event) {
            console.log('Base handler received event:', event.event_type);

            // Update task status on relevant events
            if (['job_started', 'task_started', 'job_completed', 'task_completed', 'heartbeat', 'error', 'blocked'].includes(event.event_type)) {
                fetchCurrentTask();
            }
        }

        // Task Status Management
        let currentTaskTimer = null;

        async function fetchCurrentTask() {
            try {
                const response = await fetch('/api/current-task', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    hideTaskStatus();
                    return;
                }

                const data = await response.json();

                if (data.task) {
                    updateTaskStatus(data.task);
                } else {
                    hideTaskStatus();
                }
            } catch (error) {
                console.error('Error fetching current task:', error);
                hideTaskStatus();
            }
        }

        function updateTaskStatus(task) {
            const statusContainer = document.getElementById('task-status');
            const statusLed = document.getElementById('task-status-led');
            const statusName = document.getElementById('task-status-name');
            const statusLabel = document.getElementById('task-status-label');

            // Show the status indicator
            statusContainer.style.display = 'flex';

            // Update task name
            statusName.textContent = task.name || 'Active Task';

            // Map task status to LED class and label
            const statusMap = {
                'running': { class: 'running', label: 'RUNNING' },
                'blocked': { class: 'waiting', label: 'BLOCKED' },
                'waiting': { class: 'waiting', label: 'WAITING' },
                'awaiting_approval': { class: 'waiting', label: 'AWAITING APPROVAL' },
                'done': { class: 'done', label: 'DONE' },
                'completed': { class: 'done', label: 'COMPLETED' },
                'error': { class: 'error', label: 'ERROR' },
                'failed': { class: 'error', label: 'FAILED' },
                'stuck': { class: 'error', label: 'STUCK' },
                'idle': { class: 'idle', label: 'IDLE' }
            };

            const status = statusMap[task.status] || statusMap['idle'];

            // Update LED class
            statusLed.className = `task-status-led ${status.class}`;

            // Update label
            statusLabel.textContent = status.label;
        }

        function hideTaskStatus() {
            const statusContainer = document.getElementById('task-status');
            statusContainer.style.display = 'none';
        }

        function startTaskStatusPolling() {
            // Poll for current task every 5 seconds
            if (currentTaskTimer) {
                clearInterval(currentTaskTimer);
            }

            fetchCurrentTask(); // Initial fetch

            currentTaskTimer = setInterval(() => {
                fetchCurrentTask();
            }, 5000);
        }

        function stopTaskStatusPolling() {
            if (currentTaskTimer) {
                clearInterval(currentTaskTimer);
                currentTaskTimer = null;
            }
        }

        // Settings Management
        const DEFAULT_SETTINGS = {
            autoRefreshEnabled: true,
            refreshInterval: 0,  // 0 = instant/fast refresh for Dashboard
            showTooltips: true,
            compactMode: false,
            animationDuration: 750,
            masterAudioEnabled: false,
            sequencerNotesEnabled: false,
            agentVoiceEnabled: false,
            audioVolume: 70,
            sequencerNoteDuration: 150,  // milliseconds (50-500)
            timezone: 'America/New_York',  // EST as default
            treeOrientation: 'top',
            hideScrollbars: true,
            defaultPlaybackSpeed: 1.0,
            defaultSoundMode: 'none',
            newTaskPollEnabled: true,  // Auto-detect new tasks
            newTaskPollInterval: 5  // Poll every 5 seconds
        };

        let currentSettings = { ...DEFAULT_SETTINGS };

        function loadSettings() {
            const saved = localStorage.getItem('pas_hmi_settings');
            if (saved) {
                try {
                    currentSettings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
                } catch (e) {
                    console.error('Failed to load settings:', e);
                    currentSettings = { ...DEFAULT_SETTINGS };
                }
            }
            applySettings();
            updateSettingsUI();
        }

        function saveSettings() {
            // Read values from UI
            currentSettings.autoRefreshEnabled = document.getElementById('auto-refresh-toggle').classList.contains('active');
            currentSettings.refreshInterval = parseInt(document.getElementById('refresh-interval').value);
            currentSettings.showTooltips = document.getElementById('tooltips-toggle').classList.contains('active');
            currentSettings.compactMode = document.getElementById('compact-toggle').classList.contains('active');
            currentSettings.animationDuration = parseInt(document.getElementById('animation-duration').value);
            currentSettings.masterAudioEnabled = document.getElementById('master-audio-toggle').classList.contains('active');
            currentSettings.sequencerNotesEnabled = document.getElementById('sequencer-notes-toggle').classList.contains('active');
            currentSettings.agentVoiceEnabled = document.getElementById('agent-voice-toggle').classList.contains('active');
            currentSettings.audioVolume = parseInt(document.getElementById('audio-volume').value);
            currentSettings.sequencerNoteDuration = parseInt(document.getElementById('note-duration').value);
            currentSettings.timezone = document.getElementById('timezone-select').value;
            currentSettings.treeOrientation = document.getElementById('tree-orientation').value;
            currentSettings.hideScrollbars = document.getElementById('hide-scrollbars-toggle').classList.contains('active');
            currentSettings.defaultPlaybackSpeed = parseFloat(document.getElementById('default-playback-speed').value);
            currentSettings.defaultSoundMode = document.getElementById('default-sound-mode').value;
            currentSettings.newTaskPollEnabled = document.getElementById('new-task-poll-toggle').classList.contains('active');
            currentSettings.newTaskPollInterval = parseInt(document.getElementById('new-task-poll-interval').value);

            // Validate
            if (currentSettings.refreshInterval < 0) currentSettings.refreshInterval = 0;
            if (currentSettings.refreshInterval > 600) currentSettings.refreshInterval = 600;
            if (currentSettings.newTaskPollInterval < 1) currentSettings.newTaskPollInterval = 1;
            if (currentSettings.newTaskPollInterval > 60) currentSettings.newTaskPollInterval = 60;
            if (currentSettings.animationDuration < 0) currentSettings.animationDuration = 0;
            if (currentSettings.animationDuration > 2000) currentSettings.animationDuration = 2000;
            if (currentSettings.audioVolume < 0) currentSettings.audioVolume = 0;
            if (currentSettings.audioVolume > 100) currentSettings.audioVolume = 100;
            if (currentSettings.defaultPlaybackSpeed < 0.1) currentSettings.defaultPlaybackSpeed = 0.1;
            if (currentSettings.defaultPlaybackSpeed > 1000) currentSettings.defaultPlaybackSpeed = 1000;

            // Save to localStorage
            localStorage.setItem('pas_hmi_settings', JSON.stringify(currentSettings));

            // Apply settings
            applySettings();

            // Close modal
            closeSettings();

            // Notify user
            console.log('Settings saved:', currentSettings);

            // Reload page to apply changes (simple approach)
            location.reload();
        }

        function resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                currentSettings = { ...DEFAULT_SETTINGS };
                localStorage.removeItem('pas_hmi_settings');
                updateSettingsUI();
                applySettings();
            }
        }

        function applySettings() {
            // Update audio init button visibility
            updateAudioInitButton();

            // This will be overridden by child templates to apply view-specific settings
            if (typeof applyViewSettings === 'function') {
                applyViewSettings(currentSettings);
            }
        }

        function updateSettingsUI() {
            // Update toggle switches
            document.getElementById('auto-refresh-toggle').classList.toggle('active', currentSettings.autoRefreshEnabled);
            document.getElementById('tooltips-toggle').classList.toggle('active', currentSettings.showTooltips);
            document.getElementById('compact-toggle').classList.toggle('active', currentSettings.compactMode);
            document.getElementById('master-audio-toggle').classList.toggle('active', currentSettings.masterAudioEnabled);
            document.getElementById('sequencer-notes-toggle').classList.toggle('active', currentSettings.sequencerNotesEnabled);
            document.getElementById('agent-voice-toggle').classList.toggle('active', currentSettings.agentVoiceEnabled);
            document.getElementById('hide-scrollbars-toggle').classList.toggle('active', currentSettings.hideScrollbars);

            // Update input values
            document.getElementById('refresh-interval').value = currentSettings.refreshInterval;
            document.getElementById('animation-duration').value = currentSettings.animationDuration;
            document.getElementById('audio-volume').value = currentSettings.audioVolume;
            document.getElementById('volume-display').textContent = currentSettings.audioVolume + '%';
            document.getElementById('note-duration').value = currentSettings.sequencerNoteDuration;
            document.getElementById('note-duration-display').textContent = currentSettings.sequencerNoteDuration + 'ms';
            document.getElementById('timezone-select').value = currentSettings.timezone;
            document.getElementById('tree-orientation').value = currentSettings.treeOrientation;
            document.getElementById('default-playback-speed').value = currentSettings.defaultPlaybackSpeed;
            document.getElementById('default-sound-mode').value = currentSettings.defaultSoundMode;
            document.getElementById('new-task-poll-interval').value = currentSettings.newTaskPollInterval;

            // Update toggle states
            if (currentSettings.newTaskPollEnabled) {
                document.getElementById('new-task-poll-toggle').classList.add('active');
            } else {
                document.getElementById('new-task-poll-toggle').classList.remove('active');
            }
        }

        async function openSettings() {
            updateSettingsUI();
            await loadModelPreferences();
            document.getElementById('settings-modal').classList.add('active');
        }

        // Load available models and current preferences
        async function loadModelPreferences() {
            try {
                // Load available models
                const modelsResponse = await fetch('/api/models/available');
                const modelsData = await modelsResponse.json();

                if (modelsData.status === 'ok') {
                    const models = modelsData.models;

                    // Populate all dropdowns
                    const agentTypes = ['architect', 'director', 'manager', 'programmer'];
                    const selectTypes = ['primary', 'fallback'];

                    for (const agentType of agentTypes) {
                        for (const selectType of selectTypes) {
                            const selectId = `${agentType}-${selectType}`;
                            const selectElement = document.getElementById(selectId);

                            if (selectElement) {
                                // Clear existing options
                                selectElement.innerHTML = '';

                                // Add options for each model
                                for (const [modelId, modelInfo] of Object.entries(models)) {
                                    const option = document.createElement('option');
                                    option.value = modelId;

                                    // Add emoji prefix based on provider
                                    let emoji = 'ü§ñ';
                                    if (modelId === 'auto') emoji = 'üîÑ';
                                    else if (modelInfo.provider === 'ollama') emoji = 'üè†';
                                    else if (modelInfo.provider === 'anthropic') emoji = 'üîÆ';
                                    else if (modelInfo.provider === 'openai') emoji = 'üöÄ';
                                    else if (modelInfo.provider === 'google') emoji = '‚ú®';
                                    else if (modelInfo.provider === 'deepseek') emoji = 'üß†';
                                    else if (modelInfo.provider === 'local' || modelInfo.provider === 'local_fastapi') emoji = 'üíª';

                                    // Add status indicator for local models
                                    let statusText = '';
                                    if (modelInfo.status) {
                                        if (modelInfo.status === 'OK') statusText = ' ‚úì';
                                        else if (modelInfo.status === 'ERR') statusText = ' ‚ö†Ô∏è';
                                        else if (modelInfo.status === 'OFFLINE') statusText = ' ‚≠ï';
                                        else if (modelInfo.status === 'API') statusText = '';  // No indicator for API models
                                    }

                                    option.textContent = `${emoji} ${modelInfo.name}${statusText}`;

                                    // Disable offline models
                                    if (modelInfo.status === 'OFFLINE' || modelInfo.status === 'ERR') {
                                        option.disabled = true;
                                        option.style.color = '#666';
                                    }

                                    selectElement.appendChild(option);
                                }
                            }
                        }
                    }
                }

                // Load current preferences
                const prefsResponse = await fetch('/api/models/preferences');
                const prefsData = await prefsResponse.json();

                if (prefsData.status === 'ok') {
                    const prefs = prefsData.preferences;

                    // Set selected values
                    for (const [agentType, config] of Object.entries(prefs)) {
                        const primaryElement = document.getElementById(`${agentType}-primary`);
                        const fallbackElement = document.getElementById(`${agentType}-fallback`);

                        if (primaryElement) primaryElement.value = config.primary;
                        if (fallbackElement) fallbackElement.value = config.fallback;
                    }
                }
            } catch (error) {
                console.error('Failed to load model preferences:', error);
            }
        }

        // Save model preferences
        async function saveModelPreferences() {
            try {
                const preferences = {
                    architect: {
                        primary: document.getElementById('architect-primary').value,
                        fallback: document.getElementById('architect-fallback').value
                    },
                    director: {
                        primary: document.getElementById('director-primary').value,
                        fallback: document.getElementById('director-fallback').value
                    },
                    manager: {
                        primary: document.getElementById('manager-primary').value,
                        fallback: document.getElementById('manager-fallback').value
                    },
                    programmer: {
                        primary: document.getElementById('programmer-primary').value,
                        fallback: document.getElementById('programmer-fallback').value
                    }
                };

                const response = await fetch('/api/models/preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ preferences })
                });

                const data = await response.json();

                if (data.status === 'ok') {
                    alert('‚úÖ Model preferences saved successfully!');
                } else {
                    alert('‚ùå Failed to save preferences: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to save model preferences:', error);
                alert('‚ùå Failed to save preferences: ' + error.message);
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function switchSettingsPage(pageId) {
            // Update sidebar active state
            const sidebarItems = document.querySelectorAll('.settings-sidebar-item');
            sidebarItems.forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.settings-sidebar-item').classList.add('active');

            // Update page visibility
            const pages = document.querySelectorAll('.settings-page');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('page-' + pageId).classList.add('active');

            // Update page title
            const titles = {
                'general': '‚öôÔ∏è General',
                'display': 'üé® Display',
                'tree': 'üå≥ Tree View',
                'sequencer': 'üéπ Sequencer',
                'audio': 'üîä Audio',
                'llm': 'ü§ñ LLM Models',
                'advanced': '‚öôÔ∏è Advanced Models',
                'system': 'üõ†Ô∏è System'
            };
            document.getElementById('settings-page-title').textContent = titles[pageId];

            // Initialize advanced model settings sliders if switching to advanced page
            if (pageId === 'advanced') {
                initAdvancedModelSettings();
            }
        }

        async function initAdvancedModelSettings() {
            // Load existing settings from backend
            try {
                const response = await fetch('/api/models/advanced-settings');
                const data = await response.json();

                if (data.status === 'ok') {
                    const settings = data.settings;

                    // Set values
                    document.getElementById('llm-temperature').value = settings.temperature;
                    document.getElementById('llm-max-tokens').value = settings.maxTokens;
                    document.getElementById('llm-top-p').value = settings.topP;
                    document.getElementById('llm-top-k').value = settings.topK;
                    document.getElementById('llm-frequency-penalty').value = settings.frequencyPenalty;
                    document.getElementById('llm-presence-penalty').value = settings.presencePenalty;

                    // Update displays
                    document.getElementById('temperature-display').textContent = settings.temperature.toFixed(1);
                    document.getElementById('top-p-display').textContent = settings.topP.toFixed(2);
                    document.getElementById('frequency-penalty-display').textContent = settings.frequencyPenalty.toFixed(1);
                    document.getElementById('presence-penalty-display').textContent = settings.presencePenalty.toFixed(1);
                }
            } catch (error) {
                console.error('Error loading advanced settings:', error);
            }

            // Temperature slider
            const tempSlider = document.getElementById('llm-temperature');
            const tempDisplay = document.getElementById('temperature-display');
            tempSlider.addEventListener('input', (e) => {
                tempDisplay.textContent = parseFloat(e.target.value).toFixed(1);
            });

            // Top P slider
            const topPSlider = document.getElementById('llm-top-p');
            const topPDisplay = document.getElementById('top-p-display');
            topPSlider.addEventListener('input', (e) => {
                topPDisplay.textContent = parseFloat(e.target.value).toFixed(2);
            });

            // Frequency Penalty slider
            const freqSlider = document.getElementById('llm-frequency-penalty');
            const freqDisplay = document.getElementById('frequency-penalty-display');
            freqSlider.addEventListener('input', (e) => {
                freqDisplay.textContent = parseFloat(e.target.value).toFixed(1);
            });

            // Presence Penalty slider
            const presSlider = document.getElementById('llm-presence-penalty');
            const presDisplay = document.getElementById('presence-penalty-display');
            presSlider.addEventListener('input', (e) => {
                presDisplay.textContent = parseFloat(e.target.value).toFixed(1);
            });
        }

        async function saveAdvancedModelSettings() {
            try {
                const settings = {
                    temperature: parseFloat(document.getElementById('llm-temperature').value),
                    maxTokens: parseInt(document.getElementById('llm-max-tokens').value),
                    topP: parseFloat(document.getElementById('llm-top-p').value),
                    topK: parseInt(document.getElementById('llm-top-k').value),
                    frequencyPenalty: parseFloat(document.getElementById('llm-frequency-penalty').value),
                    presencePenalty: parseFloat(document.getElementById('llm-presence-penalty').value)
                };

                const response = await fetch('/api/models/advanced-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('‚úÖ Advanced model settings saved successfully!');
                } else {
                    alert('‚ö†Ô∏è Settings saved but may need service restart to take effect.');
                }
            } catch (error) {
                console.error('Error saving advanced settings:', error);
                alert('‚ùå Failed to save advanced settings: ' + error.message);
            }
        }

        function toggleAutoRefresh() {
            document.getElementById('auto-refresh-toggle').classList.toggle('active');
        }

        function toggleTooltips() {
            document.getElementById('tooltips-toggle').classList.toggle('active');
        }

        function toggleCompactMode() {
            document.getElementById('compact-toggle').classList.toggle('active');
        }

        function toggleMasterAudio() {
            document.getElementById('master-audio-toggle').classList.toggle('active');
        }

        function toggleSequencerNotes() {
            document.getElementById('sequencer-notes-toggle').classList.toggle('active');
        }

        function toggleAgentVoice() {
            document.getElementById('agent-voice-toggle').classList.toggle('active');
        }

        function toggleNewTaskPoll() {
            document.getElementById('new-task-poll-toggle').classList.toggle('active');
        }

        function toggleHideScrollbars() {
            document.getElementById('hide-scrollbars-toggle').classList.toggle('active');
        }

        // Update volume and note duration displays as sliders move
        document.addEventListener('DOMContentLoaded', () => {
            const volumeSlider = document.getElementById('audio-volume');
            const volumeDisplay = document.getElementById('volume-display');
            const noteDurationSlider = document.getElementById('note-duration');
            const noteDurationDisplay = document.getElementById('note-duration-display');

            if (volumeSlider && volumeDisplay) {
                volumeSlider.addEventListener('input', (e) => {
                    volumeDisplay.textContent = e.target.value + '%';
                });
            }

            if (noteDurationSlider && noteDurationDisplay) {
                noteDurationSlider.addEventListener('input', (e) => {
                    noteDurationDisplay.textContent = e.target.value + 'ms';
                });
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', (event) => {
            const modal = document.getElementById('settings-modal');
            if (event.target === modal) {
                closeSettings();
            }
        });

        // Initialize WebSocket on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Load settings first
            loadSettings();

            // Then connect WebSocket
            connectWebSocket();

            // Start task status polling
            startTaskStatusPolling();

            // Send ping every 30 seconds
            setInterval(() => {
                if (socket && socket.connected) {
                    socket.emit('ping');
                }
            }, 30000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopTaskStatusPolling();
        });

        // Export settings for child templates
        function getSettings() {
            return currentSettings;
        }

        // ============================================================================
        // Audio Service Integration
        // ============================================================================

        const AUDIO_SERVICE_URL = 'http://localhost:6103';

        /**
         * Play text-to-speech announcement
         * @param {string} text - Text to speak
         * @param {number} speed - Speech speed (0.5-2.0, default: 1.0)
         * @returns {Promise<Object>} Audio service response
         */
        async function speakStatus(text, speed = 1.0) {
            // Check if master audio and TTS are enabled
            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.agentVoiceEnabled) {
                console.log('TTS disabled in settings');
                return { success: false, message: 'TTS disabled' };
            }

            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/audio/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, speed, auto_play: true })
                });

                if (!response.ok) {
                    throw new Error(`TTS request failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('TTS generated:', data);
                return data;
            } catch (error) {
                console.error('TTS error:', error);
                return { success: false, message: error.message };
            }
        }

        /**
         * Play MIDI note for sequencer events
         * @param {string} eventType - Event type (task_assigned, task_started, task_completed, error)
         * @returns {Promise<Object>} Audio service response
         */
        async function playNoteForEvent(eventType) {
            // Check if master audio and sequencer notes are enabled
            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.sequencerNotesEnabled) {
                console.log('Sequencer notes disabled in settings');
                return { success: false, message: 'Notes disabled' };
            }

            // Map event types to MIDI notes
            const noteMap = {
                'task_assigned': 60,    // C4 (middle C)
                'task_started': 64,     // E4
                'task_completed': 72,   // C5 (higher octave)
                'error': 48,            // C3 (lower octave)
                'warning': 55,          // G3
                'success': 77           // F5
            };

            const note = noteMap[eventType] || 60;

            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/audio/note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        note,
                        duration: 0.3,
                        velocity: 100,
                        instrument: 'piano'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Note playback failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Note played:', data);
                return data;
            } catch (error) {
                console.error('Note playback error:', error);
                return { success: false, message: error.message };
            }
        }

        /**
         * Play alert tone
         * @param {string} type - Alert type (info, success, warning, error)
         * @returns {Promise<Object>} Audio service response
         */
        async function playAlert(type = 'info') {
            // Check if master audio is enabled
            const settings = getSettings();
            if (!settings.masterAudioEnabled) {
                console.log('Audio disabled in settings');
                return { success: false, message: 'Audio disabled' };
            }

            const toneMap = {
                'info': { frequency: 440, duration: 0.2, waveform: 'sine' },
                'success': { frequency: 800, duration: 0.15, waveform: 'sine' },
                'warning': { frequency: 600, duration: 0.3, waveform: 'square' },
                'error': { frequency: 200, duration: 0.4, waveform: 'square' }
            };

            const config = toneMap[type] || toneMap['info'];

            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/audio/tone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...config, volume: 0.5 })
                });

                if (!response.ok) {
                    throw new Error(`Tone playback failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Alert played:', data);
                return data;
            } catch (error) {
                console.error('Alert playback error:', error);
                return { success: false, message: error.message };
            }
        }

        /**
         * Update audio service volume to match settings
         * @param {number} volume - Volume percentage (0-100)
         * @returns {Promise<Object>} Audio service response
         */
        async function updateAudioServiceVolume(volume) {
            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/audio/volume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ master_volume: volume / 100 })
                });

                if (!response.ok) {
                    throw new Error(`Volume update failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Audio service volume updated:', data);
                return data;
            } catch (error) {
                console.error('Volume update error:', error);
                return { success: false, message: error.message };
            }
        }

        /**
         * Check if audio service is available
         * @returns {Promise<boolean>} True if service is healthy
         */
        async function checkAudioService() {
            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/health`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(2000) // 2 second timeout
                });

                if (!response.ok) {
                    return false;
                }

                const data = await response.json();
                return data.status === 'ok';
            } catch (error) {
                console.warn('Audio service not available:', error.message);
                return false;
            }
        }

        // Sync audio service volume when settings change
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if audio service is available
            const audioAvailable = await checkAudioService();
            if (audioAvailable) {
                console.log('‚úì Audio service available');

                // Sync volume on startup
                const settings = getSettings();
                if (settings.audioVolume !== undefined) {
                    await updateAudioServiceVolume(settings.audioVolume);
                }
            } else {
                console.warn('‚ö† Audio service not available at', AUDIO_SERVICE_URL);
                console.warn('Start audio service with: ./scripts/start_audio_service.sh');
            }
        });

        // ============================================================================
        // Web Audio API - Client-Side Sound System
        // ============================================================================

        // Global AudioContext (initialized on user interaction)
        let audioContext = null;
        let masterGainNode = null;

        /**
         * Initialize Web Audio API (call on first user interaction)
         */
        function initAudioContext() {
            if (audioContext) return; // Already initialized

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGainNode = audioContext.createGain();
                masterGainNode.connect(audioContext.destination);

                // Set volume from settings
                const settings = getSettings();
                masterGainNode.gain.value = (settings.audioVolume || 70) / 100;

                console.log('‚úì Web Audio API initialized');
            } catch (error) {
                console.error('Failed to initialize Web Audio API:', error);
            }
        }

        /**
         * Play a musical note using Web Audio API
         * @param {number} frequency - Frequency in Hz
         * @param {number} duration - Duration in seconds
         * @param {string} waveform - 'sine', 'square', 'sawtooth', 'triangle'
         */
        function playClientNote(frequency, duration = 0.3, waveform = 'sine') {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;

            // Bug fix: Update master volume before playing each note
            // This ensures volume changes take effect immediately without reinitializing audio context
            if (masterGainNode) {
                masterGainNode.gain.value = (settings.audioVolume || 70) / 100;
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = waveform;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(masterGainNode);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        /**
         * Play Geiger counter click sound
         */
        function playGeigerClick() {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;

            // Create short burst of noise (characteristic Geiger click)
            const bufferSize = audioContext.sampleRate * 0.02; // 20ms click
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);

            // Generate noise with exponential decay
            for (let i = 0; i < bufferSize; i++) {
                const decay = Math.exp(-i / (bufferSize / 8)); // Fast decay
                data[i] = (Math.random() * 2 - 1) * decay;
            }

            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();

            source.buffer = buffer;
            gainNode.gain.value = 0.15; // Lower volume for clicks

            source.connect(gainNode);
            gainNode.connect(masterGainNode);

            source.start();
        }

        /**
         * Play random sound effect
         */
        function playRandomSound() {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;

            const sounds = [
                { freq: 440, wave: 'sine' },     // A4
                { freq: 523, wave: 'sine' },     // C5
                { freq: 659, wave: 'sine' },     // E5
                { freq: 784, wave: 'sine' },     // G5
                { freq: 880, wave: 'triangle' }, // A5
                { freq: 1047, wave: 'square' }   // C6
            ];

            const sound = sounds[Math.floor(Math.random() * sounds.length)];
            playClientNote(sound.freq, 0.15, sound.wave);
        }

        /**
         * Play musical note for event (matches MIDI mapping from audio service)
         * @param {string} eventType - Event type
         */
        function playEventNote(eventType) {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.sequencerNotesEnabled) return;

            // MIDI note to frequency conversion (A440 standard)
            const midiToFreq = (midi) => 440 * Math.pow(2, (midi - 69) / 12);

            const noteMap = {
                'task_assigned': 60,    // C4 (261.63 Hz)
                'task_started': 64,     // E4 (329.63 Hz)
                'task_completed': 72,   // C5 (523.25 Hz)
                'error': 48,            // C3 (130.81 Hz)
                'warning': 55,          // G3 (196.00 Hz)
                'success': 77,          // F5 (698.46 Hz)
                'heartbeat': 60         // C4
            };

            const midiNote = noteMap[eventType] || 60;
            const frequency = midiToFreq(midiNote);

            playClientNote(frequency, 0.3, 'sine');
        }

        /**
         * Play hierarchical musical note based on agent tier
         * Higher tier (VP/Director) = lower pitch, Lower tier (Programmer) = higher pitch
         * Parallel agents at same tier get slightly offset pitches for clarity
         *
         * @param {string} eventType - Event type
         * @param {Object} task - Task object with agent_id
         */
        function playEventNoteHierarchical(eventType, task = null) {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.sequencerNotesEnabled) return;

            // Get note duration from settings (default 150ms)
            const noteDuration = (settings.sequencerNoteDuration || 150) / 1000; // Convert ms to seconds

            // MIDI note to frequency conversion (A440 standard)
            const midiToFreq = (midi) => 440 * Math.pow(2, (midi - 69) / 12);

            // Base MIDI notes by event type (lower octave for hierarchy headroom)
            const eventBaseNotes = {
                'task_assigned': 48,    // C3 (lower for hierarchy range)
                'task_started': 52,     // E3
                'task_completed': 60,   // C4
                'error': 36,            // C2 (very low)
                'warning': 43,          // G2
                'success': 65,          // F4
                'heartbeat': 48         // C3
            };

            let baseMidi = eventBaseNotes[eventType] || 48;

            // Calculate tier-based pitch offset
            // Tier 0 (VP) = +0 semitones (deepest/lowest)
            // Tier 1 (Director) = +4 semitones
            // Tier 2 (Manager) = +7 semitones
            // Tier 3 (Programmer) = +12 semitones (highest)
            // Tier 4+ (Workers) = +15 semitones
            let tierOffset = 0;
            let agentTier = '?';
            let agentId = '';

            if (task && task.agent_id && typeof agents !== 'undefined' && agents.length > 0) {
                agentId = task.agent_id;
                const agent = agents.find(a => a.service_id === agentId);
                if (agent) {
                    agentTier = agent.tier;
                    const tier = parseInt(agentTier) || 3; // Default to tier 3 if unknown

                    // Tier mapping (inverted: higher tier number = higher pitch)
                    const tierPitchMap = {
                        '0': 0,    // VP (lowest/deepest)
                        '1': 4,    // Director (+4 semitones)
                        '2': 7,    // Manager (+7 semitones)
                        '3': 12,   // Programmer (+12 semitones = 1 octave up)
                        '4': 15,   // Worker (+15 semitones)
                        '5': 17    // Lowest tier (+17 semitones)
                    };

                    tierOffset = tierPitchMap[String(tier)] || 12;
                } else {
                    console.warn(`[Sound] Agent not found for agent_id: ${agentId}`);
                }
            }

            // Calculate per-agent offset for parallel agents at same tier
            // Use agent_id hash to generate consistent pitch offset (+0 to +2 semitones)
            let agentOffset = 0;
            if (agentId) {
                // Simple hash: sum char codes modulo 3
                const hash = agentId.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
                agentOffset = (hash % 3); // 0, 1, or 2 semitones
            }

            const finalMidi = baseMidi + tierOffset + agentOffset;
            const frequency = midiToFreq(finalMidi);

            // Debug log (throttled)
            if (Math.random() < 0.1) { // Log 10% of notes
                console.log(`üéµ [Sound] ${eventType} - tier=${agentTier}, base=${baseMidi}, tier+${tierOffset}, agent+${agentOffset}, final=${finalMidi} (${Math.round(frequency)}Hz), duration=${noteDuration}s`);
            }

            playClientNote(frequency, noteDuration, 'sine');
        }

        /**
         * Speak text using Web Speech API (fallback to audio service)
         * @param {string} text - Text to speak
         */
        function speakText(text) {
            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.agentVoiceEnabled) return;

            // Try Web Speech API first (available in most browsers)
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.2;  // Slightly faster
                utterance.pitch = 1.0;
                utterance.volume = (settings.audioVolume || 70) / 100;
                window.speechSynthesis.speak(utterance);
            } else {
                // Fallback to audio service
                speakStatus(text);
            }
        }

        /**
         * Handle task event sound based on current sound mode
         * @param {string} eventType - Event type
         * @param {Object} task - Task object (optional, for hierarchical pitch calculation)
         */
        function handleTaskEventSound(eventType, task = null) {
            if (!audioContext) initAudioContext();

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;

            const soundMode = settings.defaultSoundMode || 'none';

            switch (soundMode) {
                case 'none':
                    // No sound
                    break;

                case 'voice':
                    // Text-to-speech announcement
                    const voiceMap = {
                        'task_assigned': 'Task assigned',
                        'task_started': 'Task started',
                        'task_completed': 'Task completed',
                        'error': 'Error occurred',
                        'warning': 'Warning',
                        'heartbeat': 'Heartbeat'
                    };
                    const text = voiceMap[eventType] || eventType;
                    speakText(text);
                    break;

                case 'music':
                    // Musical notes with hierarchical pitch
                    playEventNoteHierarchical(eventType, task);
                    break;

                case 'random':
                    // Random sound effects
                    playRandomSound();
                    break;

                case 'geiger':
                    // Geiger counter tick (for any agent activity)
                    playGeigerClick();
                    break;

                default:
                    console.warn('Unknown sound mode:', soundMode);
            }
        }

        /**
         * Start Geiger counter mode (continuous ticking based on activity rate)
         */
        let geigerIntervalId = null;
        let activityRate = 0; // Events per second

        function startGeigerMode() {
            if (geigerIntervalId) return; // Already running

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;
            if (settings.defaultSoundMode !== 'geiger') return;

            // Base tick rate (when idle)
            const baseRate = 500; // ms between ticks

            geigerIntervalId = setInterval(() => {
                // Vary tick rate based on activity (lower interval = faster ticks)
                const interval = Math.max(50, baseRate - (activityRate * 50));

                if (Math.random() < 0.3 || activityRate > 0) {
                    playGeigerClick();
                }
            }, 200); // Check every 200ms

            console.log('‚úì Geiger counter mode started');
        }

        function stopGeigerMode() {
            if (geigerIntervalId) {
                clearInterval(geigerIntervalId);
                geigerIntervalId = null;
                console.log('‚úì Geiger counter mode stopped');
            }
        }

        function updateActivityRate(eventsPerSecond) {
            activityRate = Math.min(eventsPerSecond, 10); // Cap at 10 events/sec
        }

        // Update master volume when settings change
        function updateClientVolume(volume) {
            if (!audioContext || !masterGainNode) return;
            masterGainNode.gain.value = volume / 100;
        }

        // Override handleRealtimeEvent to trigger sounds
        const originalHandleRealtimeEvent = handleRealtimeEvent;
        handleRealtimeEvent = function(event) {
            // Call original handler
            if (originalHandleRealtimeEvent) {
                originalHandleRealtimeEvent(event);
            }

            // Map event types to sound events
            const soundEventMap = {
                'job_started': 'task_started',
                'task_started': 'task_started',
                'job_completed': 'task_completed',
                'task_completed': 'task_completed',
                'error': 'error',
                'failed': 'error',
                'heartbeat': 'heartbeat',
                'warning': 'warning',
                'blocked': 'warning'
            };

            const soundEvent = soundEventMap[event.event_type];
            if (soundEvent) {
                handleTaskEventSound(soundEvent);
                updateActivityRate(1); // Increment activity
            }
        };

        /**
         * Manual audio initialization (triggered by button click)
         */
        function initAudioManual() {
            if (!audioContext) {
                initAudioContext();

                // Start Geiger mode if enabled
                const settings = getSettings();
                if (settings.defaultSoundMode === 'geiger') {
                    startGeigerMode();
                }

                // Hide the button
                const btn = document.getElementById('audio-init-button');
                if (btn) {
                    btn.style.display = 'none';
                }

                // Play a confirmation beep
                playClientNote(523.25, 0.2, 'sine'); // C5
                console.log('‚úì Audio initialized manually');
            }
        }

        /**
         * Show/hide audio init button based on settings
         */
        function updateAudioInitButton() {
            const settings = getSettings();
            const btn = document.getElementById('audio-init-button');

            if (!btn) return;

            // Show button if master audio is enabled and audio context not initialized
            if (settings.masterAudioEnabled && !audioContext) {
                btn.style.display = 'inline-block';
            } else {
                btn.style.display = 'none';
            }
        }

        // Initialize audio on first user interaction (fallback for auto-init)
        document.addEventListener('click', () => {
            if (!audioContext) {
                const settings = getSettings();
                if (settings.masterAudioEnabled) {
                    initAudioContext();

                    // Start Geiger mode if enabled
                    if (settings.defaultSoundMode === 'geiger') {
                        startGeigerMode();
                    }

                    // Hide the button
                    updateAudioInitButton();
                    console.log('‚úì Audio auto-initialized on first click');
                }
            }
        }, { once: true });

        // Monitor sound mode changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'pas_hmi_settings') {
                const settings = getSettings();

                // Update volume
                if (settings.audioVolume !== undefined) {
                    updateClientVolume(settings.audioVolume);
                }

                // Start/stop Geiger mode based on settings
                if (settings.defaultSoundMode === 'geiger' && settings.masterAudioEnabled) {
                    startGeigerMode();
                } else {
                    stopGeigerMode();
                }
            }
        });

        // Decay activity rate over time
        setInterval(() => {
            activityRate = Math.max(0, activityRate * 0.9); // Decay by 10% every second
        }, 1000);

        // ============================================================================
        // Demo Control Functions
        // ============================================================================

        let demoRunning = false;

        async function startPrimeDirective() {
            // Get custom prompt from settings or use default
            const customPrompt = localStorage.getItem('primeDirectivePrompt') || '';
            
            // Show confirmation dialog with option to customize
            const useCustom = confirm('üöÄ Send Prime Directive to PAS Root\n\nThis will send a real project request to the operational PAS system.\n\nClick OK to use default prompt, or Cancel to customize.');
            
            let finalPrompt = customPrompt;
            if (!useCustom) {
                // Allow user to customize the prompt
                const defaultPrompt = `Build a comprehensive REST API system with the following requirements:

CORE FEATURES:
- User authentication with JWT tokens
- Role-based access control (admin, user, moderator)
- RESTful endpoints for CRUD operations
- PostgreSQL database with proper migrations
- Input validation and error handling
- API documentation with OpenAPI/Swagger
- Unit and integration tests
- Docker containerization
- CI/CD pipeline configuration

TECHNICAL STACK:
- Backend: FastAPI or Express.js
- Database: PostgreSQL with SQLAlchemy/Prisma
- Authentication: JWT with refresh tokens
- Testing: pytest/Jest with coverage reports
- Documentation: OpenAPI 3.0 spec
- Deployment: Docker with docker-compose

DELIVERABLES:
1. Complete source code with modular architecture
2. Database schema and migration scripts
3. API documentation and testing suite
4. Docker configuration and deployment scripts
5. CI/CD pipeline setup (GitHub Actions/GitLab CI)

The system should be production-ready, secure, and scalable.`;

                finalPrompt = prompt('üöÄ Customize Prime Directive Prompt:', defaultPrompt);
                if (finalPrompt === null) return; // User cancelled
                
                // Save custom prompt for next time
                localStorage.setItem('primeDirectivePrompt', finalPrompt);
            }

            const primeDirectiveButton = document.getElementById('prime-directive-button');
            const originalText = primeDirectiveButton.textContent;

            try {
                primeDirectiveButton.disabled = true;
                primeDirectiveButton.textContent = 'üöÄ Sending...';

                const response = await fetch('/api/demo/prime-directive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: finalPrompt })
                });
                const data = await response.json();

                if (response.ok) {
                    console.log('‚úÖ Prime Directive sent:', data);
                    alert(`‚úÖ Prime Directive sent to PAS Root!\n\nRun ID: ${data.run_id}\nPrompt Preview: ${data.prompt_preview}\n\nCheck the sequencer to see execution progress.`);
                    
                    // Refresh sequencer to show new tasks
                    if (typeof fetchSequencerData === 'function') {
                        setTimeout(() => fetchSequencerData(), 1000);
                    }
                } else {
                    throw new Error(data.error || 'Failed to send Prime Directive');
                }
            } catch (error) {
                console.error('Failed to send Prime Directive:', error);
                alert('Failed to send Prime Directive: ' + error.message);
            } finally {
                primeDirectiveButton.disabled = false;
                primeDirectiveButton.textContent = originalText;
            }
        }

        async function startDemo() {
            if (demoRunning) {
                alert('Demo is already running!');
                return;
            }

            const startButton = document.getElementById('start-demo-button');
            const stopButton = document.getElementById('stop-demo-button');
            const masterStopButton = document.getElementById('master-stop-button');

            try {
                startButton.disabled = true;
                startButton.textContent = '‚è≥ Starting...';

                const response = await fetch('/api/demo/start', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    demoRunning = true;
                    startButton.style.display = 'none';
                    stopButton.style.display = 'inline-block';
                    masterStopButton.style.display = 'inline-block';
                    console.log('‚úì Demo started:', data);
                    alert('Demo started! Watch the HMI come alive with activity.\n\n' +
                          'Projects will be created in /tmp/ using local LLMs (free!).\n\n' +
                          'Enable sound in Sequencer to hear it working!');
                } else {
                    throw new Error(data.error || 'Failed to start demo');
                }
            } catch (error) {
                console.error('Failed to start demo:', error);
                alert('Failed to start demo: ' + error.message);
                startButton.textContent = '‚ñ∂Ô∏è Start Demo';
            } finally {
                startButton.disabled = false;
            }
        }

        async function stopDemo() {
            const startButton = document.getElementById('start-demo-button');
            const stopButton = document.getElementById('stop-demo-button');

            try {
                stopButton.disabled = true;
                stopButton.textContent = '‚è≥ Stopping...';

                const response = await fetch('/api/demo/stop', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    demoRunning = false;
                    stopButton.style.display = 'none';
                    startButton.style.display = 'inline-block';
                    startButton.textContent = '‚ñ∂Ô∏è Start Demo';
                    document.getElementById('master-stop-button').style.display = 'none';
                    console.log('‚úì Demo stopped:', data);
                    alert('Demo stopped.');
                } else {
                    throw new Error(data.error || 'Failed to stop demo');
                }
            } catch (error) {
                console.error('Failed to stop demo:', error);
                alert('Failed to stop demo: ' + error.message);
                stopButton.textContent = '‚èπÔ∏è Stop Demo';
            } finally {
                stopButton.disabled = false;
            }
        }

        async function masterStopDemo() {
            // Confirmation dialog with warning
            if (!confirm('‚ö†Ô∏è MASTER STOP: This will FORCE KILL all demo processes immediately!\n\nThis is an EMERGENCY measure - use only if regular Stop fails.\n\nContinue?')) {
                return;
            }

            const startButton = document.getElementById('start-demo-button');
            const stopButton = document.getElementById('stop-demo-button');
            const masterStopButton = document.getElementById('master-stop-button');

            try {
                masterStopButton.disabled = true;
                masterStopButton.textContent = '‚è≥ KILLING...';

                const response = await fetch('/api/demo/master-stop', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    demoRunning = false;
                    stopButton.style.display = 'none';
                    masterStopButton.style.display = 'none';
                    startButton.style.display = 'inline-block';
                    startButton.textContent = '‚ñ∂Ô∏è Start Demo';
                    console.log('‚úì MASTER STOP executed:', data);
                    if (data.killed_pids && data.killed_pids.length > 0) {
                        alert(`‚úÖ MASTER STOP: Killed ${data.killed_pids.length} process(es)\nPIDs: ${data.killed_pids.join(', ')}`);
                    } else {
                        alert('‚úÖ MASTER STOP: ' + data.message);
                    }
                } else {
                    throw new Error(data.error || 'Failed to execute MASTER STOP');
                }
            } catch (error) {
                console.error('Failed to execute MASTER STOP:', error);
                alert('‚ùå MASTER STOP failed: ' + error.message);
                masterStopButton.textContent = 'üõë MASTER STOP';
            } finally {
                masterStopButton.disabled = false;
            }
        }

        async function clearDemoData() {
            if (!confirm('This will delete demo files in /tmp/lnsp_demo/\n\nContinue?')) {
                return;
            }

            try {
                const response = await fetch('/api/demo/clear', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    console.log('‚úì Demo files cleared:', data);
                    alert('Demo files cleared!');
                } else {
                    console.error('‚úó Failed to clear demo:', data);
                    alert('Failed to clear demo: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error clearing demo:', error);
                alert('Error clearing demo: ' + error.message);
            }
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will PERMANENTLY delete:\n\n' +
                        '‚Ä¢ All action logs\n' +
                        '‚Ä¢ All service registrations\n' +
                        '‚Ä¢ All task history\n' +
                        '‚Ä¢ All demo files\n\n' +
                        'This CANNOT be undone!\n\n' +
                        'Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/clear-all', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    console.log('‚úì All data cleared:', data);
                    alert(`All data cleared!\n\n${data.action_logs_deleted} action logs deleted\n${data.services_deleted} services deleted\n\nRefresh the page to see updated state.`);
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to clear demo data');
                }
            } catch (error) {
                console.error('Failed to clear all data:', error);
                alert('Failed to clear all data: ' + error.message);
            }
        }

        function clearAllDataConfirm() {
            clearAllData();
        }

        async function restartHMI() {
            if (!confirm('‚ö†Ô∏è FULL SYSTEM RESTART ‚ö†Ô∏è\n\nThis will restart ALL services:\n‚Ä¢ Gateway (6120)\n‚Ä¢ PAS Root (6100)\n‚Ä¢ Aider-LCO (6130)\n‚Ä¢ Registry (6121)\n‚Ä¢ Heartbeat Monitor (6109)\n‚Ä¢ Resource Manager (6104)\n‚Ä¢ Token Governor (6105)\n‚Ä¢ HMI Dashboard (6101)\n\nThe page will disconnect for ~15 seconds.\n\nContinue?')) {
                return;
            }

            try {
                alert('üîÑ Full system restart initiated...\n\nAll services will restart in ~15 seconds.\n\nThe page will reload automatically.');
                const response = await fetch('/api/admin/restart-services', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    console.log('‚úì Full system restart initiated:', data);
                    // Wait 15 seconds for all services to restart
                    setTimeout(() => {
                        alert('‚úÖ Services restarted! Reloading page...');
                        window.location.reload();
                    }, 15000);
                } else {
                    alert('‚ùå Failed to restart services: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error restarting services:', error);
                alert('‚ùå Error restarting services: ' + error.message);
            }
        }

        // Check demo status on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/demo/status');
                const data = await response.json();

                if (data.running) {
                    demoRunning = true;
                    document.getElementById('start-demo-button').style.display = 'none';
                    document.getElementById('stop-demo-button').style.display = 'inline-block';
                    document.getElementById('master-stop-button').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Failed to check demo status:', error);
            }
        });
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
