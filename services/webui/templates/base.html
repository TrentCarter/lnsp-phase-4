<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PAS Agent Swarm HMI{% endblock %}</title>

    <!-- D3.js for tree visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Chart.js for metrics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hmi.css') }}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0a0e27;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            padding: 1rem 2rem;
            border-bottom: 2px solid #4a5578;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.ok {
            background-color: #10b981;
            color: white;
        }

        .status-badge.warning {
            background-color: #f59e0b;
            color: white;
        }

        .status-badge.error {
            background-color: #ef4444;
            color: white;
        }

        /* Task Status Indicator */
        .task-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(30, 39, 71, 0.6);
            border-radius: 8px;
            border: 1px solid #3a4568;
            max-width: 350px;
        }

        .task-status-led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.3);
            flex-shrink: 0;
        }

        .task-status-led.running {
            background-color: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
            animation: pulse-led 2s ease-in-out infinite;
        }

        .task-status-led.done {
            background-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        .task-status-led.error {
            background-color: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
            animation: pulse-led 1s ease-in-out infinite;
        }

        .task-status-led.waiting {
            background-color: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
        }

        .task-status-led.idle {
            background-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.3);
        }

        @keyframes pulse-led {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .task-status-text {
            display: flex;
            flex-direction: column;
            min-width: 0;
            flex: 1;
        }

        .task-status-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-status-label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav {
            display: flex;
            gap: 1rem;
        }

        .nav a {
            color: #a0aec0;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav a:hover, .nav a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .settings-button {
            background: transparent;
            border: 1px solid #4a5578;
            color: #a0aec0;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .settings-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: #6b7280;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%);
            border: 1px solid #3a4568;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .metric-card h3 {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
        }

        .metric-card .subtext {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .alert-banner {
            background-color: #7c2d12;
            border: 1px solid #dc2626;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-banner.warning {
            background-color: #713f12;
            border-color: #f59e0b;
        }

        .alert-banner.info {
            background-color: #1e3a8a;
            border-color: #3b82f6;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            font-size: 0.875rem;
            color: #d1d5db;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6b7280;
        }

        .connection-dot.connected {
            background-color: #10b981;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes tronPulse {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: linear-gradient(135deg, #1e2747 0%, #2a3558 100%);
            border: 2px solid #4a5578;
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            display: flex;
            overflow: hidden;
        }

        .settings-sidebar {
            width: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid #4a5578;
            padding: 1rem 0 0 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar-item {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            color: #9ca3af;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .settings-sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
        }

        .settings-sidebar-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border-left-color: #3b82f6;
            font-weight: 500;
        }

        .settings-main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .settings-page {
            display: none;
        }

        .settings-page.active {
            display: block;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #4a5578;
        }

        .settings-header h2 {
            color: #fff;
            font-size: 1.5rem;
        }

        .close-button {
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .settings-section {
            margin-bottom: 1.5rem;
        }

        .settings-section h3 {
            color: #e0e0e0;
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #3a4568;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: #d1d5db;
            font-size: 0.875rem;
        }

        .setting-description {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-input {
            background-color: #1a1f3a;
            border: 1px solid #4a5578;
            color: #e0e0e0;
            padding: 0.5rem;
            border-radius: 6px;
            width: 80px;
            text-align: center;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background-color: #4a5578;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .toggle-switch.active {
            background-color: #10b981;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .setting-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .setting-button.danger {
            background-color: #ef4444;
        }

        .setting-button.danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }

        .setting-button.warning {
            background-color: #f59e0b;
        }

        .setting-button.warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
        }

        .settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #4a5578;
        }

        .settings-button-primary {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .settings-button-primary:hover {
            background-color: #2563eb;
        }

        .settings-button-secondary {
            background-color: transparent;
            color: #9ca3af;
            border: 1px solid #4a5578;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .settings-button-secondary:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
        }
    </style>

    {% block extra_styles %}{% endblock %}
</head>
<body>
    <header class="header">
        <h1>
            <span>ü§ñ</span>
            PAS Agent Swarm
            <span id="global-status" class="status-badge ok">OK</span>
        </h1>

        <!-- Task Status Indicator -->
        <div id="task-status" class="task-status" style="display: none;">
            <div id="task-status-led" class="task-status-led idle"></div>
            <div class="task-status-text">
                <div id="task-status-name" class="task-status-name">No active task</div>
                <div id="task-status-label" class="task-status-label">IDLE</div>
            </div>
        </div>

        <nav class="nav">
            <a href="/" {% if request.path == '/' %}class="active"{% endif %}>Dashboard</a>
            <a href="/tree" {% if request.path == '/tree' %}class="active"{% endif %}>Tree View</a>
            <a href="/sequencer" {% if request.path == '/sequencer' %}class="active"{% endif %}>Sequencer</a>
            <a href="/actions" {% if request.path == '/actions' %}class="active"{% endif %}>Actions</a>
            <button id="start-demo-button" class="settings-button" onclick="startDemo()" style="background: #10b981;">‚ñ∂Ô∏è Start Demo</button>
            <button id="prime-directive-button" class="settings-button" onclick="startPrimeDirective()" style="background: #3b82f6;" title="Send real Prime Directive to PAS Root">üöÄ Prime Directive</button>
            <button id="stop-demo-button" class="settings-button" onclick="stopDemo()" style="background: #ef4444; display: none;">‚èπÔ∏è Stop Demo</button>
            <button id="master-stop-button" class="settings-button" onclick="masterStopDemo()" style="background: #dc2626; display: none; font-weight: bold; border: 2px solid #fbbf24;" title="EMERGENCY: Force kill ALL demo processes immediately">üõë MASTER STOP</button>
            <button class="settings-button" onclick="clearAllData()" style="background: #ef4444;">üóëÔ∏è Clear All Data</button>
            <button id="audio-init-button" class="settings-button" onclick="initAudioManual()" style="display: none;">üîä Enable Sound</button>
            <button class="settings-button" onclick="openSettings()">‚öôÔ∏è Settings</button>
        </nav>
        <div class="connection-status">
            <div id="connection-dot" class="connection-dot"></div>
            <span id="connection-text">Connecting...</span>
        </div>
    </header>

    <!-- TRON HHMRS Visualization Bar -->
    <div id="tron-bar" style="
        display: none;
        position: fixed;
        top: var(--header-height, 60px);
        left: 0;
        right: 0;
        height: 24px;
        background: linear-gradient(90deg, #ff6c00 0%, #ff8c00 100%);
        border-bottom: 1px solid #ff4500;
        z-index: 9999;
        align-items: center;
        padding: 0 0.75rem;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #000;
        box-shadow: 0 2px 8px rgba(255, 108, 0, 0.5);
    ">
        <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
            <span style="font-size: 0.75rem; letter-spacing: 0.03em;">‚ö° TRON</span>
            <div id="tron-event-list" style="display: flex; gap: 0.4rem; flex: 1;"></div>
        </div>
        <div style="font-size: 0.65rem; opacity: 0.8; margin-right: 0.5rem;">HHMRS Phase 1</div>
        <button id="tron-dismiss" onclick="dismissTronBar()" style="
            background: transparent;
            border: none;
            color: #000;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
        " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">‚úï</button>
    </div>

    <main style="margin-top: 0;">
        {% block content %}{% endblock %}
    </main>

    <!-- Tooltip for port/health check details -->
    <div id="system-tooltip" style="
        position: fixed;
        background: #1e293b;
        border: 2px solid #4a5578;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 0.875rem;
        color: #e0e0e0;
        pointer-events: none;
        z-index: 20000;
        display: none;
        min-width: 200px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    "></div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <!-- Sidebar Navigation -->
            <div class="settings-sidebar">
                <div class="settings-sidebar-item active" onclick="switchSettingsPage('general')">
                    <span>üè†</span>
                    <span>General</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('display')">
                    <span>üé®</span>
                    <span>Display</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('tree')">
                    <span>üå≥</span>
                    <span>Tree View</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('sequencer')">
                    <span>üéπ</span>
                    <span>Sequencer</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('audio')">
                    <span>üîä</span>
                    <span>Audio</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('hhmrs')">
                    <span>‚ö°</span>
                    <span>HHMRS</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('tasks')">
                    <span>üìã</span>
                    <span>Tasks</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('llm')">
                    <span>ü§ñ</span>
                    <span>LLM Models</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('model-pool')">
                    <span>üî•</span>
                    <span>Model Pool</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('advanced')">
                    <span>‚öôÔ∏è</span>
                    <span>Advanced</span>
                </div>
                <div class="settings-sidebar-item" onclick="switchSettingsPage('system')">
                    <span>üõ†Ô∏è</span>
                    <span>System Status</span>
                </div>

                <!-- Save Button at Bottom -->
                <div style="padding: 1.25rem; margin-top: auto; border-top: 1px solid #4a5578;">
                    <button onclick="saveSettings()" style="width: 100%; padding: 0.75rem; font-size: 0.875rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üíæ Save Changes</button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="settings-main">
                <div class="settings-header">
                    <h2 id="settings-page-title">‚öôÔ∏è General</h2>
                    <button class="close-button" onclick="closeSettings()">‚úï</button>
                </div>

                <!-- General Page -->
                <div id="page-general" class="settings-page active">
                    <!-- Auto-Refresh Settings -->
                    <div class="settings-section">
                <h3>üîÑ Auto-Refresh</h3>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Enable Auto-Refresh</div>
                        <div class="setting-description">Automatically update data without manual refresh</div>
                    </div>
                    <div class="setting-control">
                        <div id="auto-refresh-toggle" class="toggle-switch" onclick="toggleAutoRefresh()"></div>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Refresh Interval</div>
                        <div class="setting-description">Time between auto-refreshes (0 = instant/fast, seconds)</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="refresh-interval" class="setting-input" min="0" max="600" value="0">
                        <span style="color: #9ca3af; font-size: 0.875rem;">sec</span>
                    </div>
                </div>
            </div>

                    <!-- Performance Settings -->
                    <div class="settings-section">
                        <h3>‚ö° Performance</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Animation Duration</div>
                                <div class="setting-description">Transition speed for visual updates (milliseconds)</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="animation-duration" class="setting-input" min="0" max="2000" step="100" value="750">
                                <span style="color: #9ca3af; font-size: 0.875rem;">ms</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Display Page -->
                <div id="page-display" class="settings-page">
                    <div class="settings-section">
                        <h3>üé® Display</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Show Tooltips</div>
                                <div class="setting-description">Display detailed information on hover</div>
                            </div>
                            <div class="setting-control">
                                <div id="tooltips-toggle" class="toggle-switch active" onclick="toggleTooltips()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Compact Mode</div>
                                <div class="setting-description">Reduce spacing for more information density</div>
                            </div>
                            <div class="setting-control">
                                <div id="compact-toggle" class="toggle-switch" onclick="toggleCompactMode()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Time Zone</div>
                                <div class="setting-description">Display time zone for timestamps</div>
                            </div>
                            <div class="setting-control">
                                <select id="timezone-select" class="setting-input" style="width: 140px;">
                                    <option value="America/New_York">EST (US Eastern)</option>
                                    <option value="America/Chicago">CST (US Central)</option>
                                    <option value="America/Denver">MST (US Mountain)</option>
                                    <option value="America/Los_Angeles">PST (US Pacific)</option>
                                    <option value="UTC">UTC</option>
                                    <option value="Europe/London">GMT (London)</option>
                                    <option value="Asia/Tokyo">JST (Tokyo)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tree View Page -->
                <div id="page-tree" class="settings-page">
                    <!-- Tree View Settings -->
                    <div class="settings-section">
                        <h3>üå≥ Tree View</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Tree Orientation</div>
                                <div class="setting-description">Default layout orientation for tree visualization</div>
                            </div>
                            <div class="setting-control">
                                <select id="tree-orientation" class="setting-input" style="width: 140px;">
                                    <option value="top" selected>Top</option>
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                    <option value="bottom">Bottom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sequencer Page -->
                <div id="page-sequencer" class="settings-page">
            <!-- Sequencer Settings -->
            <div class="settings-section">
                <h3>üéπ Sequencer</h3>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Hide Scrollbars</div>
                        <div class="setting-description">Use draggable playhead instead of scrollbars</div>
                    </div>
                    <div class="setting-control">
                        <div id="hide-scrollbars-toggle" class="toggle-switch active" onclick="toggleHideScrollbars()"></div>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Default Playback Speed</div>
                        <div class="setting-description">Initial playback speed multiplier</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="default-playback-speed" class="setting-input" min="0.1" max="1000" step="0.1" value="1.0">
                        <span style="color: #9ca3af; font-size: 0.875rem;">x (0.1x-1000x range)</span>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Default Sound Mode</div>
                        <div class="setting-description">Default sound output mode</div>
                    </div>
                    <div class="setting-control">
                        <select id="default-sound-mode" class="setting-input" style="width: 140px;">
                            <option value="none" selected>None</option>
                            <option value="voice">Voice</option>
                            <option value="music">Music Note</option>
                            <option value="random">Random Sounds</option>
                            <option value="geiger">Geiger Counter</option>
                        </select>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Auto-Detect New Tasks</div>
                        <div class="setting-description">Automatically switch to new tasks and start playback</div>
                    </div>
                    <div class="setting-control">
                        <div id="new-task-poll-toggle" class="toggle-switch active" onclick="toggleNewTaskPoll()"></div>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">New Task Poll Interval</div>
                        <div class="setting-description">How often to check for new tasks (seconds)</div>
                    </div>
                    <div class="setting-control">
                        <input type="number" id="new-task-poll-interval" class="setting-input" min="1" max="60" value="5">
                        <span style="color: #9ca3af; font-size: 0.875rem;">sec</span>
                    </div>
                    </div>
                </div>
                </div>

                <!-- Audio Page -->
                <div id="page-audio" class="settings-page">
                    <div class="settings-section">
                        <h3>üîä Audio</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Master Audio</div>
                                <div class="setting-description">Enable all sound output</div>
                            </div>
                            <div class="setting-control">
                                <div id="master-audio-toggle" class="toggle-switch" onclick="toggleMasterAudio()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Sequencer Notes</div>
                                <div class="setting-description">Musical notes for task events (assign, start, complete)</div>
                            </div>
                            <div class="setting-control">
                                <div id="sequencer-notes-toggle" class="toggle-switch" onclick="toggleSequencerNotes()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Agent Voice Status</div>
                                <div class="setting-description">Text-to-speech narration of agent updates</div>
                            </div>
                            <div class="setting-control">
                                <div id="agent-voice-toggle" class="toggle-switch" onclick="toggleAgentVoice()"></div>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Audio Volume</div>
                                <div class="setting-description">Master volume level (0-100%)</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="audio-volume" class="setting-input" min="0" max="100" value="70" style="width: 120px;">
                                <span id="volume-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">70%</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Note Duration</div>
                                <div class="setting-description">Duration of musical notes in milliseconds (50-500ms)</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="note-duration" class="setting-input" min="50" max="500" value="150" step="10" style="width: 120px;">
                                <span id="note-duration-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 50px;">150ms</span>
                            </div>
                        </div>
                    </div>

                    <!-- TRON Chime Notifications Subsection -->
                    <div class="settings-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #3a4568;">
                        <h3>üîî TRON Chime Notifications</h3>

                        <!-- Enable Chime Notifications -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Enable Chime Notifications</div>
                                <div class="setting-description">Play chime sounds for HHMRS intervention events</div>
                            </div>
                            <div class="setting-control">
                                <div id="chime-enabled-toggle" class="toggle-switch" onclick="toggleChimeEnabled()"></div>
                            </div>
                        </div>

                        <!-- Chime Sound Selection -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Chime Sound</div>
                                <div class="setting-description">Sound type for TRON notifications</div>
                            </div>
                            <div class="setting-control" style="display: flex; gap: 10px; align-items: center;">
                                <select id="chime-sound" class="setting-input" style="width: 150px;">
                                    <option value="ping">Ping (soft)</option>
                                    <option value="bell">Bell (medium)</option>
                                    <option value="chime">Chime (pleasant)</option>
                                    <option value="alert">Alert (attention)</option>
                                    <option value="alarm">Alarm (urgent)</option>
                                </select>
                                <button id="test-chime-btn" onclick="testChime()" style="padding: 5px 15px; cursor: pointer; background: #2f80ed; color: white; border: none; border-radius: 4px; font-size: 0.875rem;">
                                    üîä Test Sound
                                </button>
                            </div>
                        </div>

                        <!-- Chime Volume -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Chime Volume</div>
                                <div class="setting-description">Volume level for chime notifications (0-100%)</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="chime-volume" class="setting-input" min="0" max="100" value="50" style="width: 120px;" oninput="document.getElementById('chime-volume-display').textContent = this.value + '%'">
                                <span id="chime-volume-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">50%</span>
                            </div>
                        </div>

                        <!-- Chime Event Triggers -->
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #2a3558;">
                            <div style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 0.75rem;">Chime on these events:</div>

                            <div class="setting-row" style="margin-bottom: 0.5rem;">
                                <div>
                                    <div class="setting-label">Timeout Detection</div>
                                    <div class="setting-description">Agent misses heartbeat threshold</div>
                                </div>
                                <div class="setting-control">
                                    <div id="chime-on-timeout-toggle" class="toggle-switch" onclick="toggleChimeOnTimeout()"></div>
                                </div>
                            </div>

                            <div class="setting-row" style="margin-bottom: 0.5rem;">
                                <div>
                                    <div class="setting-label">Agent Restart</div>
                                    <div class="setting-description">TRON restarts a failed agent</div>
                                </div>
                                <div class="setting-control">
                                    <div id="chime-on-restart-toggle" class="toggle-switch" onclick="toggleChimeOnRestart()"></div>
                                </div>
                            </div>

                            <div class="setting-row" style="margin-bottom: 0.5rem;">
                                <div>
                                    <div class="setting-label">Escalation to Parent</div>
                                    <div class="setting-description">Task escalated after max restarts</div>
                                </div>
                                <div class="setting-control">
                                    <div id="chime-on-escalation-toggle" class="toggle-switch" onclick="toggleChimeOnEscalation()"></div>
                                </div>
                            </div>

                            <div class="setting-row" style="margin-bottom: 0.5rem;">
                                <div>
                                    <div class="setting-label">Permanent Failure</div>
                                    <div class="setting-description">Task fails after all retries exhausted</div>
                                </div>
                                <div class="setting-control">
                                    <div id="chime-on-failure-toggle" class="toggle-switch" onclick="toggleChimeOnFailure()"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HHMRS Page -->
                <div id="page-hhmrs" class="settings-page">
                    <div class="settings-section">
                        <h3>‚ö° Health & Heartbeat Monitoring (HHMRS)</h3>
                        <p style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 1.5rem;">
                            Configure timeout detection, automatic restarts, and LLM retry strategies for PAS agents.
                        </p>

                        <!-- Heartbeat Interval -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Heartbeat Interval</div>
                                <div class="setting-description">How often agents send health check signals (seconds)</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="hhmrs-heartbeat-interval" class="setting-input" min="5" max="120" value="30">
                                <span style="color: #9ca3af; font-size: 0.875rem;">sec</span>
                            </div>
                        </div>

                        <!-- Timeout Threshold -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Timeout Threshold</div>
                                <div class="setting-description">Time without heartbeat before timeout detected (seconds)</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="hhmrs-timeout-threshold" class="setting-input" min="10" max="300" value="60">
                                <span style="color: #9ca3af; font-size: 0.875rem;">sec</span>
                            </div>
                        </div>

                        <!-- Max Restarts -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Max Restarts</div>
                                <div class="setting-description">Maximum child agent restart attempts before escalation</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="hhmrs-max-restarts" class="setting-input" min="1" max="10" value="3">
                                <span style="color: #9ca3af; font-size: 0.875rem;">restarts</span>
                            </div>
                        </div>

                        <!-- Max LLM Retries -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Max LLM Retries</div>
                                <div class="setting-description">Maximum LLM model switches before permanent failure</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="hhmrs-max-llm-retries" class="setting-input" min="1" max="10" value="3">
                                <span style="color: #9ca3af; font-size: 0.875rem;">retries</span>
                            </div>
                        </div>

                        <!-- Enable Auto Restart -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Enable Auto Restart</div>
                                <div class="setting-description">Automatically restart failed child agents</div>
                            </div>
                            <div class="setting-control">
                                <div id="hhmrs-auto-restart-toggle" class="toggle-switch active" onclick="toggleHHMRSAutoRestart()"></div>
                            </div>
                        </div>

                        <!-- Enable LLM Switching -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Enable LLM Switching</div>
                                <div class="setting-description">Try different LLM models after max restarts exceeded</div>
                            </div>
                            <div class="setting-control">
                                <div id="hhmrs-llm-switching-toggle" class="toggle-switch active" onclick="toggleHHMRSLLMSwitching()"></div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #3a4568;">
                            <button onclick="saveHHMRSSettings()" style="padding: 10px 20px; cursor: pointer; background: #2f80ed; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500;">
                                üíæ Save HHMRS Settings
                            </button>
                            <span id="hhmrs-save-status" style="margin-left: 1rem; color: #9ca3af; font-size: 0.875rem;"></span>
                        </div>

                        <!-- Information Box -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(47, 128, 237, 0.1); border: 1px solid rgba(47, 128, 237, 0.3); border-radius: 6px;">
                            <div style="color: #60a5fa; font-weight: 500; margin-bottom: 0.5rem;">‚ÑπÔ∏è How HHMRS Works</div>
                            <div style="color: #9ca3af; font-size: 0.875rem; line-height: 1.5;">
                                <strong>Level 1 (Child Restart):</strong> When an agent times out, parent restarts it up to <strong>max_restarts</strong> times.<br>
                                <strong>Level 2 (LLM Switching):</strong> After max restarts exceeded, task escalates to grandparent who switches to a different LLM model, up to <strong>max_llm_retries</strong> times.<br>
                                <strong>Level 3 (Permanent Failure):</strong> After all retries exhausted, task permanently fails and Gateway is notified.<br><br>
                                <strong>Total attempts:</strong> max_restarts √ó max_llm_retries (default: 3 √ó 3 = 9 attempts)<br>
                                <strong>Estimated worst-case time:</strong> ~6-9 minutes for graceful failure detection
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tasks Page -->
                <div id="page-tasks" class="settings-page">
                    <div class="settings-section">
                        <h3>üìã Task Management</h3>

                        <!-- Task Timeout -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Task Timeout</div>
                                <div class="setting-description">Maximum duration before marking task as failed (minutes)</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="task-timeout" class="setting-input" min="5" max="480" value="30">
                                <span style="color: #9ca3af; font-size: 0.875rem;">min</span>
                            </div>
                        </div>

                        <!-- Max Concurrent Tasks -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Max Concurrent Tasks</div>
                                <div class="setting-description">Maximum number of tasks that can run simultaneously</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="max-concurrent-tasks" class="setting-input" min="1" max="20" value="5">
                            </div>
                        </div>

                        <!-- Enable Task Priority -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Enable Task Priority Queue</div>
                                <div class="setting-description">Process high-priority tasks before low-priority tasks</div>
                            </div>
                            <div class="setting-control">
                                <div id="task-priority-toggle" class="toggle-switch"></div>
                            </div>
                        </div>

                        <!-- Auto Archive Completed -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Auto-archive Completed Tasks</div>
                                <div class="setting-description">Automatically move completed tasks to archive after 24 hours</div>
                            </div>
                            <div class="setting-control">
                                <div id="auto-archive-toggle" class="toggle-switch"></div>
                            </div>
                        </div>

                        <!-- Auto Cleanup Days -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Auto-cleanup After</div>
                                <div class="setting-description">Delete archived tasks older than this many days</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="cleanup-days" class="setting-input" min="1" max="90" value="7">
                                <span style="color: #9ca3af; font-size: 0.875rem;">days</span>
                            </div>
                        </div>

                        <!-- Retry Failed Tasks -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Auto-retry Failed Tasks</div>
                                <div class="setting-description">Automatically retry tasks that fail due to transient errors</div>
                            </div>
                            <div class="setting-control">
                                <div id="retry-tasks-toggle" class="toggle-switch"></div>
                            </div>
                        </div>

                        <!-- Max Task Retries -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Max Task Retries</div>
                                <div class="setting-description">Maximum number of automatic retries for failed tasks</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="max-retries" class="setting-input" min="0" max="5" value="2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLM Models Page -->
                <div id="page-llm" class="settings-page">
                    <!-- LLM Model Selection Settings -->
                    <div class="settings-section">
                        <h3>ü§ñ LLM Model Selection</h3>

                        <!-- Table Header -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #4a5578;">
                            <div style="color: #e0e0e0; font-weight: 600; font-size: 0.875rem;">Agent Type</div>
                            <div style="color: #e0e0e0; font-weight: 600; font-size: 0.875rem;">Primary Model</div>
                            <div style="color: #e0e0e0; font-weight: 600; font-size: 0.875rem;">Backup Model</div>
                        </div>

                        <!-- Architect Row -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                            <div>
                                <div style="color: #e0e0e0; font-weight: 500;">üèõÔ∏è Architect</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">High-level planning</div>
                            </div>
                            <div>
                                <select id="architect-primary" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                            <div>
                                <select id="architect-fallback" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                        </div>

                        <!-- Director Row -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                            <div>
                                <div style="color: #e0e0e0; font-weight: 500;">üé¨ Director</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">Lane coordination</div>
                            </div>
                            <div>
                                <select id="director-primary" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                            <div>
                                <select id="director-fallback" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                        </div>

                        <!-- Manager Row -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                            <div>
                                <div style="color: #e0e0e0; font-weight: 500;">üìã Manager</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">Task breakdown</div>
                            </div>
                            <div>
                                <select id="manager-primary" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                            <div>
                                <select id="manager-fallback" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                        </div>

                        <!-- Programmer Row -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                            <div>
                                <div style="color: #e0e0e0; font-weight: 500;">üíª Programmer</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">Code execution</div>
                            </div>
                            <div>
                                <select id="programmer-primary" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                            <div>
                                <select id="programmer-fallback" class="setting-input" style="width: 100%;">
                                    <option value="auto">üîÑ Auto Select</option>
                                </select>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #4a5578;">
                            <button onclick="saveModelPreferences()" style="padding: 0.5rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem;">üíæ Save Model Preferences</button>
                        </div>
                    </div>
                </div>

                <!-- Model Pool Page -->
                <div id="page-model-pool" class="settings-page">
                    <!-- Pool Overview -->
                    <div class="settings-section">
                        <h3>üî• Model Pool Status</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #1e293b; border: 1px solid #4a5578; border-radius: 8px; padding: 1rem;">
                                <div style="color: #9ca3af; font-size: 0.75rem; margin-bottom: 0.25rem;">Active Models</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #10b981;" id="pool-active-count">-</div>
                            </div>
                            <div style="background: #1e293b; border: 1px solid #4a5578; border-radius: 8px; padding: 1rem;">
                                <div style="color: #9ca3af; font-size: 0.75rem; margin-bottom: 0.25rem;">Total Memory</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #3b82f6;" id="pool-memory">-</div>
                            </div>
                            <div style="background: #1e293b; border: 1px solid #4a5578; border-radius: 8px; padding: 1rem;">
                                <div style="color: #9ca3af; font-size: 0.75rem; margin-bottom: 0.25rem;">Available Ports</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #f59e0b;" id="pool-available-ports">-</div>
                            </div>
                            <div style="background: #1e293b; border: 1px solid #4a5578; border-radius: 8px; padding: 1rem;">
                                <div style="color: #9ca3af; font-size: 0.75rem; margin-bottom: 0.25rem;">Pool Status</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #8b5cf6;" id="pool-status">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Pool Configuration -->
                    <div class="settings-section">
                        <h3>‚öôÔ∏è Pool Configuration</h3>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Default TTL</div>
                                <div class="setting-description">Minutes of inactivity before model unload (0 = never unload)</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="pool-default-ttl" class="setting-input" min="0" max="60" step="5" value="15">
                                <span style="color: #9ca3af; font-size: 0.875rem;">min</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Max Concurrent Models</div>
                                <div class="setting-description">Maximum number of models loaded simultaneously</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="pool-max-concurrent" class="setting-input" min="1" max="10" value="5">
                                <span style="color: #9ca3af; font-size: 0.875rem;">models</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Check Interval</div>
                                <div class="setting-description">Seconds between TTL checks and auto-unloading</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="pool-check-interval" class="setting-input" min="10" max="300" step="10" value="30">
                                <span style="color: #9ca3af; font-size: 0.875rem;">sec</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #4a5578;">
                            <button onclick="savePoolConfig()" style="padding: 0.5rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem;">üíæ Save Configuration</button>
                        </div>
                    </div>

                    <!-- Model Cards -->
                    <div class="settings-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>ü§ñ Registered Models</h3>
                            <button onclick="refreshModelPool()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">üîÑ Refresh</button>
                        </div>
                        <div id="model-cards-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                            <!-- Model cards will be populated here -->
                            <div style="grid-column: 1 / -1; text-align: center; color: #9ca3af; padding: 2rem;">
                                Loading models...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Models Page -->
                <div id="page-advanced" class="settings-page">
                    <div class="settings-section">
                        <h3>‚öôÔ∏è Advanced Model Settings</h3>
                        <p style="color: #9ca3af; margin-bottom: 1.5rem;">Configure advanced parameters for LLM inference.</p>

                        <!-- Temperature -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Temperature</div>
                                <div class="setting-description">Controls randomness (0.0-2.0). Lower = more focused, Higher = more creative</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="llm-temperature" class="setting-input" min="0" max="2" step="0.1" value="0.7" style="width: 120px;">
                                <span id="temperature-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">0.7</span>
                            </div>
                        </div>

                        <!-- Max Tokens -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Max Tokens</div>
                                <div class="setting-description">Maximum number of tokens to generate (100-8000)</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="llm-max-tokens" class="setting-input" min="100" max="8000" step="100" value="2000">
                                <span style="color: #9ca3af; font-size: 0.875rem;">tokens</span>
                            </div>
                        </div>

                        <!-- Top P -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Top P (Nucleus Sampling)</div>
                                <div class="setting-description">Controls diversity (0.0-1.0). Lower = more focused</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="llm-top-p" class="setting-input" min="0" max="1" step="0.05" value="0.9" style="width: 120px;">
                                <span id="top-p-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">0.9</span>
                            </div>
                        </div>

                        <!-- Top K -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Top K</div>
                                <div class="setting-description">Limits token choices (1-100). Lower = more focused</div>
                            </div>
                            <div class="setting-control">
                                <input type="number" id="llm-top-k" class="setting-input" min="1" max="100" value="40">
                                <span style="color: #9ca3af; font-size: 0.875rem;">tokens</span>
                            </div>
                        </div>

                        <!-- Frequency Penalty -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Frequency Penalty</div>
                                <div class="setting-description">Reduces repetition (-2.0 to 2.0). Higher = less repetition</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="llm-frequency-penalty" class="setting-input" min="-2" max="2" step="0.1" value="0" style="width: 120px;">
                                <span id="frequency-penalty-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">0.0</span>
                            </div>
                        </div>

                        <!-- Presence Penalty -->
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Presence Penalty</div>
                                <div class="setting-description">Encourages new topics (-2.0 to 2.0). Higher = more diverse</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" id="llm-presence-penalty" class="setting-input" min="-2" max="2" step="0.1" value="0" style="width: 120px;">
                                <span id="presence-penalty-display" style="color: #9ca3af; font-size: 0.875rem; min-width: 40px;">0.0</span>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div style="display: flex; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #4a5578;">
                            <button onclick="saveAdvancedModelSettings()" style="padding: 0.5rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem;">üíæ Save Advanced Settings</button>
                        </div>
                    </div>
                </div>

                <!-- System Page -->
                <div id="page-system" class="settings-page">
                    <!-- Overall System Health -->
                    <div class="settings-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>üõ†Ô∏è System Status</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="copySystemSummaryToClipboard()" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">üìã Copy Summary</button>
                                <button onclick="refreshSystemStatus()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">üîÑ Refresh</button>
                            </div>
                        </div>
                        <div style="background: #1e293b; border: 2px solid #4a5578; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                            <div style="font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem;" id="overall-health-score">--%</div>
                            <div style="font-size: 1rem; color: #9ca3af;" id="overall-health-status">Checking system health...</div>
                            <div style="margin-top: 1rem; height: 8px; background: #374151; border-radius: 4px; overflow: hidden;">
                                <div id="overall-health-bar" style="height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); width: 0%; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Port Status Grid -->
                    <div class="settings-section">
                        <h3>üîå Port Status</h3>
                        <div style="margin-bottom: 1rem;">
                            <span style="font-size: 0.875rem; color: #9ca3af;">Hover over ports for details</span>
                        </div>
                        <div id="port-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">
                            <!-- Ports will be populated here -->
                        </div>
                        <div style="display: flex; gap: 1.5rem; font-size: 0.75rem; color: #9ca3af; margin-top: 1rem;">
                            <div><span style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 2px; margin-right: 0.25rem;"></span> UP</div>
                            <div><span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 2px; margin-right: 0.25rem;"></span> DOWN</div>
                            <div><span style="display: inline-block; width: 12px; height: 12px; background: #f59e0b; border-radius: 2px; margin-right: 0.25rem;"></span> DEGRADED</div>
                            <div><span style="display: inline-block; width: 12px; height: 12px; background: #6b7280; border-radius: 2px; margin-right: 0.25rem;"></span> UNKNOWN</div>
                        </div>
                    </div>

                    <!-- System Health Checks -->
                    <div class="settings-section">
                        <h3>‚úÖ Health Checks</h3>
                        <div id="health-checks-container" style="display: grid; gap: 0.75rem;">
                            <!-- Health checks will be populated here -->
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="settings-section">
                        <h3>‚ö° Quick Actions</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                            <button onclick="restartAllServices()" style="padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üîÑ Restart All Services</button>
                            <button onclick="clearCachesAndTemp()" style="padding: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üßπ Clear Caches</button>
                            <button onclick="runGitGC()" style="padding: 0.75rem; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">‚ôªÔ∏è Git Cleanup</button>
                            <button onclick="exportSystemReport()" style="padding: 0.75rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üìä Export Report</button>
                        </div>
                    </div>
                </div>

                <!-- End of settings-main -->
            </div>
        </div>
    </div>

    <!-- Base WebSocket connection -->
    <script>
        // Global WebSocket connection
        let socket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        function connectWebSocket() {
            const connectionDot = document.getElementById('connection-dot');
            const connectionText = document.getElementById('connection-text');

            socket = io('http://localhost:6102', {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: MAX_RECONNECT_ATTEMPTS
            });

            socket.on('connect', () => {
                console.log('WebSocket connected');
                connectionDot.classList.add('connected');
                connectionText.textContent = 'Connected';
                reconnectAttempts = 0;
            });

            socket.on('disconnect', () => {
                console.log('WebSocket disconnected');
                connectionDot.classList.remove('connected');
                connectionText.textContent = 'Disconnected';
            });

            socket.on('connected', (data) => {
                console.log('Server acknowledged connection:', data);
            });

            socket.on('event', (event) => {
                console.log('Received event:', event);
                handleRealtimeEvent(event);
            });

            socket.on('event_history', (events) => {
                console.log('Received event history:', events.length, 'events');
                events.forEach(handleRealtimeEvent);
            });

            socket.on('pong', (data) => {
                console.log('Pong received:', data);
            });
        }

        // Override this function in child templates
        function handleRealtimeEvent(event) {
            console.log('Base handler received event:', event.event_type);

            // Handle HHMRS events (timeout, restart, escalation, failure)
            if (event.event_type && event.event_type.startsWith('hhmrs_')) {
                handleHHMRSEvent(event);
            }

            // Update task status on relevant events
            if (['job_started', 'task_started', 'job_completed', 'task_completed', 'heartbeat', 'error', 'blocked'].includes(event.event_type)) {
                fetchCurrentTask();
            }
        }

        // Handle HHMRS intervention events (chimes + TRON visualization)
        function handleHHMRSEvent(event) {
            const eventType = event.event_type;
            const data = event.data || {};
            const settings = getSettings();

            console.log('üîî HHMRS Event:', eventType, data);

            // Play chime based on event type and settings
            if (settings.chimeEnabled) {
                const soundType = settings.chimeSound || 'ping';
                const volume = settings.chimeVolume || 50;

                // Check if this event type should trigger a chime
                const shouldPlayChime = (
                    (eventType === 'hhmrs_timeout' && settings.chimeOnTimeout) ||
                    (eventType === 'hhmrs_restart' && settings.chimeOnRestart) ||
                    (eventType === 'hhmrs_escalation' && settings.chimeOnEscalation) ||
                    (eventType === 'hhmrs_failure' && settings.chimeOnFailure)
                );

                if (shouldPlayChime) {
                    // Play the chime sound
                    playChime(soundType, volume);
                }
            }

            // Update TRON visualization bar
            updateTRONBar(eventType, data);
        }

        // Update TRON visualization bar with new event
        function updateTRONBar(eventType, data) {
            const tronBar = document.getElementById('tron-bar');
            if (!tronBar) return;

            const settings = getSettings();
            if (!settings.show_tron_status_bar) {
                tronBar.style.display = 'none';
                return;
            }

            // Check if user dismissed the banner recently (within last 5 minutes)
            const dismissedUntil = localStorage.getItem('tronBarDismissedUntil');
            if (dismissedUntil) {
                const dismissTime = parseInt(dismissedUntil);
                const now = Date.now();
                if (now < dismissTime) {
                    // Still dismissed, don't show
                    return;
                } else {
                    // Dismiss period expired, clear it
                    localStorage.removeItem('tronBarDismissedUntil');
                }
            }

            // Show TRON bar
            tronBar.style.display = 'flex';

            // Get or create event counter
            const eventCounterEl = document.getElementById('tron-event-counter');
            const eventListEl = document.getElementById('tron-event-list');

            // Add event to list (show last 5 events)
            const eventItem = document.createElement('div');
            eventItem.className = 'tron-event-item';
            eventItem.style.cssText = 'margin-right: 0.5rem; padding: 0.15rem 0.4rem; background: rgba(0, 0, 0, 0.3); border-radius: 3px; font-size: 0.65rem;';

            const eventIcon = {
                'hhmrs_timeout': '‚è±Ô∏è',
                'hhmrs_restart': 'üîÑ',
                'hhmrs_escalation': '‚¨ÜÔ∏è',
                'hhmrs_failure': '‚ùå'
            }[eventType] || 'üìå';

            const agentId = data.agent_id || 'Unknown';
            eventItem.textContent = `${eventIcon} ${agentId}`;

            // Add to beginning of list
            if (eventListEl.firstChild) {
                eventListEl.insertBefore(eventItem, eventListEl.firstChild);
            } else {
                eventListEl.appendChild(eventItem);
            }

            // Keep only last 5 events
            while (eventListEl.children.length > 5) {
                eventListEl.removeChild(eventListEl.lastChild);
            }

            // Animate the new event
            eventItem.style.animation = 'tronPulse 0.5s ease-out';

            // Auto-hide after 30 seconds of no activity
            clearTimeout(window.tronBarHideTimer);
            window.tronBarHideTimer = setTimeout(() => {
                eventListEl.innerHTML = '';  // Clear events
            }, 30000);
        }

        // Dismiss TRON bar manually
        function dismissTronBar() {
            const tronBar = document.getElementById('tron-bar');
            if (!tronBar) return;

            tronBar.style.display = 'none';

            // Clear the auto-hide timer
            clearTimeout(window.tronBarHideTimer);

            // Clear all events
            const eventListEl = document.getElementById('tron-event-list');
            if (eventListEl) {
                eventListEl.innerHTML = '';
            }

            // Save dismiss state for 5 minutes (persists across page navigation)
            const dismissUntil = Date.now() + (5 * 60 * 1000); // 5 minutes from now
            localStorage.setItem('tronBarDismissedUntil', dismissUntil.toString());
        }

        // Calculate and set header height for TRON bar positioning
        function setHeaderHeight() {
            const header = document.querySelector('.header');
            if (header) {
                const headerHeight = header.offsetHeight;
                document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
            }
        }

        // Check if TRON bar should stay hidden on page load
        function checkTronBarDismissState() {
            const dismissedUntil = localStorage.getItem('tronBarDismissedUntil');
            if (dismissedUntil) {
                const dismissTime = parseInt(dismissedUntil);
                const now = Date.now();
                if (now < dismissTime) {
                    // Still within dismiss period, keep hidden
                    const tronBar = document.getElementById('tron-bar');
                    if (tronBar) {
                        tronBar.style.display = 'none';
                    }
                } else {
                    // Dismiss period expired, clear it
                    localStorage.removeItem('tronBarDismissedUntil');
                }
            }
        }

        // Task Status Management
        let currentTaskTimer = null;

        async function fetchCurrentTask() {
            try {
                const response = await fetch('/api/current-task', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    hideTaskStatus();
                    return;
                }

                const data = await response.json();

                if (data.task) {
                    updateTaskStatus(data.task);
                } else {
                    hideTaskStatus();
                }
            } catch (error) {
                console.error('Error fetching current task:', error);
                hideTaskStatus();
            }
        }

        function updateTaskStatus(task) {
            const statusContainer = document.getElementById('task-status');
            const statusLed = document.getElementById('task-status-led');
            const statusName = document.getElementById('task-status-name');
            const statusLabel = document.getElementById('task-status-label');

            // Show the status indicator
            statusContainer.style.display = 'flex';

            // Update task name
            statusName.textContent = task.name || 'Active Task';

            // Map task status to LED class and label
            const statusMap = {
                'running': { class: 'running', label: 'RUNNING' },
                'blocked': { class: 'waiting', label: 'BLOCKED' },
                'waiting': { class: 'waiting', label: 'WAITING' },
                'awaiting_approval': { class: 'waiting', label: 'AWAITING APPROVAL' },
                'done': { class: 'done', label: 'DONE' },
                'completed': { class: 'done', label: 'COMPLETED' },
                'error': { class: 'error', label: 'ERROR' },
                'failed': { class: 'error', label: 'FAILED' },
                'stuck': { class: 'error', label: 'STUCK' },
                'idle': { class: 'idle', label: 'IDLE' }
            };

            const status = statusMap[task.status] || statusMap['idle'];

            // Update LED class
            statusLed.className = `task-status-led ${status.class}`;

            // Update label
            statusLabel.textContent = status.label;
        }

        function hideTaskStatus() {
            const statusContainer = document.getElementById('task-status');
            statusContainer.style.display = 'none';
        }

        function startTaskStatusPolling() {
            // Poll for current task every 5 seconds
            if (currentTaskTimer) {
                clearInterval(currentTaskTimer);
            }

            fetchCurrentTask(); // Initial fetch

            currentTaskTimer = setInterval(() => {
                fetchCurrentTask();
            }, 5000);
        }

        function stopTaskStatusPolling() {
            if (currentTaskTimer) {
                clearInterval(currentTaskTimer);
                currentTaskTimer = null;
            }
        }

        // Settings Management
        const DEFAULT_SETTINGS = {
            autoRefreshEnabled: true,
            refreshInterval: 0,  // 0 = instant/fast refresh for Dashboard
            showTooltips: true,
            compactMode: false,
            animationDuration: 750,
            masterAudioEnabled: false,
            sequencerNotesEnabled: false,
            agentVoiceEnabled: false,
            audioVolume: 70,
            sequencerNoteDuration: 150,  // milliseconds (50-500)
            timezone: 'America/New_York',  // EST as default
            treeOrientation: 'top',
            hideScrollbars: true,
            defaultPlaybackSpeed: 1.0,
            defaultSoundMode: 'none',
            newTaskPollEnabled: true,  // Auto-detect new tasks
            newTaskPollInterval: 5,  // Poll every 5 seconds
            taskTimeout: 30,  // minutes
            maxConcurrentTasks: 5,
            taskPriorityEnabled: true,
            autoArchiveCompleted: true,
            cleanupDays: 7,
            retryFailedTasks: true,
            maxTaskRetries: 2,
            // TRON Chime Settings
            chimeEnabled: true,
            chimeSound: 'ping',  // ping, bell, chime, alert, alarm
            chimeVolume: 50,  // 0-100
            chimeOnTimeout: true,
            chimeOnRestart: false,
            chimeOnEscalation: true,
            chimeOnFailure: true,
            // TRON Visualization
            show_tron_status_bar: true
        };

        let currentSettings = { ...DEFAULT_SETTINGS };

        function loadSettings() {
            const saved = localStorage.getItem('pas_hmi_settings');
            if (saved) {
                try {
                    currentSettings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
                } catch (e) {
                    console.error('Failed to load settings:', e);
                    currentSettings = { ...DEFAULT_SETTINGS };
                }
            }
            applySettings();
            updateSettingsUI();
        }

        function saveSettings() {
            // Read values from UI
            currentSettings.autoRefreshEnabled = document.getElementById('auto-refresh-toggle').classList.contains('active');
            currentSettings.refreshInterval = parseInt(document.getElementById('refresh-interval').value);
            currentSettings.showTooltips = document.getElementById('tooltips-toggle').classList.contains('active');
            currentSettings.compactMode = document.getElementById('compact-toggle').classList.contains('active');
            currentSettings.animationDuration = parseInt(document.getElementById('animation-duration').value);
            currentSettings.masterAudioEnabled = document.getElementById('master-audio-toggle').classList.contains('active');
            currentSettings.sequencerNotesEnabled = document.getElementById('sequencer-notes-toggle').classList.contains('active');
            currentSettings.agentVoiceEnabled = document.getElementById('agent-voice-toggle').classList.contains('active');
            currentSettings.audioVolume = parseInt(document.getElementById('audio-volume').value);
            currentSettings.sequencerNoteDuration = parseInt(document.getElementById('note-duration').value);
            currentSettings.timezone = document.getElementById('timezone-select').value;
            currentSettings.treeOrientation = document.getElementById('tree-orientation').value;
            currentSettings.hideScrollbars = document.getElementById('hide-scrollbars-toggle').classList.contains('active');
            currentSettings.defaultPlaybackSpeed = parseFloat(document.getElementById('default-playback-speed').value);
            currentSettings.defaultSoundMode = document.getElementById('default-sound-mode').value;
            currentSettings.newTaskPollEnabled = document.getElementById('new-task-poll-toggle').classList.contains('active');
            currentSettings.newTaskPollInterval = parseInt(document.getElementById('new-task-poll-interval').value);

            // Task settings
            currentSettings.taskTimeout = parseInt(document.getElementById('task-timeout').value);
            currentSettings.maxConcurrentTasks = parseInt(document.getElementById('max-concurrent-tasks').value);
            currentSettings.taskPriorityEnabled = document.getElementById('task-priority-toggle').classList.contains('active');
            currentSettings.autoArchiveCompleted = document.getElementById('auto-archive-toggle').classList.contains('active');
            currentSettings.cleanupDays = parseInt(document.getElementById('cleanup-days').value);
            currentSettings.retryFailedTasks = document.getElementById('retry-tasks-toggle').classList.contains('active');
            currentSettings.maxTaskRetries = parseInt(document.getElementById('max-retries').value);

            // TRON Chime settings
            currentSettings.chimeEnabled = document.getElementById('chime-enabled-toggle').classList.contains('active');
            currentSettings.chimeSound = document.getElementById('chime-sound').value;
            currentSettings.chimeVolume = parseInt(document.getElementById('chime-volume').value);
            currentSettings.chimeOnTimeout = document.getElementById('chime-on-timeout-toggle').classList.contains('active');
            currentSettings.chimeOnRestart = document.getElementById('chime-on-restart-toggle').classList.contains('active');
            currentSettings.chimeOnEscalation = document.getElementById('chime-on-escalation-toggle').classList.contains('active');
            currentSettings.chimeOnFailure = document.getElementById('chime-on-failure-toggle').classList.contains('active');

            // Validate
            if (currentSettings.refreshInterval < 0) currentSettings.refreshInterval = 0;
            if (currentSettings.refreshInterval > 600) currentSettings.refreshInterval = 600;
            if (currentSettings.newTaskPollInterval < 1) currentSettings.newTaskPollInterval = 1;
            if (currentSettings.newTaskPollInterval > 60) currentSettings.newTaskPollInterval = 60;
            if (currentSettings.animationDuration < 0) currentSettings.animationDuration = 0;
            if (currentSettings.animationDuration > 2000) currentSettings.animationDuration = 2000;
            if (currentSettings.audioVolume < 0) currentSettings.audioVolume = 0;
            if (currentSettings.audioVolume > 100) currentSettings.audioVolume = 100;
            if (currentSettings.defaultPlaybackSpeed < 0.1) currentSettings.defaultPlaybackSpeed = 0.1;
            if (currentSettings.defaultPlaybackSpeed > 1000) currentSettings.defaultPlaybackSpeed = 1000;

            // Save to localStorage
            localStorage.setItem('pas_hmi_settings', JSON.stringify(currentSettings));

            // Apply settings
            applySettings();

            // Close modal
            closeSettings();

            // Notify user
            console.log('Settings saved:', currentSettings);

            // Reload page to apply changes (simple approach)
            location.reload();
        }

        function resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                currentSettings = { ...DEFAULT_SETTINGS };
                localStorage.removeItem('pas_hmi_settings');
                updateSettingsUI();
                applySettings();
            }
        }

        function applySettings() {
            // Update audio init button visibility
            updateAudioInitButton();

            // This will be overridden by child templates to apply view-specific settings
            if (typeof applyViewSettings === 'function') {
                applyViewSettings(currentSettings);
            }
        }

        function updateSettingsUI() {
            // Update toggle switches
            document.getElementById('auto-refresh-toggle').classList.toggle('active', currentSettings.autoRefreshEnabled);
            document.getElementById('tooltips-toggle').classList.toggle('active', currentSettings.showTooltips);
            document.getElementById('compact-toggle').classList.toggle('active', currentSettings.compactMode);
            document.getElementById('master-audio-toggle').classList.toggle('active', currentSettings.masterAudioEnabled);
            document.getElementById('sequencer-notes-toggle').classList.toggle('active', currentSettings.sequencerNotesEnabled);
            document.getElementById('agent-voice-toggle').classList.toggle('active', currentSettings.agentVoiceEnabled);
            document.getElementById('hide-scrollbars-toggle').classList.toggle('active', currentSettings.hideScrollbars);

            // Update input values
            document.getElementById('refresh-interval').value = currentSettings.refreshInterval;
            document.getElementById('animation-duration').value = currentSettings.animationDuration;
            document.getElementById('audio-volume').value = currentSettings.audioVolume;
            document.getElementById('volume-display').textContent = currentSettings.audioVolume + '%';
            document.getElementById('note-duration').value = currentSettings.sequencerNoteDuration;
            document.getElementById('note-duration-display').textContent = currentSettings.sequencerNoteDuration + 'ms';
            document.getElementById('timezone-select').value = currentSettings.timezone;
            document.getElementById('tree-orientation').value = currentSettings.treeOrientation;
            document.getElementById('default-playback-speed').value = currentSettings.defaultPlaybackSpeed;
            document.getElementById('default-sound-mode').value = currentSettings.defaultSoundMode;
            document.getElementById('new-task-poll-interval').value = currentSettings.newTaskPollInterval;

            // Update toggle states
            if (currentSettings.newTaskPollEnabled) {
                document.getElementById('new-task-poll-toggle').classList.add('active');
            } else {
                document.getElementById('new-task-poll-toggle').classList.remove('active');
            }

            // Update task settings
            document.getElementById('task-timeout').value = currentSettings.taskTimeout;
            document.getElementById('max-concurrent-tasks').value = currentSettings.maxConcurrentTasks;
            document.getElementById('cleanup-days').value = currentSettings.cleanupDays;
            document.getElementById('max-retries').value = currentSettings.maxTaskRetries;
            document.getElementById('task-priority-toggle').classList.toggle('active', currentSettings.taskPriorityEnabled);
            document.getElementById('auto-archive-toggle').classList.toggle('active', currentSettings.autoArchiveCompleted);
            document.getElementById('retry-tasks-toggle').classList.toggle('active', currentSettings.retryFailedTasks);

            // Update TRON Chime settings
            document.getElementById('chime-enabled-toggle').classList.toggle('active', currentSettings.chimeEnabled);
            document.getElementById('chime-sound').value = currentSettings.chimeSound;
            document.getElementById('chime-volume').value = currentSettings.chimeVolume;
            document.getElementById('chime-volume-display').textContent = currentSettings.chimeVolume + '%';
            document.getElementById('chime-on-timeout-toggle').classList.toggle('active', currentSettings.chimeOnTimeout);
            document.getElementById('chime-on-restart-toggle').classList.toggle('active', currentSettings.chimeOnRestart);
            document.getElementById('chime-on-escalation-toggle').classList.toggle('active', currentSettings.chimeOnEscalation);
            document.getElementById('chime-on-failure-toggle').classList.toggle('active', currentSettings.chimeOnFailure);
        }

        async function openSettings() {
            updateSettingsUI();
            await loadModelPreferences();
            document.getElementById('settings-modal').classList.add('active');
        }

        // Load available models and current preferences
        async function loadModelPreferences() {
            try {
                // Load available models
                const modelsResponse = await fetch('/api/models/available');
                const modelsData = await modelsResponse.json();

                if (modelsData.status === 'ok') {
                    const models = modelsData.models;

                    // Populate all dropdowns
                    const agentTypes = ['architect', 'director', 'manager', 'programmer'];
                    const selectTypes = ['primary', 'fallback'];

                    for (const agentType of agentTypes) {
                        for (const selectType of selectTypes) {
                            const selectId = `${agentType}-${selectType}`;
                            const selectElement = document.getElementById(selectId);

                            if (selectElement) {
                                // Clear existing options
                                selectElement.innerHTML = '';

                                // Add options for each model
                                for (const [modelId, modelInfo] of Object.entries(models)) {
                                    const option = document.createElement('option');
                                    option.value = modelId;

                                    // Add emoji prefix based on provider
                                    let emoji = 'ü§ñ';
                                    if (modelId === 'auto') emoji = 'üîÑ';
                                    else if (modelInfo.provider === 'ollama') emoji = 'üè†';
                                    else if (modelInfo.provider === 'anthropic') emoji = 'üîÆ';
                                    else if (modelInfo.provider === 'openai') emoji = 'üöÄ';
                                    else if (modelInfo.provider === 'google') emoji = '‚ú®';
                                    else if (modelInfo.provider === 'deepseek') emoji = 'üß†';
                                    else if (modelInfo.provider === 'local' || modelInfo.provider === 'local_fastapi') emoji = 'üíª';

                                    // Add status indicator for local models
                                    let statusText = '';
                                    if (modelInfo.status) {
                                        if (modelInfo.status === 'OK') statusText = ' ‚úì';
                                        else if (modelInfo.status === 'ERR') statusText = ' ‚ö†Ô∏è';
                                        else if (modelInfo.status === 'OFFLINE') statusText = ' ‚≠ï';
                                        else if (modelInfo.status === 'API') statusText = '';  // No indicator for API models
                                    }

                                    option.textContent = `${emoji} ${modelInfo.name}${statusText}`;

                                    // Disable offline models
                                    if (modelInfo.status === 'OFFLINE' || modelInfo.status === 'ERR') {
                                        option.disabled = true;
                                        option.style.color = '#666';
                                    }

                                    selectElement.appendChild(option);
                                }
                            }
                        }
                    }
                }

                // Load current preferences
                const prefsResponse = await fetch('/api/models/preferences');
                const prefsData = await prefsResponse.json();

                if (prefsData.status === 'ok') {
                    const prefs = prefsData.preferences;

                    // Set selected values
                    for (const [agentType, config] of Object.entries(prefs)) {
                        const primaryElement = document.getElementById(`${agentType}-primary`);
                        const fallbackElement = document.getElementById(`${agentType}-fallback`);

                        if (primaryElement) primaryElement.value = config.primary;
                        if (fallbackElement) fallbackElement.value = config.fallback;
                    }
                }
            } catch (error) {
                console.error('Failed to load model preferences:', error);
            }
        }

        // Save model preferences
        async function saveModelPreferences() {
            try {
                const preferences = {
                    architect: {
                        primary: document.getElementById('architect-primary').value,
                        fallback: document.getElementById('architect-fallback').value
                    },
                    director: {
                        primary: document.getElementById('director-primary').value,
                        fallback: document.getElementById('director-fallback').value
                    },
                    manager: {
                        primary: document.getElementById('manager-primary').value,
                        fallback: document.getElementById('manager-fallback').value
                    },
                    programmer: {
                        primary: document.getElementById('programmer-primary').value,
                        fallback: document.getElementById('programmer-fallback').value
                    }
                };

                const response = await fetch('/api/models/preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ preferences })
                });

                const data = await response.json();

                if (data.status === 'ok') {
                    alert('‚úÖ Model preferences saved successfully!');
                } else {
                    alert('‚ùå Failed to save preferences: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to save model preferences:', error);
                alert('‚ùå Failed to save preferences: ' + error.message);
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function switchSettingsPage(pageId) {
            // Update sidebar active state
            const sidebarItems = document.querySelectorAll('.settings-sidebar-item');
            sidebarItems.forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.settings-sidebar-item').classList.add('active');

            // Update page visibility
            const pages = document.querySelectorAll('.settings-page');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('page-' + pageId).classList.add('active');

            // Update page title
            const titles = {
                'general': '‚öôÔ∏è General',
                'display': 'üé® Display',
                'tree': 'üå≥ Tree View',
                'sequencer': 'üéπ Sequencer',
                'audio': 'üîä Audio',
                'hhmrs': '‚ö° HHMRS',
                'tasks': 'üìã Tasks',
                'llm': 'ü§ñ LLM Models',
                'model-pool': 'üî• Model Pool',
                'advanced': '‚öôÔ∏è Advanced Models',
                'system': 'üõ†Ô∏è System Status'
            };
            document.getElementById('settings-page-title').textContent = titles[pageId];

            // Initialize advanced model settings sliders if switching to advanced page
            if (pageId === 'advanced') {
                initAdvancedModelSettings();
            }

            // Initialize HHMRS settings page
            if (pageId === 'hhmrs') {
                loadHHMRSSettings();
            }

            // Initialize Model Pool page
            if (pageId === 'model-pool') {
                refreshModelPool();
                loadPoolConfig();

                // Start auto-refresh (every 3 seconds)
                if (modelPoolRefreshInterval) {
                    clearInterval(modelPoolRefreshInterval);
                }
                modelPoolRefreshInterval = setInterval(refreshModelPool, 3000);
            } else {
                // Stop auto-refresh when leaving the page
                if (modelPoolRefreshInterval) {
                    clearInterval(modelPoolRefreshInterval);
                    modelPoolRefreshInterval = null;
                }
            }

            // Initialize System Status page
            if (pageId === 'system') {
                refreshSystemStatus();

                // Start auto-refresh (every 5 seconds)
                if (systemStatusRefreshInterval) {
                    clearInterval(systemStatusRefreshInterval);
                }
                systemStatusRefreshInterval = setInterval(refreshSystemStatus, 5000);
            } else {
                // Stop auto-refresh when leaving the page
                if (systemStatusRefreshInterval) {
                    clearInterval(systemStatusRefreshInterval);
                    systemStatusRefreshInterval = null;
                }
            }
        }

        async function initAdvancedModelSettings() {
            // Load existing settings from backend
            try {
                const response = await fetch('/api/models/advanced-settings');
                const data = await response.json();

                if (data.status === 'ok') {
                    const settings = data.settings;

                    // Set values
                    document.getElementById('llm-temperature').value = settings.temperature;
                    document.getElementById('llm-max-tokens').value = settings.maxTokens;
                    document.getElementById('llm-top-p').value = settings.topP;
                    document.getElementById('llm-top-k').value = settings.topK;
                    document.getElementById('llm-frequency-penalty').value = settings.frequencyPenalty;
                    document.getElementById('llm-presence-penalty').value = settings.presencePenalty;

                    // Update displays
                    document.getElementById('temperature-display').textContent = settings.temperature.toFixed(1);
                    document.getElementById('top-p-display').textContent = settings.topP.toFixed(2);
                    document.getElementById('frequency-penalty-display').textContent = settings.frequencyPenalty.toFixed(1);
                    document.getElementById('presence-penalty-display').textContent = settings.presencePenalty.toFixed(1);
                }
            } catch (error) {
                console.error('Error loading advanced settings:', error);
            }

            // Temperature slider
            const tempSlider = document.getElementById('llm-temperature');
            const tempDisplay = document.getElementById('temperature-display');
            tempSlider.addEventListener('input', (e) => {
                tempDisplay.textContent = parseFloat(e.target.value).toFixed(1);
            });

            // Top P slider
            const topPSlider = document.getElementById('llm-top-p');
            const topPDisplay = document.getElementById('top-p-display');
            topPSlider.addEventListener('input', (e) => {
                topPDisplay.textContent = parseFloat(e.target.value).toFixed(2);
            });

            // Frequency Penalty slider
            const freqSlider = document.getElementById('llm-frequency-penalty');
            const freqDisplay = document.getElementById('frequency-penalty-display');
            freqSlider.addEventListener('input', (e) => {
                freqDisplay.textContent = parseFloat(e.target.value).toFixed(1);
            });

            // Presence Penalty slider
            const presSlider = document.getElementById('llm-presence-penalty');
            const presDisplay = document.getElementById('presence-penalty-display');
            presSlider.addEventListener('input', (e) => {
                presDisplay.textContent = parseFloat(e.target.value).toFixed(1);
            });
        }

        async function saveAdvancedModelSettings() {
            try {
                const settings = {
                    temperature: parseFloat(document.getElementById('llm-temperature').value),
                    maxTokens: parseInt(document.getElementById('llm-max-tokens').value),
                    topP: parseFloat(document.getElementById('llm-top-p').value),
                    topK: parseInt(document.getElementById('llm-top-k').value),
                    frequencyPenalty: parseFloat(document.getElementById('llm-frequency-penalty').value),
                    presencePenalty: parseFloat(document.getElementById('llm-presence-penalty').value)
                };

                const response = await fetch('/api/models/advanced-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('‚úÖ Advanced model settings saved successfully!');
                } else {
                    alert('‚ö†Ô∏è Settings saved but may need service restart to take effect.');
                }
            } catch (error) {
                console.error('Error saving advanced settings:', error);
                alert('‚ùå Failed to save advanced settings: ' + error.message);
            }
        }

        function toggleAutoRefresh() {
            document.getElementById('auto-refresh-toggle').classList.toggle('active');
        }

        function toggleTooltips() {
            document.getElementById('tooltips-toggle').classList.toggle('active');
        }

        function toggleCompactMode() {
            document.getElementById('compact-toggle').classList.toggle('active');
        }

        function toggleMasterAudio() {
            document.getElementById('master-audio-toggle').classList.toggle('active');
        }

        function toggleSequencerNotes() {
            document.getElementById('sequencer-notes-toggle').classList.toggle('active');
        }

        function toggleAgentVoice() {
            document.getElementById('agent-voice-toggle').classList.toggle('active');
        }

        function toggleNewTaskPoll() {
            document.getElementById('new-task-poll-toggle').classList.toggle('active');
        }

        function toggleHideScrollbars() {
            document.getElementById('hide-scrollbars-toggle').classList.toggle('active');
        }

        // TRON Chime toggle functions
        function toggleChimeEnabled() {
            document.getElementById('chime-enabled-toggle').classList.toggle('active');
        }

        function toggleChimeOnTimeout() {
            document.getElementById('chime-on-timeout-toggle').classList.toggle('active');
        }

        function toggleChimeOnRestart() {
            document.getElementById('chime-on-restart-toggle').classList.toggle('active');
        }

        function toggleChimeOnEscalation() {
            document.getElementById('chime-on-escalation-toggle').classList.toggle('active');
        }

        function toggleChimeOnFailure() {
            document.getElementById('chime-on-failure-toggle').classList.toggle('active');
        }

        // HHMRS Settings toggle functions
        function toggleHHMRSAutoRestart() {
            document.getElementById('hhmrs-auto-restart-toggle').classList.toggle('active');
        }

        function toggleHHMRSLLMSwitching() {
            document.getElementById('hhmrs-llm-switching-toggle').classList.toggle('active');
        }

        // Load HHMRS settings from backend
        async function loadHHMRSSettings() {
            try {
                const response = await fetch('/api/settings/hhmrs');
                if (!response.ok) throw new Error('Failed to load HHMRS settings');

                const data = await response.json();
                const hhmrs = data.hhmrs || {};

                // Load numeric values
                document.getElementById('hhmrs-heartbeat-interval').value = hhmrs.heartbeat_interval_s || 30;
                document.getElementById('hhmrs-timeout-threshold').value = hhmrs.timeout_threshold_s || 60;
                document.getElementById('hhmrs-max-restarts').value = hhmrs.max_restarts || 3;
                document.getElementById('hhmrs-max-llm-retries').value = hhmrs.max_llm_retries || 3;

                // Load toggle states
                const autoRestartToggle = document.getElementById('hhmrs-auto-restart-toggle');
                if (hhmrs.enable_auto_restart !== false) {
                    autoRestartToggle.classList.add('active');
                } else {
                    autoRestartToggle.classList.remove('active');
                }

                const llmSwitchingToggle = document.getElementById('hhmrs-llm-switching-toggle');
                if (hhmrs.enable_llm_switching !== false) {
                    llmSwitchingToggle.classList.add('active');
                } else {
                    llmSwitchingToggle.classList.remove('active');
                }

                console.log('‚úì HHMRS settings loaded successfully');
            } catch (error) {
                console.error('Failed to load HHMRS settings:', error);
                document.getElementById('hhmrs-save-status').textContent = '‚ùå Failed to load settings';
                document.getElementById('hhmrs-save-status').style.color = '#ef4444';
            }
        }

        // Save HHMRS settings to backend
        async function saveHHMRSSettings() {
            const statusEl = document.getElementById('hhmrs-save-status');
            statusEl.textContent = '‚è≥ Saving...';
            statusEl.style.color = '#9ca3af';

            try {
                const hhmrsSettings = {
                    heartbeat_interval_s: parseInt(document.getElementById('hhmrs-heartbeat-interval').value),
                    timeout_threshold_s: parseInt(document.getElementById('hhmrs-timeout-threshold').value),
                    max_restarts: parseInt(document.getElementById('hhmrs-max-restarts').value),
                    max_llm_retries: parseInt(document.getElementById('hhmrs-max-llm-retries').value),
                    enable_auto_restart: document.getElementById('hhmrs-auto-restart-toggle').classList.contains('active'),
                    enable_llm_switching: document.getElementById('hhmrs-llm-switching-toggle').classList.contains('active')
                };

                const response = await fetch('/api/settings/hhmrs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ hhmrs: hhmrsSettings })
                });

                if (!response.ok) throw new Error('Failed to save HHMRS settings');

                const data = await response.json();
                statusEl.textContent = '‚úì Saved successfully! Restart services to apply.';
                statusEl.style.color = '#10b981';

                // Clear success message after 5 seconds
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 5000);

                console.log('‚úì HHMRS settings saved successfully:', hhmrsSettings);
            } catch (error) {
                console.error('Failed to save HHMRS settings:', error);
                statusEl.textContent = '‚ùå Failed to save settings';
                statusEl.style.color = '#ef4444';
            }
        }

        // Update volume and note duration displays as sliders move
        document.addEventListener('DOMContentLoaded', () => {
            const volumeSlider = document.getElementById('audio-volume');
            const volumeDisplay = document.getElementById('volume-display');
            const noteDurationSlider = document.getElementById('note-duration');
            const noteDurationDisplay = document.getElementById('note-duration-display');

            if (volumeSlider && volumeDisplay) {
                volumeSlider.addEventListener('input', (e) => {
                    volumeDisplay.textContent = e.target.value + '%';
                });
            }

            if (noteDurationSlider && noteDurationDisplay) {
                noteDurationSlider.addEventListener('input', (e) => {
                    noteDurationDisplay.textContent = e.target.value + 'ms';
                });
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', (event) => {
            const modal = document.getElementById('settings-modal');
            if (event.target === modal) {
                closeSettings();
            }
        });

        // Initialize WebSocket on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Load settings first
            loadSettings();

            // Calculate header height for TRON bar positioning
            setHeaderHeight();

            // Check if TRON bar should stay hidden (user dismissed it)
            checkTronBarDismissState();

            // Then connect WebSocket
            connectWebSocket();

            // Start task status polling
            startTaskStatusPolling();

            // Send ping every 30 seconds
            setInterval(() => {
                if (socket && socket.connected) {
                    socket.emit('ping');
                }
            }, 30000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopTaskStatusPolling();
        });

        // Export settings for child templates
        function getSettings() {
            return currentSettings;
        }

        // ============================================================================
        // Audio Service Integration
        // ============================================================================

        const AUDIO_SERVICE_URL = 'http://localhost:6103';

        /**
         * Play text-to-speech announcement
         * @param {string} text - Text to speak
         * @param {number} speed - Speech speed (0.5-2.0, default: 1.0)
         * @returns {Promise<Object>} Audio service response
         */
        async function speakStatus(text, speed = 1.0) {
            // Check if master audio and TTS are enabled
            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.agentVoiceEnabled) {
                console.log('TTS disabled in settings');
                return { success: false, message: 'TTS disabled' };
            }

            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/audio/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, speed, auto_play: true })
                });

                if (!response.ok) {
                    throw new Error(`TTS request failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('TTS generated:', data);
                return data;
            } catch (error) {
                console.error('TTS error:', error);
                return { success: false, message: error.message };
            }
        }

        /**
         * Play MIDI note for sequencer events
         * @param {string} eventType - Event type (task_assigned, task_started, task_completed, error)
         * @returns {Promise<Object>} Audio service response
         */
        async function playNoteForEvent(eventType) {
            // Check if master audio and sequencer notes are enabled
            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.sequencerNotesEnabled) {
                console.log('Sequencer notes disabled in settings');
                return { success: false, message: 'Notes disabled' };
            }

            // Map event types to MIDI notes
            const noteMap = {
                'task_assigned': 60,    // C4 (middle C)
                'task_started': 64,     // E4
                'task_completed': 72,   // C5 (higher octave)
                'error': 48,            // C3 (lower octave)
                'warning': 55,          // G3
                'success': 77           // F5
            };

            const note = noteMap[eventType] || 60;

            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/audio/note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        note,
                        duration: 0.3,
                        velocity: 100,
                        instrument: 'piano'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Note playback failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Note played:', data);
                return data;
            } catch (error) {
                console.error('Note playback error:', error);
                return { success: false, message: error.message };
            }
        }

        /**
         * Play alert tone
         * @param {string} type - Alert type (info, success, warning, error)
         * @returns {Promise<Object>} Audio service response
         */
        async function playAlert(type = 'info') {
            // Check if master audio is enabled
            const settings = getSettings();
            if (!settings.masterAudioEnabled) {
                console.log('Audio disabled in settings');
                return { success: false, message: 'Audio disabled' };
            }

            const toneMap = {
                'info': { frequency: 440, duration: 0.2, waveform: 'sine' },
                'success': { frequency: 800, duration: 0.15, waveform: 'sine' },
                'warning': { frequency: 600, duration: 0.3, waveform: 'square' },
                'error': { frequency: 200, duration: 0.4, waveform: 'square' }
            };

            const config = toneMap[type] || toneMap['info'];

            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/audio/tone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...config, volume: 0.5 })
                });

                if (!response.ok) {
                    throw new Error(`Tone playback failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Alert played:', data);
                return data;
            } catch (error) {
                console.error('Alert playback error:', error);
                return { success: false, message: error.message };
            }
        }

        /**
         * Update audio service volume to match settings
         * @param {number} volume - Volume percentage (0-100)
         * @returns {Promise<Object>} Audio service response
         */
        async function updateAudioServiceVolume(volume) {
            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/audio/volume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ master_volume: volume / 100 })
                });

                if (!response.ok) {
                    throw new Error(`Volume update failed: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Audio service volume updated:', data);
                return data;
            } catch (error) {
                console.error('Volume update error:', error);
                return { success: false, message: error.message };
            }
        }

        /**
         * Check if audio service is available
         * @returns {Promise<boolean>} True if service is healthy
         */
        async function checkAudioService() {
            try {
                const response = await fetch(`${AUDIO_SERVICE_URL}/health`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(2000) // 2 second timeout
                });

                if (!response.ok) {
                    return false;
                }

                const data = await response.json();
                return data.status === 'ok';
            } catch (error) {
                console.warn('Audio service not available:', error.message);
                return false;
            }
        }

        // Sync audio service volume when settings change
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if audio service is available
            const audioAvailable = await checkAudioService();
            if (audioAvailable) {
                console.log('‚úì Audio service available');

                // Sync volume on startup
                const settings = getSettings();
                if (settings.audioVolume !== undefined) {
                    await updateAudioServiceVolume(settings.audioVolume);
                }
            } else {
                console.warn('‚ö† Audio service not available at', AUDIO_SERVICE_URL);
                console.warn('Start audio service with: ./scripts/start_audio_service.sh');
            }
        });

        // ============================================================================
        // Web Audio API - Client-Side Sound System
        // ============================================================================

        // Global AudioContext (initialized on user interaction)
        let audioContext = null;
        let masterGainNode = null;

        /**
         * Initialize Web Audio API (call on first user interaction)
         */
        function initAudioContext() {
            if (audioContext) return; // Already initialized

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGainNode = audioContext.createGain();
                masterGainNode.connect(audioContext.destination);

                // Set volume from settings
                const settings = getSettings();
                masterGainNode.gain.value = (settings.audioVolume || 70) / 100;

                console.log('‚úì Web Audio API initialized');
            } catch (error) {
                console.error('Failed to initialize Web Audio API:', error);
            }
        }

        /**
         * Play a musical note using Web Audio API
         * @param {number} frequency - Frequency in Hz
         * @param {number} duration - Duration in seconds
         * @param {string} waveform - 'sine', 'square', 'sawtooth', 'triangle'
         */
        function playClientNote(frequency, duration = 0.3, waveform = 'sine') {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;

            // Bug fix: Update master volume before playing each note
            // This ensures volume changes take effect immediately without reinitializing audio context
            if (masterGainNode) {
                masterGainNode.gain.value = (settings.audioVolume || 70) / 100;
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = waveform;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(masterGainNode);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        /**
         * Play Geiger counter click sound
         */
        function playGeigerClick() {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;

            // Create short burst of noise (characteristic Geiger click)
            const bufferSize = audioContext.sampleRate * 0.02; // 20ms click
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);

            // Generate noise with exponential decay
            for (let i = 0; i < bufferSize; i++) {
                const decay = Math.exp(-i / (bufferSize / 8)); // Fast decay
                data[i] = (Math.random() * 2 - 1) * decay;
            }

            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();

            source.buffer = buffer;
            gainNode.gain.value = 0.15; // Lower volume for clicks

            source.connect(gainNode);
            gainNode.connect(masterGainNode);

            source.start();
        }

        /**
         * Play random sound effect
         */
        function playRandomSound() {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;

            const sounds = [
                { freq: 440, wave: 'sine' },     // A4
                { freq: 523, wave: 'sine' },     // C5
                { freq: 659, wave: 'sine' },     // E5
                { freq: 784, wave: 'sine' },     // G5
                { freq: 880, wave: 'triangle' }, // A5
                { freq: 1047, wave: 'square' }   // C6
            ];

            const sound = sounds[Math.floor(Math.random() * sounds.length)];
            playClientNote(sound.freq, 0.15, sound.wave);
        }

        /**
         * Play TRON chime notification
         * @param {string} soundType - Type of chime (ping, bell, chime, alert, alarm)
         * @param {number} volume - Volume level (0-100)
         */
        function playChime(soundType, volume) {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.chimeEnabled) return;

            const ctx = audioContext;
            const now = ctx.currentTime;
            const volumeGain = (volume / 100) * (settings.audioVolume / 100); // Apply both chime volume and master volume

            // Helper function to play a tone
            function playTone(frequency, startTime, duration, gain, waveType = 'sine') {
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.type = waveType;
                oscillator.frequency.value = frequency;

                gainNode.gain.setValueAtTime(gain, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                oscillator.connect(gainNode);
                gainNode.connect(masterGainNode);

                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            }

            // Helper function to play a pulsing tone
            function playPulse(frequency, startTime, duration, gain, pulseCount) {
                const pulseDuration = duration / pulseCount;
                const onTime = pulseDuration * 0.4;

                for (let i = 0; i < pulseCount; i++) {
                    const pulseStart = startTime + (i * pulseDuration);
                    playTone(frequency, pulseStart, onTime, gain, 'sine');
                }
            }

            switch (soundType) {
                case 'ping':
                    // Soft ping: 300Hz sine wave, short decay
                    playTone(300, now, 0.15, volumeGain * 0.3, 'sine');
                    break;

                case 'bell':
                    // Bell: 523Hz (C5) with harmonics, medium decay
                    playTone(523, now, 0.4, volumeGain * 0.25, 'sine');
                    playTone(1046, now, 0.3, volumeGain * 0.15, 'sine');  // Octave harmonic
                    break;

                case 'chime':
                    // Pleasant chime: C-E-G chord (261Hz, 329Hz, 392Hz)
                    playTone(261, now, 0.6, volumeGain * 0.2, 'sine');
                    playTone(329, now + 0.05, 0.6, volumeGain * 0.2, 'sine');
                    playTone(392, now + 0.1, 0.6, volumeGain * 0.2, 'sine');
                    break;

                case 'alert':
                    // Attention alert: 800Hz pulsing (3 pulses)
                    playPulse(800, now, 0.5, volumeGain * 0.3, 3);
                    break;

                case 'alarm':
                    // Urgent alarm: alternating 1000Hz and 1200Hz
                    playTone(1000, now, 0.2, volumeGain * 0.35, 'square');
                    playTone(1200, now + 0.2, 0.2, volumeGain * 0.35, 'square');
                    playTone(1000, now + 0.4, 0.2, volumeGain * 0.35, 'square');
                    break;

                default:
                    // Default to ping
                    playTone(300, now, 0.15, volumeGain * 0.3, 'sine');
            }
        }

        /**
         * Test chime sound (called from Settings page)
         */
        function testChime() {
            const soundType = document.getElementById('chime-sound').value;
            const volume = parseInt(document.getElementById('chime-volume').value);
            // Temporarily enable audio context for testing
            if (!audioContext) initAudioContext();
            playChime(soundType, volume);
        }

        /**
         * Play musical note for event (matches MIDI mapping from audio service)
         * @param {string} eventType - Event type
         */
        function playEventNote(eventType) {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.sequencerNotesEnabled) return;

            // MIDI note to frequency conversion (A440 standard)
            const midiToFreq = (midi) => 440 * Math.pow(2, (midi - 69) / 12);

            const noteMap = {
                'task_assigned': 60,    // C4 (261.63 Hz)
                'task_started': 64,     // E4 (329.63 Hz)
                'task_completed': 72,   // C5 (523.25 Hz)
                'error': 48,            // C3 (130.81 Hz)
                'warning': 55,          // G3 (196.00 Hz)
                'success': 77,          // F5 (698.46 Hz)
                'heartbeat': 60         // C4
            };

            const midiNote = noteMap[eventType] || 60;
            const frequency = midiToFreq(midiNote);

            playClientNote(frequency, 0.3, 'sine');
        }

        /**
         * Play hierarchical musical note based on agent tier
         * Higher tier (VP/Director) = lower pitch, Lower tier (Programmer) = higher pitch
         * Parallel agents at same tier get slightly offset pitches for clarity
         *
         * @param {string} eventType - Event type
         * @param {Object} task - Task object with agent_id
         */
        function playEventNoteHierarchical(eventType, task = null) {
            if (!audioContext) initAudioContext();
            if (!audioContext) return;

            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.sequencerNotesEnabled) return;

            // Get note duration from settings (default 150ms)
            const noteDuration = (settings.sequencerNoteDuration || 150) / 1000; // Convert ms to seconds

            // MIDI note to frequency conversion (A440 standard)
            const midiToFreq = (midi) => 440 * Math.pow(2, (midi - 69) / 12);

            // Base MIDI notes by event type (lower octave for hierarchy headroom)
            const eventBaseNotes = {
                'task_assigned': 48,    // C3 (lower for hierarchy range)
                'task_started': 52,     // E3
                'task_completed': 60,   // C4
                'error': 36,            // C2 (very low)
                'warning': 43,          // G2
                'success': 65,          // F4
                'heartbeat': 48         // C3
            };

            let baseMidi = eventBaseNotes[eventType] || 48;

            // Calculate tier-based pitch offset
            // Tier 0 (VP) = +0 semitones (deepest/lowest)
            // Tier 1 (Director) = +4 semitones
            // Tier 2 (Manager) = +7 semitones
            // Tier 3 (Programmer) = +12 semitones (highest)
            // Tier 4+ (Workers) = +15 semitones
            let tierOffset = 0;
            let agentTier = '?';
            let agentId = '';

            if (task && task.agent_id && typeof agents !== 'undefined' && agents.length > 0) {
                agentId = task.agent_id;
                const agent = agents.find(a => a.service_id === agentId);
                if (agent) {
                    agentTier = agent.tier;
                    const tier = parseInt(agentTier) || 3; // Default to tier 3 if unknown

                    // Tier mapping (inverted: higher tier number = higher pitch)
                    const tierPitchMap = {
                        '0': 0,    // VP (lowest/deepest)
                        '1': 4,    // Director (+4 semitones)
                        '2': 7,    // Manager (+7 semitones)
                        '3': 12,   // Programmer (+12 semitones = 1 octave up)
                        '4': 15,   // Worker (+15 semitones)
                        '5': 17    // Lowest tier (+17 semitones)
                    };

                    tierOffset = tierPitchMap[String(tier)] || 12;
                } else {
                    console.warn(`[Sound] Agent not found for agent_id: ${agentId}`);
                }
            }

            // Calculate per-agent offset for parallel agents at same tier
            // Use agent_id hash to generate consistent pitch offset (+0 to +2 semitones)
            let agentOffset = 0;
            if (agentId) {
                // Simple hash: sum char codes modulo 3
                const hash = agentId.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
                agentOffset = (hash % 3); // 0, 1, or 2 semitones
            }

            const finalMidi = baseMidi + tierOffset + agentOffset;
            const frequency = midiToFreq(finalMidi);

            // Debug log (throttled)
            if (Math.random() < 0.1) { // Log 10% of notes
                console.log(`üéµ [Sound] ${eventType} - tier=${agentTier}, base=${baseMidi}, tier+${tierOffset}, agent+${agentOffset}, final=${finalMidi} (${Math.round(frequency)}Hz), duration=${noteDuration}s`);
            }

            playClientNote(frequency, noteDuration, 'sine');
        }

        /**
         * Speak text using Web Speech API (fallback to audio service)
         * @param {string} text - Text to speak
         */
        function speakText(text) {
            const settings = getSettings();
            if (!settings.masterAudioEnabled || !settings.agentVoiceEnabled) return;

            // Try Web Speech API first (available in most browsers)
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.2;  // Slightly faster
                utterance.pitch = 1.0;
                utterance.volume = (settings.audioVolume || 70) / 100;
                window.speechSynthesis.speak(utterance);
            } else {
                // Fallback to audio service
                speakStatus(text);
            }
        }

        /**
         * Handle task event sound based on current sound mode
         * @param {string} eventType - Event type
         * @param {Object} task - Task object (optional, for hierarchical pitch calculation)
         */
        function handleTaskEventSound(eventType, task = null) {
            if (!audioContext) initAudioContext();

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;

            const soundMode = settings.defaultSoundMode || 'none';

            switch (soundMode) {
                case 'none':
                    // No sound
                    break;

                case 'voice':
                    // Text-to-speech announcement
                    const voiceMap = {
                        'task_assigned': 'Task assigned',
                        'task_started': 'Task started',
                        'task_completed': 'Task completed',
                        'error': 'Error occurred',
                        'warning': 'Warning',
                        'heartbeat': 'Heartbeat'
                    };
                    const text = voiceMap[eventType] || eventType;
                    speakText(text);
                    break;

                case 'music':
                    // Musical notes with hierarchical pitch
                    playEventNoteHierarchical(eventType, task);
                    break;

                case 'random':
                    // Random sound effects
                    playRandomSound();
                    break;

                case 'geiger':
                    // Geiger counter tick (for any agent activity)
                    playGeigerClick();
                    break;

                default:
                    console.warn('Unknown sound mode:', soundMode);
            }
        }

        /**
         * Start Geiger counter mode (continuous ticking based on activity rate)
         */
        let geigerIntervalId = null;
        let activityRate = 0; // Events per second

        function startGeigerMode() {
            if (geigerIntervalId) return; // Already running

            const settings = getSettings();
            if (!settings.masterAudioEnabled) return;
            if (settings.defaultSoundMode !== 'geiger') return;

            // Base tick rate (when idle)
            const baseRate = 500; // ms between ticks

            geigerIntervalId = setInterval(() => {
                // Vary tick rate based on activity (lower interval = faster ticks)
                const interval = Math.max(50, baseRate - (activityRate * 50));

                if (Math.random() < 0.3 || activityRate > 0) {
                    playGeigerClick();
                }
            }, 200); // Check every 200ms

            console.log('‚úì Geiger counter mode started');
        }

        function stopGeigerMode() {
            if (geigerIntervalId) {
                clearInterval(geigerIntervalId);
                geigerIntervalId = null;
                console.log('‚úì Geiger counter mode stopped');
            }
        }

        function updateActivityRate(eventsPerSecond) {
            activityRate = Math.min(eventsPerSecond, 10); // Cap at 10 events/sec
        }

        // Update master volume when settings change
        function updateClientVolume(volume) {
            if (!audioContext || !masterGainNode) return;
            masterGainNode.gain.value = volume / 100;
        }

        // Override handleRealtimeEvent to trigger sounds
        const originalHandleRealtimeEvent = handleRealtimeEvent;
        handleRealtimeEvent = function(event) {
            // Call original handler
            if (originalHandleRealtimeEvent) {
                originalHandleRealtimeEvent(event);
            }

            // Map event types to sound events
            const soundEventMap = {
                'job_started': 'task_started',
                'task_started': 'task_started',
                'job_completed': 'task_completed',
                'task_completed': 'task_completed',
                'error': 'error',
                'failed': 'error',
                'heartbeat': 'heartbeat',
                'warning': 'warning',
                'blocked': 'warning'
            };

            const soundEvent = soundEventMap[event.event_type];
            if (soundEvent) {
                handleTaskEventSound(soundEvent);
                updateActivityRate(1); // Increment activity
            }
        };

        /**
         * Manual audio initialization (triggered by button click)
         */
        function initAudioManual() {
            if (!audioContext) {
                initAudioContext();

                // Start Geiger mode if enabled
                const settings = getSettings();
                if (settings.defaultSoundMode === 'geiger') {
                    startGeigerMode();
                }

                // Hide the button
                const btn = document.getElementById('audio-init-button');
                if (btn) {
                    btn.style.display = 'none';
                }

                // Play a confirmation beep
                playClientNote(523.25, 0.2, 'sine'); // C5
                console.log('‚úì Audio initialized manually');
            }
        }

        /**
         * Show/hide audio init button based on settings
         */
        function updateAudioInitButton() {
            const settings = getSettings();
            const btn = document.getElementById('audio-init-button');

            if (!btn) return;

            // Show button if master audio is enabled and audio context not initialized
            if (settings.masterAudioEnabled && !audioContext) {
                btn.style.display = 'inline-block';
            } else {
                btn.style.display = 'none';
            }
        }

        // Initialize audio on first user interaction (fallback for auto-init)
        document.addEventListener('click', () => {
            if (!audioContext) {
                const settings = getSettings();
                if (settings.masterAudioEnabled) {
                    initAudioContext();

                    // Start Geiger mode if enabled
                    if (settings.defaultSoundMode === 'geiger') {
                        startGeigerMode();
                    }

                    // Hide the button
                    updateAudioInitButton();
                    console.log('‚úì Audio auto-initialized on first click');
                }
            }
        }, { once: true });

        // Monitor sound mode changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'pas_hmi_settings') {
                const settings = getSettings();

                // Update volume
                if (settings.audioVolume !== undefined) {
                    updateClientVolume(settings.audioVolume);
                }

                // Start/stop Geiger mode based on settings
                if (settings.defaultSoundMode === 'geiger' && settings.masterAudioEnabled) {
                    startGeigerMode();
                } else {
                    stopGeigerMode();
                }
            }
        });

        // Decay activity rate over time
        setInterval(() => {
            activityRate = Math.max(0, activityRate * 0.9); // Decay by 10% every second
        }, 1000);

        // ============================================================================
        // Demo Control Functions
        // ============================================================================

        let demoRunning = false;

        async function startPrimeDirective() {
            // Get custom prompt from settings or use default
            const customPrompt = localStorage.getItem('primeDirectivePrompt') || '';
            
            // Show confirmation dialog with option to customize
            const useCustom = confirm('üöÄ Send Prime Directive to PAS Root\n\nThis will send a real project request to the operational PAS system.\n\nClick OK to use default prompt, or Cancel to customize.');
            
            let finalPrompt = customPrompt;
            if (!useCustom) {
                // Allow user to customize the prompt
                const defaultPrompt = `Build a comprehensive REST API system with the following requirements:

CORE FEATURES:
- User authentication with JWT tokens
- Role-based access control (admin, user, moderator)
- RESTful endpoints for CRUD operations
- PostgreSQL database with proper migrations
- Input validation and error handling
- API documentation with OpenAPI/Swagger
- Unit and integration tests
- Docker containerization
- CI/CD pipeline configuration

TECHNICAL STACK:
- Backend: FastAPI or Express.js
- Database: PostgreSQL with SQLAlchemy/Prisma
- Authentication: JWT with refresh tokens
- Testing: pytest/Jest with coverage reports
- Documentation: OpenAPI 3.0 spec
- Deployment: Docker with docker-compose

DELIVERABLES:
1. Complete source code with modular architecture
2. Database schema and migration scripts
3. API documentation and testing suite
4. Docker configuration and deployment scripts
5. CI/CD pipeline setup (GitHub Actions/GitLab CI)

The system should be production-ready, secure, and scalable.`;

                finalPrompt = prompt('üöÄ Customize Prime Directive Prompt:', defaultPrompt);
                if (finalPrompt === null) return; // User cancelled
                
                // Save custom prompt for next time
                localStorage.setItem('primeDirectivePrompt', finalPrompt);
            }

            const primeDirectiveButton = document.getElementById('prime-directive-button');
            const originalText = primeDirectiveButton.textContent;

            try {
                primeDirectiveButton.disabled = true;
                primeDirectiveButton.textContent = 'üöÄ Sending...';

                const response = await fetch('/api/demo/prime-directive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: finalPrompt })
                });
                const data = await response.json();

                if (response.ok) {
                    console.log('‚úÖ Prime Directive sent:', data);
                    alert(`‚úÖ Prime Directive sent to PAS Root!\n\nRun ID: ${data.run_id}\nPrompt Preview: ${data.prompt_preview}\n\nCheck the sequencer to see execution progress.`);
                    
                    // Refresh sequencer to show new tasks
                    if (typeof fetchSequencerData === 'function') {
                        setTimeout(() => fetchSequencerData(), 1000);
                    }
                } else {
                    throw new Error(data.error || 'Failed to send Prime Directive');
                }
            } catch (error) {
                console.error('Failed to send Prime Directive:', error);
                alert('Failed to send Prime Directive: ' + error.message);
            } finally {
                primeDirectiveButton.disabled = false;
                primeDirectiveButton.textContent = originalText;
            }
        }

        async function startDemo() {
            if (demoRunning) {
                alert('Demo is already running!');
                return;
            }

            const startButton = document.getElementById('start-demo-button');
            const stopButton = document.getElementById('stop-demo-button');
            const masterStopButton = document.getElementById('master-stop-button');

            try {
                startButton.disabled = true;
                startButton.textContent = '‚è≥ Starting...';

                const response = await fetch('/api/demo/start', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    demoRunning = true;
                    startButton.style.display = 'none';
                    stopButton.style.display = 'inline-block';
                    masterStopButton.style.display = 'inline-block';
                    console.log('‚úì Demo started:', data);
                    alert('Demo started! Watch the HMI come alive with activity.\n\n' +
                          'Projects will be created in /tmp/ using local LLMs (free!).\n\n' +
                          'Enable sound in Sequencer to hear it working!');
                } else {
                    throw new Error(data.error || 'Failed to start demo');
                }
            } catch (error) {
                console.error('Failed to start demo:', error);
                alert('Failed to start demo: ' + error.message);
                startButton.textContent = '‚ñ∂Ô∏è Start Demo';
            } finally {
                startButton.disabled = false;
            }
        }

        async function stopDemo() {
            const startButton = document.getElementById('start-demo-button');
            const stopButton = document.getElementById('stop-demo-button');

            try {
                stopButton.disabled = true;
                stopButton.textContent = '‚è≥ Stopping...';

                const response = await fetch('/api/demo/stop', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    demoRunning = false;
                    stopButton.style.display = 'none';
                    startButton.style.display = 'inline-block';
                    startButton.textContent = '‚ñ∂Ô∏è Start Demo';
                    document.getElementById('master-stop-button').style.display = 'none';
                    console.log('‚úì Demo stopped:', data);
                    alert('Demo stopped.');
                } else {
                    throw new Error(data.error || 'Failed to stop demo');
                }
            } catch (error) {
                console.error('Failed to stop demo:', error);
                alert('Failed to stop demo: ' + error.message);
                stopButton.textContent = '‚èπÔ∏è Stop Demo';
            } finally {
                stopButton.disabled = false;
            }
        }

        async function masterStopDemo() {
            // Confirmation dialog with warning
            if (!confirm('‚ö†Ô∏è MASTER STOP: This will FORCE KILL all demo processes immediately!\n\nThis is an EMERGENCY measure - use only if regular Stop fails.\n\nContinue?')) {
                return;
            }

            const startButton = document.getElementById('start-demo-button');
            const stopButton = document.getElementById('stop-demo-button');
            const masterStopButton = document.getElementById('master-stop-button');

            try {
                masterStopButton.disabled = true;
                masterStopButton.textContent = '‚è≥ KILLING...';

                const response = await fetch('/api/demo/master-stop', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    demoRunning = false;
                    stopButton.style.display = 'none';
                    masterStopButton.style.display = 'none';
                    startButton.style.display = 'inline-block';
                    startButton.textContent = '‚ñ∂Ô∏è Start Demo';
                    console.log('‚úì MASTER STOP executed:', data);
                    if (data.killed_pids && data.killed_pids.length > 0) {
                        alert(`‚úÖ MASTER STOP: Killed ${data.killed_pids.length} process(es)\nPIDs: ${data.killed_pids.join(', ')}`);
                    } else {
                        alert('‚úÖ MASTER STOP: ' + data.message);
                    }
                } else {
                    throw new Error(data.error || 'Failed to execute MASTER STOP');
                }
            } catch (error) {
                console.error('Failed to execute MASTER STOP:', error);
                alert('‚ùå MASTER STOP failed: ' + error.message);
                masterStopButton.textContent = 'üõë MASTER STOP';
            } finally {
                masterStopButton.disabled = false;
            }
        }

        async function clearDemoData() {
            if (!confirm('This will delete demo files in /tmp/lnsp_demo/\n\nContinue?')) {
                return;
            }

            try {
                const response = await fetch('/api/demo/clear', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    console.log('‚úì Demo files cleared:', data);
                    alert('Demo files cleared!');
                } else {
                    console.error('‚úó Failed to clear demo:', data);
                    alert('Failed to clear demo: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error clearing demo:', error);
                alert('Error clearing demo: ' + error.message);
            }
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will PERMANENTLY delete:\n\n' +
                        '‚Ä¢ All action logs\n' +
                        '‚Ä¢ All service registrations\n' +
                        '‚Ä¢ All task history\n' +
                        '‚Ä¢ All demo files\n\n' +
                        'This CANNOT be undone!\n\n' +
                        'Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/clear-all', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    console.log('‚úì All data cleared:', data);
                    alert(`All data cleared!\n\n${data.action_logs_deleted} action logs deleted\n${data.services_deleted} services deleted\n\nRefresh the page to see updated state.`);
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to clear demo data');
                }
            } catch (error) {
                console.error('Failed to clear all data:', error);
                alert('Failed to clear all data: ' + error.message);
            }
        }

        function clearAllDataConfirm() {
            clearAllData();
        }

        async function restartHMI() {
            if (!confirm('‚ö†Ô∏è FULL SYSTEM RESTART ‚ö†Ô∏è\n\nThis will restart ALL services:\n‚Ä¢ Model Pool Manager (8050)\n‚Ä¢ Model Services (8051-8099)\n‚Ä¢ Gateway (6120)\n‚Ä¢ PAS Root (6100)\n‚Ä¢ Aider-LCO (6130)\n‚Ä¢ Registry (6121)\n‚Ä¢ Heartbeat Monitor (6109)\n‚Ä¢ Resource Manager (6104)\n‚Ä¢ Token Governor (6105)\n‚Ä¢ HMI Dashboard (6101)\n\nThe page will disconnect for ~15 seconds.\n\nContinue?')) {
                return;
            }

            try {
                alert('üîÑ Full system restart initiated...\n\nAll services will restart in ~15 seconds.\n\nThe page will reload automatically.');
                const response = await fetch('/api/admin/restart-services', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    console.log('‚úì Full system restart initiated:', data);
                    // Wait 15 seconds for all services to restart
                    setTimeout(() => {
                        alert('‚úÖ Services restarted! Reloading page...');
                        window.location.reload();
                    }, 15000);
                } else {
                    alert('‚ùå Failed to restart services: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error restarting services:', error);
                alert('‚ùå Error restarting services: ' + error.message);
            }
        }

        // Check demo status on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/demo/status');
                const data = await response.json();

                if (data.running) {
                    demoRunning = true;
                    document.getElementById('start-demo-button').style.display = 'none';
                    document.getElementById('stop-demo-button').style.display = 'inline-block';
                    document.getElementById('master-stop-button').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Failed to check demo status:', error);
            }
        });

        // ===== Model Pool Management Functions =====

        let modelPoolRefreshInterval = null;

        async function refreshModelPool() {
            try {
                // Fetch pool status via HMI proxy
                const response = await fetch('/api/model-pool/models');
                const data = await response.json();

                // Update pool overview
                document.getElementById('pool-active-count').textContent = data.models.filter(m => m.state === 'HOT' || m.state === 'WARMING').length;
                document.getElementById('pool-memory').textContent = Math.round(data.total_memory_mb) + ' MB';
                document.getElementById('pool-available-ports').textContent = data.available_ports || '-';
                document.getElementById('pool-status').textContent = '‚úì';
                document.getElementById('pool-status').style.color = '#10b981';

                // Render model cards
                renderModelCards(data.models);

            } catch (error) {
                console.error('Failed to fetch model pool:', error);
                document.getElementById('pool-status').textContent = '‚úó';
                document.getElementById('pool-status').style.color = '#ef4444';
                document.getElementById('model-cards-container').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: #ef4444; padding: 2rem;">
                        ‚ö†Ô∏è Failed to fetch model pool data<br>
                        <span style="font-size: 0.875rem; color: #9ca3af;">Check that Model Pool Manager is running on port 8050</span>
                    </div>
                `;
            }
        }

        function renderModelCards(models) {
            const container = document.getElementById('model-cards-container');

            if (!models || models.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: #9ca3af; padding: 2rem;">
                        No models registered
                    </div>
                `;
                return;
            }

            container.innerHTML = models.map(model => {
                const stateColors = {
                    'HOT': '#10b981',
                    'WARMING': '#f59e0b',
                    'COOLING': '#3b82f6',
                    'COLD': '#6b7280'
                };
                const stateColor = stateColors[model.state] || '#6b7280';
                const isHot = model.state === 'HOT';
                const isWarmup = model.warmup || false;

                return `
                    <div style="background: #1e293b; border: 1px solid #4a5578; border-radius: 8px; padding: 1rem;">
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-weight: 600; color: #e0e0e0; margin-bottom: 0.25rem;">${model.display_name || model.model_id}</div>
                                <div style="font-size: 0.75rem; color: #9ca3af; font-family: monospace;">${model.model_id}</div>
                            </div>
                            <div style="background: ${stateColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                ${model.state}
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.75rem; background: #0f172a; border-radius: 6px;">
                            <div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Port</div>
                                <div style="font-weight: 600; color: #e0e0e0;">${model.port || '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Memory</div>
                                <div style="font-weight: 600; color: #e0e0e0;">${model.memory_mb ? Math.round(model.memory_mb) + ' MB' : '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Requests</div>
                                <div style="font-weight: 600; color: #e0e0e0;">${model.request_count || 0}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Uptime</div>
                                <div style="font-weight: 600; color: #e0e0e0;">${model.uptime_minutes ? Math.round(model.uptime_minutes) + ' min' : '-'}</div>
                            </div>
                        </div>

                        <!-- TTL Display -->
                        ${!isWarmup ? `
                            <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: #0f172a; border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.25rem;">TTL Remaining</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="flex: 1; height: 6px; background: #374151; border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; background: ${stateColor}; width: ${Math.min((model.ttl_remaining_minutes || 0) / 15 * 100, 100)}%;"></div>
                                    </div>
                                    <div style="font-weight: 600; color: #e0e0e0; min-width: 50px;">${model.ttl_remaining_minutes || 0} min</div>
                                </div>
                            </div>
                        ` : `
                            <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: #0f172a; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.75rem; color: #f59e0b; font-weight: 600;">‚ö° WARMUP MODEL (Never Unloads)</div>
                            </div>
                        `}

                        <!-- Actions -->
                        <div style="display: flex; gap: 0.5rem;">
                            ${isHot ? `
                                <button onclick="unloadModel('${model.model_id}')" style="flex: 1; padding: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                    üì• Unload
                                </button>
                                ${!isWarmup ? `
                                    <button onclick="extendTTL('${model.model_id}')" style="flex: 1; padding: 0.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                        ‚è±Ô∏è Extend TTL
                                    </button>
                                ` : ''}
                            ` : `
                                <button onclick="loadModel('${model.model_id}')" style="flex: 1; padding: 0.5rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                    üì§ Load
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadModel(modelId) {
            try {
                const response = await fetch(`/api/model-pool/models/${encodeURIComponent(modelId)}/load`, {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('Model load initiated:', data);

                // Refresh immediately to show WARMING state
                setTimeout(() => refreshModelPool(), 500);
            } catch (error) {
                console.error('Failed to load model:', error);
                alert('Failed to load model: ' + error.message);
            }
        }

        async function unloadModel(modelId) {
            if (!confirm(`Unload model ${modelId}?`)) return;

            try {
                const response = await fetch(`/api/model-pool/models/${encodeURIComponent(modelId)}/unload`, {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('Model unloaded:', data);

                // Refresh to show updated state
                setTimeout(() => refreshModelPool(), 500);
            } catch (error) {
                console.error('Failed to unload model:', error);
                alert('Failed to unload model: ' + error.message);
            }
        }

        async function extendTTL(modelId) {
            try {
                const response = await fetch(`/api/model-pool/models/${encodeURIComponent(modelId)}/extend-ttl`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ minutes: 15 })
                });
                const data = await response.json();
                console.log('TTL extended:', data);

                // Refresh to show updated TTL
                setTimeout(() => refreshModelPool(), 500);
            } catch (error) {
                console.error('Failed to extend TTL:', error);
                alert('Failed to extend TTL: ' + error.message);
            }
        }

        async function loadPoolConfig() {
            try {
                const response = await fetch('/api/model-pool/config');
                const config = await response.json();

                document.getElementById('pool-default-ttl').value = config.default_ttl_minutes || 15;
                document.getElementById('pool-max-concurrent').value = config.max_concurrent_models || 5;
                document.getElementById('pool-check-interval').value = config.check_interval_seconds || 30;
            } catch (error) {
                console.error('Failed to load pool config:', error);
            }
        }

        async function savePoolConfig() {
            try {
                const config = {
                    default_ttl_minutes: parseInt(document.getElementById('pool-default-ttl').value),
                    max_concurrent_models: parseInt(document.getElementById('pool-max-concurrent').value),
                    check_interval_seconds: parseInt(document.getElementById('pool-check-interval').value)
                };

                const response = await fetch('/api/model-pool/config', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();

                if (data.status === 'updated') {
                    alert('‚úì Pool configuration updated successfully');
                } else {
                    alert('‚ö†Ô∏è Configuration update returned unexpected status');
                }
            } catch (error) {
                console.error('Failed to save pool config:', error);
                alert('‚ùå Failed to save configuration: ' + error.message);
            }
        }

        // ===== System Status Functions =====

        let systemStatusRefreshInterval = null;

        const PORT_DEFINITIONS = [
            { port: 6100, name: 'PAS Root', service: 'PAS' },
            { port: 6101, name: 'HMI', service: 'WebUI' },
            { port: 6102, name: 'Event Bus', service: 'Events' },
            { port: 6103, name: 'Provider Router', service: 'Router' },
            { port: 6120, name: 'Gateway', service: 'Gateway' },
            { port: 6121, name: 'PAS Registry', service: 'Registry' },
            { port: 6130, name: 'Aider-LCO', service: 'Aider' },
            { port: 8050, name: 'Model Pool', service: 'Model Pool' },
            { port: 8051, name: 'Model:qwen', service: 'Model' },
            { port: 8052, name: 'Model:llama', service: 'Model' },
            { port: 8053, name: 'Model:deepseek', service: 'Model' },
            { port: 11434, name: 'Ollama', service: 'LLM' }
        ];

        async function refreshSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();

                // Update overall health score
                const healthScore = data.overall_health_percent || 0;
                document.getElementById('overall-health-score').textContent = Math.round(healthScore) + '%';
                document.getElementById('overall-health-bar').style.width = healthScore + '%';

                // Update status text
                let statusText = 'All Systems Operational';
                let statusColor = '#10b981';
                if (healthScore < 100) {
                    statusText = `${data.issues_count || 0} Issue(s) Detected`;
                    statusColor = healthScore >= 70 ? '#f59e0b' : '#ef4444';
                }
                document.getElementById('overall-health-status').textContent = statusText;
                document.getElementById('overall-health-status').style.color = statusColor;

                // Render port grid
                renderPortGrid(data.ports || {});

                // Render health checks
                renderHealthChecks(data.health_checks || {});

            } catch (error) {
                console.error('Failed to fetch system status:', error);
                document.getElementById('overall-health-score').textContent = 'ERROR';
                document.getElementById('overall-health-status').textContent = 'Failed to connect to HMI API';
                document.getElementById('overall-health-status').style.color = '#ef4444';
            }
        }

        function renderPortGrid(portsData) {
            const grid = document.getElementById('port-grid');

            grid.innerHTML = PORT_DEFINITIONS.map((portDef, index) => {
                const portStatus = portsData[portDef.port] || { status: 'unknown', latency_ms: null };
                const statusColors = {
                    'up': '#10b981',
                    'down': '#ef4444',
                    'degraded': '#f59e0b',
                    'hibernated': '#6b7280',  // Grey for hibernated/optional ports
                    'unknown': '#6b7280'
                };
                const statusIcons = {
                    'up': '‚úì',
                    'down': '‚úó',
                    'degraded': '‚ö†',
                    'hibernated': '‚óã',  // Empty circle for hibernated ports
                    'unknown': '?'
                };
                const bgColor = statusColors[portStatus.status] || '#6b7280';
                const icon = statusIcons[portStatus.status] || '?';

                return `
                    <div
                        data-port="${portDef.port}"
                        data-port-name="${portDef.name}"
                        data-port-service="${portDef.service}"
                        data-port-status="${portStatus.status}"
                        data-port-latency="${portStatus.latency_ms || 'N/A'}"
                        data-port-error="${portStatus.error || ''}"
                        data-port-note="${portStatus.note || ''}"
                        onmouseenter="showPortTooltip(event, this)"
                        onmouseleave="hidePortTooltip()"
                        style="
                            background: ${bgColor};
                            color: white;
                            padding: 0.75rem;
                            border-radius: 6px;
                            text-align: center;
                            font-weight: 600;
                            cursor: pointer;
                            position: relative;
                            font-size: 0.875rem;
                        ">
                        <div style="font-size: 1.25rem; margin-bottom: 0.25rem;">${icon}</div>
                        <div style="font-size: 0.625rem; opacity: 0.9;">${portDef.port}</div>
                        <div style="font-size: 0.625rem; opacity: 0.7; margin-top: 0.125rem;">${portDef.service}</div>
                    </div>
                `;
            }).join('');
        }

        function showPortTooltip(event, element) {
            const tooltip = document.getElementById('system-tooltip');
            const port = element.dataset.port;
            const name = element.dataset.portName;
            const service = element.dataset.portService;
            const status = element.dataset.portStatus;
            const latency = element.dataset.portLatency;
            const error = element.dataset.portError;
            const note = element.dataset.portNote;

            // Build tooltip content
            let content = `
                <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; color: #e0e0e0;">${name}</div>
                <div style="border-top: 1px solid #4a5578; padding-top: 0.5rem;">
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.875rem;">
                        <div style="color: #9ca3af;">Port:</div>
                        <div style="font-weight: 600;">${port}</div>

                        <div style="color: #9ca3af;">Service:</div>
                        <div style="font-weight: 600;">${service}</div>

                        <div style="color: #9ca3af;">Status:</div>
                        <div style="font-weight: 600; text-transform: uppercase;">${status === 'hibernated' ? 'HIBERNATED' : status}</div>
            `;

            if (latency !== 'N/A') {
                content += `
                        <div style="color: #9ca3af;">Latency:</div>
                        <div style="font-weight: 600;">${latency}ms</div>
                `;
            }

            if (note) {
                content += `
                        <div style="color: #9ca3af;">Note:</div>
                        <div style="font-weight: 600; color: #fbbf24;">${note}</div>
                `;
            }

            if (error && !note) {
                content += `
                        <div style="color: #9ca3af;">Error:</div>
                        <div style="font-weight: 600; color: #ef4444;">${error}</div>
                `;
            }

            content += `
                    </div>
                </div>
            `;

            tooltip.innerHTML = content;
            tooltip.style.display = 'block';

            // Position tooltip near mouse
            const x = event.clientX + 15;
            const y = event.clientY + 15;

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        function hidePortTooltip() {
            const tooltip = document.getElementById('system-tooltip');
            tooltip.style.display = 'none';
        }

        async function copySystemSummaryToClipboard() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();

                // Build text summary
                let summary = '=== SYSTEM STATUS SUMMARY ===\\n\\n';
                summary += `Overall Health: ${Math.round(data.overall_health_percent)}%\\n`;
                summary += `Issues: ${data.issues_count}\\n`;
                summary += `Ports Up: ${data.ports_up}/${data.ports_total}\\n\\n`;

                summary += '--- PORTS ---\\n';
                for (const portDef of PORT_DEFINITIONS) {
                    const portStatus = data.ports[portDef.port] || { status: 'unknown' };
                    const icon = portStatus.status === 'up' ? '‚úì' :
                                portStatus.status === 'down' ? '‚úó' :
                                portStatus.status === 'hibernated' ? '‚óã' : '‚ö†';
                    const statusText = portStatus.status === 'hibernated' ? 'HIBERNATED' : portStatus.status.toUpperCase();
                    summary += `${icon} Port ${portDef.port} (${portDef.name}): ${statusText}`;
                    if (portStatus.latency_ms !== null && portStatus.latency_ms !== undefined) {
                        summary += ` - ${portStatus.latency_ms}ms`;
                    }
                    if (portStatus.note) {
                        summary += ` [${portStatus.note}]`;
                    }
                    summary += '\\n';
                }

                summary += '\\n--- HEALTH CHECKS ---\\n';
                const checkNames = {
                    'git_status': 'Git Repository',
                    'disk_space': 'Disk Space',
                    'database_connectivity': 'Databases',
                    'llm_availability': 'LLM (Ollama)',
                    'python_environment': 'Python Env',
                    'config_validity': 'Configurations'
                };

                for (const [key, check] of Object.entries(data.health_checks)) {
                    const icon = check.status === 'ok' ? '‚úì' : check.status === 'warning' ? '‚ö†' : '‚úó';
                    summary += `${icon} ${checkNames[key] || key}: ${check.message}\\n`;
                }

                // Copy to clipboard
                await navigator.clipboard.writeText(summary);
                alert('‚úì System summary copied to clipboard!');
            } catch (error) {
                console.error('Failed to copy summary:', error);
                alert('‚ùå Failed to copy summary: ' + error.message);
            }
        }

        function renderHealthChecks(healthChecks) {
            const container = document.getElementById('health-checks-container');

            const checkOrder = [
                'git_status',
                'disk_space',
                'database_connectivity',
                'llm_availability',
                'python_environment',
                'config_validity'
            ];

            container.innerHTML = checkOrder.map(checkId => {
                const check = healthChecks[checkId] || {
                    status: 'unknown',
                    message: 'Not checked',
                    details: {}
                };

                const statusColors = {
                    'ok': '#10b981',
                    'warning': '#f59e0b',
                    'error': '#ef4444',
                    'unknown': '#6b7280'
                };
                const statusIcons = {
                    'ok': '‚úì',
                    'warning': '‚ö†',
                    'error': '‚úó',
                    'unknown': '?'
                };

                const bgColor = statusColors[check.status] || '#6b7280';
                const icon = statusIcons[check.status] || '?';

                // Check if there are details to show
                const hasDetails = check.details && Object.keys(check.details).length > 0;
                const cursorStyle = hasDetails ? 'cursor: pointer;' : '';
                const hoverStyle = hasDetails ? 'transition: all 0.2s; &:hover { border-color: #64748b; }' : '';

                // Format check details
                let detailsHtml = '';
                if (hasDetails) {
                    detailsHtml = `<div id="details-${checkId}" style="display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #4a5578; font-size: 0.875rem;">`;

                    for (const [key, value] of Object.entries(check.details)) {
                        // Special formatting for 'errors' field (show as list)
                        if (key === 'errors' && typeof value === 'string') {
                            const errorList = value.split(', ').map(err => `<div style="padding: 0.25rem 0; color: #fca5a5;">‚Ä¢ ${err}</div>`).join('');
                            detailsHtml += `<div style="margin-bottom: 0.5rem;"><strong style="color: #e0e0e0;">${key}:</strong>${errorList}</div>`;
                        } else {
                            detailsHtml += `<div style="margin-bottom: 0.25rem;"><strong style="color: #9ca3af;">${key}:</strong> <span style="color: #e0e0e0;">${value}</span></div>`;
                        }
                    }
                    detailsHtml += '</div>';
                }

                return `
                    <div id="check-${checkId}" onclick="toggleHealthCheckDetails('${checkId}')"
                         style="background: #1e293b; border: 1px solid #4a5578; border-left: 4px solid ${bgColor}; border-radius: 6px; padding: 1rem; ${cursorStyle} ${hoverStyle}">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 32px; height: 32px; background: ${bgColor}; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white; font-weight: 700;">
                                ${icon}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #e0e0e0; margin-bottom: 0.25rem;">${getCheckTitle(checkId)}</div>
                                <div style="font-size: 0.875rem; color: #9ca3af;">${check.message}</div>
                            </div>
                            ${hasDetails ? '<div id="chevron-' + checkId + '" style="color: #64748b; font-size: 1.25rem; transition: transform 0.2s;">‚ñº</div>' : ''}
                        </div>
                        ${detailsHtml}
                    </div>
                `;
            }).join('');
        }

        function toggleHealthCheckDetails(checkId) {
            const detailsEl = document.getElementById(`details-${checkId}`);
            const chevronEl = document.getElementById(`chevron-${checkId}`);

            if (!detailsEl) return; // No details to show

            const isExpanded = detailsEl.style.display !== 'none';

            if (isExpanded) {
                detailsEl.style.display = 'none';
                if (chevronEl) chevronEl.style.transform = 'rotate(0deg)';
            } else {
                detailsEl.style.display = 'block';
                if (chevronEl) chevronEl.style.transform = 'rotate(180deg)';
            }
        }

        function getCheckTitle(checkId) {
            const titles = {
                'git_status': 'üîÄ Git Repository Health',
                'disk_space': 'üíæ Disk Space',
                'database_connectivity': 'üóÑÔ∏è Database Connectivity',
                'llm_availability': 'ü§ñ LLM Availability',
                'python_environment': 'üêç Python Environment',
                'config_validity': '‚öôÔ∏è Configuration Validity'
            };
            return titles[checkId] || checkId;
        }

        async function restartAllServices() {
            if (!confirm('Restart all services? This will take ~15 seconds.')) return;

            try {
                const response = await fetch('/api/system/restart', { method: 'POST' });
                const data = await response.json();
                alert(data.status === 'ok' ? '‚úì Services restarting...' : '‚ùå ' + data.error);
            } catch (error) {
                alert('‚ùå Failed to restart services: ' + error.message);
            }
        }

        async function clearCachesAndTemp() {
            if (!confirm('Clear caches and temporary files?')) return;

            try {
                const response = await fetch('/api/system/clear-caches', { method: 'POST' });
                const data = await response.json();
                alert(data.status === 'ok' ? `‚úì Cleared ${data.freed_mb || 0}MB` : '‚ùå ' + data.error);
            } catch (error) {
                alert('‚ùå Failed to clear caches: ' + error.message);
            }
        }

        async function runGitGC() {
            if (!confirm('Run git garbage collection? This may take a minute.')) return;

            try {
                const response = await fetch('/api/system/git-gc', { method: 'POST' });
                const data = await response.json();
                alert(data.status === 'ok' ? `‚úì Git GC complete. Freed ${data.freed_mb || 0}MB` : '‚ùå ' + data.error);
            } catch (error) {
                alert('‚ùå Failed to run git GC: ' + error.message);
            }
        }

        async function exportSystemReport() {
            try {
                const response = await fetch('/api/system/export-report');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `system-report-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('‚ùå Failed to export report: ' + error.message);
            }
        }
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
